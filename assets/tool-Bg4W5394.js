var t=Object.defineProperty,e=(e,i,s)=>((e,i,s)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s)(e,"symbol"!=typeof i?i+"":i,s);import{g as i}from"./toolPaneView-BkZhzbTB.js";import{b as s,T as a,B as n,a as o}from"./textPaneView-LQytaZVw.js";import{ar as l}from"./index-iNH1zFVl.js";import{aX as r,r as h,y as d,z as x,M as c,A as p,bD as _,a$ as u,e as T}from"./index-5gyre0hA.js";import{P as f}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as m}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as w,T as y}from"./axisPaneView-B6qY_qE1.js";import{m as g,i as b,c as D}from"./text-BFLAaZ9z.js";import{m as P}from"./font-DVjjKW8j.js";import{C}from"./composite-CCMtJLBO.js";import{w as W}from"./text-BhorOBkg.js";import"./baseTool-BM5mqL4_.js";import"./ctx-BQtFq0AI.js";class A extends _{constructor(){super(...arguments),e(this,"_textInfoCache",null),e(this,"_hitTest",null)}_calcTextSize(){if(null===this._data||this._data.points.length<2)return null;if(null===this._textInfoCache){const t=this._data.textData.fontSize*this._data.textData.lines.length,e=this._data.textData.maxWidth,i=20;this._textInfoCache={textWidth:e,textHeight:t,totalWidth:e+i,totalHeight:t+i}}return this._textInfoCache}setData(t){null!==this._data&&u(this._data.textData.lines,t.textData.lines)&&this._data.textData.font===t.textData.font&&this._data.textData.maxWidth===t.textData.maxWidth||(this._textInfoCache=null),this._data=t}setHitTestResult(t){this._hitTest=t}hitTest(t){if(null===this._data||this._data.points.length<2)return null;const e=this._data.points[0],i=this._data.points[1];if(e.subtract(t).length()<3)return new d(x.ChangePoint);const s=T(this._calcTextSize()),a=i.x-s.totalWidth/2,n=i.y-s.totalHeight/2;return t.x>=a&&t.x<=a+s.totalWidth&&t.y>=n&&t.y<=n+s.totalHeight?this._hitTest:null}getTextInfo(){const t=T(this._data),e=b()?"right":"left",i=t.points[1].clone(),s=T(this._calcTextSize()),a=s.totalWidth,n=s.totalHeight,o=i.x-a/2,l=i.y-n/2;return{font:t.textData.font,fontSize:t.textData.fontSize,lineSpacing:0,textTop:l+10,textBottom:l+n-10,textLeft:o+10,textRight:o+a-10,textAlign:e}}drawImpl(t){if(null===this._data||this._data.points.length<2)return;const e=this._data.points[0].clone(),i=this._data.points[1].clone(),s=t.context;s.lineCap="round",s.strokeStyle=this._data.borderColor,s.lineWidth=this._data.borderWidth,s.textBaseline="bottom",s.font=this._data.textData.font;const{textWidth:a,textHeight:n,totalWidth:o,totalHeight:l}=T(this._calcTextSize()),r=i.x-o/2,h=i.y-l/2;let d=0;const x=a+4>16,c=n+4>16;s.textAlign=b()?"right":"left";const p=D(s,a);if(e.x>r+o?d=20:e.x>r&&(d=10),e.y>h+l?d+=2:e.y>h&&(d+=1),s.translate(r,h),e.x-=r,e.y-=h,i.x-=r,i.y-=h,s.beginPath(),s.moveTo(8,0),10===d?x?(s.lineTo(i.x-8,0),s.lineTo(e.x,e.y),s.lineTo(i.x+8,0),s.lineTo(o-8,0)):(s.lineTo(e.x,e.y),s.lineTo(o-8,0)):s.lineTo(o-8,0),20===d?(s.lineTo(e.x,e.y),s.lineTo(o,8)):s.arcTo(o,0,o,8,8),21===d?c?(s.lineTo(o,i.y-8),s.lineTo(e.x,e.y),s.lineTo(o,i.y+8),s.lineTo(o,l-8)):(s.lineTo(e.x,e.y),s.lineTo(o,l-8)):s.lineTo(o,l-8),22===d?(s.lineTo(e.x,e.y),s.lineTo(o-8,l)):s.arcTo(o,l,o-8,l,8),12===d?x?(s.lineTo(i.x+8,l),s.lineTo(e.x,e.y),s.lineTo(i.x-8,l),s.lineTo(8,l)):(s.lineTo(e.x,e.y),s.lineTo(8,l)):s.lineTo(8,l),2===d?(s.lineTo(e.x,e.y),s.lineTo(0,l-8)):s.arcTo(0,l,0,l-8,8),1===d?c?(s.lineTo(0,i.y+8),s.lineTo(e.x,e.y),s.lineTo(0,i.y-8),s.lineTo(0,8)):(s.lineTo(e.x,e.y),s.lineTo(0,8)):s.lineTo(0,8),0===d?(s.lineTo(e.x,e.y),s.lineTo(8,0)):s.arcTo(0,0,8,0,8),s.stroke(),s.fillStyle=this._data.backColor,s.fill(),s.translate(-r,-h),!this._data.skipTextDrawing){s.fillStyle=this._data.color;let t=h+8+2+this._data.textData.fontSize;const e=r+8+2+p;for(const i of this._data.textData.lines)s.fillText(i.text,e,t),t+=this._data.textData.fontSize}}}class V extends s{constructor(){super(...arguments),e(this,"_renderer",new C(this._hitTestCollector)),e(this,"_calloutRenderer",new A),e(this,"_textWidthCache",new r),e(this,"_mode",a.Preview)}renderer(){return this._renderer}_updateImpl(){if(this._renderer.clear(),this.points().length<2)return;const t=this._source.properties(),[e,i]=this.points(),s=P(t.fontSize,h,(t.bold?"bold ":"")+(t.italic?"italic ":"")),a=t.wordWrap?t.wordWrapWidth:void 0,n=W(this._textDisplay(),s,this._textWidthCache,!1,a),o=n.filter((t=>!t.hidden));let l;l=void 0!==a?a:o.reduce(((t,e)=>Math.max(t,g(e.text,s,this._textWidthCache).width)),0);const r={points:[e,i],color:this._textDisplayColor(),backColor:t.backgroundColor,textData:{originalText:this._textDisplay(),linesIncludingHidden:n,lines:o,maxWidth:l,font:s,fontSize:t.fontSize},borderColor:t.borderColor,borderWidth:t.borderWidth,skipTextDrawing:this._isTextEditMode()};this._calloutRenderer.setData(r),this._calloutRenderer.setHitTestResult(new d(x.MovePoint,{areaName:c.Text,cursorType:this._textCursorType()})),this._renderer.append(this._calloutRenderer),this._updateEditor(this._calloutRenderer.getTextInfo());const _=this.createLineAnchor({points:[e]},0);if(this._renderer.append(_),void 0!==a){const t=new p({x:i.x+a/2+10,y:i.y},{pointIndex:1}),e=this.createLineAnchor({points:[t]},1);this._renderer.append(e)}}}class j extends n{constructor(){super(...arguments),e(this,"_lines",new V(this,this.model,this.editingHelper)),e(this,"_paneView",[this._lines]),e(this,"_timeAxisViews",[new m(Object.create(null)),new m(Object.create(null))]),e(this,"_priceAxisViews",[new f(Object.create(null)),new f(Object.create(null))]),e(this,"_priceAxisPaneViews",[new w]),e(this,"_timeAxisPaneViews",[new y])}pointsCount(){return 2}updateAllViews(){if(!this.controlPoints.length)return;const t=[],e=[],i=[];for(let s=0;s<this.controlPoints.length;s++){const a=this.controlPoints[s],n=this.pointToScreenPoint(a);if(!n)return;e.push(n.x),i.push(n.y);const o=new p(n,{pointIndex:s,hitTarget:x.ChangePoint});t.push(o),this._timeAxisViews[s].update(this._calculateTimeAxisViewData(a.time,n.x)),this._priceAxisViews[s].update(this._calculatePriceAxisViewData(a.price,n.y))}e.length&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,e),Math.max.apply(null,e))),i.length&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i))),this._lines.update({points:t})}addPoint(t,e){const i=super.addPoint(t,e);return 1!==e||t.isTempForPreview||this.startTextEditing(),i}isCreationFinished(){return this._lines.isCreationFinished()}startTextEditing(){this._lines.startTextEditing()}}class S extends o{constructor(){super(...arguments),e(this,"type",l)}createPrimitive(t){const e=i(t);return new j({id:this.id,points:[],text:"",placeholder:e.t("tool.text.common.addText"),fontSize:14,textColor:"#ffffff",backgroundColor:"#0097A7B2",borderColor:"#0097A7FF",borderWidth:2,wordWrap:!1,wordWrapWidth:100},...this.getTextResetArgs(t))}}export{S as CalloutTool};
