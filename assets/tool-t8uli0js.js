var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{y as i,z as s,e as n,u as o,bU as a,bH as r,w as l,bM as h,v as c,bR as d,bQ as p,bV as _,A as m,r as u,bD as w}from"./index-5gyre0hA.js";import{g}from"./toolPaneView-BkZhzbTB.js";import{T as P,S as x}from"./TrendToolWithStatsPaneView-BX4ipabS.js";import{B as f,a as b}from"./textPaneView-LQytaZVw.js";import{Y as A}from"./index-iNH1zFVl.js";import{P as S}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as j}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as R,T as V}from"./axisPaneView-B6qY_qE1.js";import{V as y,H as T}from"./text-BhorOBkg.js";import{f as M}from"./text-BFLAaZ9z.js";import{L as v}from"./line-BKuOqRrm.js";import{T as D}from"./renderer-CaYvdS1S.js";import"./baseTool-BM5mqL4_.js";import"./ctx-BQtFq0AI.js";import"./font-DVjjKW8j.js";import"./formatter-BMswhHnL.js";import"./numericFormatter-DcPXx81O.js";import"./composite-CCMtJLBO.js";import"./svg-D8gy4lKT.js";class L extends w{drawImpl(e){if(!this._data)return;const t=e.context;t.translate(this._data.point.x,this._data.point.y),t.strokeStyle=this._data.color,t.setLineDash([1,2]);const i=this._data.size;t.beginPath(),t.moveTo(0,0),t.lineTo(i,0),t.arc(0,0,i,0,-this._data.angle,this._data.angle>0),t.stroke()}}class z extends P{constructor(){super(...arguments),t(this,"_trendRenderer",new v(void 0,void 0,new i(s.MovePoint))),t(this,"_angleLabelRenderer",new D(new i(s.MovePoint))),t(this,"_angleRenderer",new L),t(this,"_secondPoint",null)}_getPointsForStats(){return[this.points()[0],n(this._middlePoint),this.points()[1]]}_updateImpl(){this._renderer.clear();const e=this._source,t=e.angle(),i=this.points();if(i.length>0&&null!==t){const s=Math.cos(t),r=-Math.sin(t),l=new o(s,r);this._secondPoint=i[0].addScaled(l,n(e.distance())),this._middlePoint=a(i[0],this._secondPoint)}if(i.length<2||null===this._secondPoint)return;const w=i[0],g=i[1],P=this._source.properties();P.showBarsRange||P.showPriceRange||P.showPercentPriceRange||P.showPipsPriceRange||(this._label=null,this._labelData&&(this._labelData.text=""));const f=P.linecolor,b={points:[w,this._secondPoint],lineColor:f,lineWidth:P.linewidth,lineStyle:P.linestyle,extendLeft:P.extendLeft,extendRight:P.extendRight,leftEnd:r.Normal,rightEnd:r.Normal};this._trendRenderer.setData(b),this._renderer.append(this._trendRenderer);const A=this._source.getScope(),S=l(new o(0,0),new o(A.mediaSize.width,A.mediaSize.height));let j=!1;P.statsPosition===x.Auto&&(j=h(w,g)?!c(w,S):null===d(p(w,g),S)),(this.isHoveredSource()||this.isSelectedSource()||P.alwaysShowStats)&&!j&&2===i.length&&this._renderer.append(this._updateAndReturnStatsRenderer(A));const R=(this.isHoveredSource()||this.isSelectedSource())&&P.showMiddlePoint;this._middlePoint&&this._renderer.append(new _({points:[new m(this._middlePoint,{pointIndex:0})],bgColors:this._lineAnchorColors([this._middlePoint]),color:f,visible:R&&this.areAnchorsVisible(),hitTarget:s.Regular}));const V={point:w,angle:e.angle()??0,color:f,size:50};this._angleRenderer.setData(V),this._renderer.append(this._angleRenderer);const v=180*V.angle/Math.PI,D=Math.round(100*v)/100+"ยบ",L={points:[new o(w.x+50,w.y)],text:M(D),color:f,horzAlign:T.Left,fontFamily:u,offsetX:5,offsetY:0,bold:P.bold,italic:P.italic,fontSize:P.fontSize,vertAlign:y.Middle};this._angleLabelRenderer.setData(L),this._renderer.append(this._angleLabelRenderer),this._renderer.append(this.createLineAnchor({points:[new m(w,{pointIndex:0}),new m(this._secondPoint,{pointIndex:1})]},0))}}class F extends f{constructor(){super(...arguments),t(this,"_line",new z(this,this.model,this.editingHelper)),t(this,"_priceAxisPaneViews",[new R(Object.create(null))]),t(this,"_timeAxisPaneViews",[new V(Object.create(null))]),t(this,"_timeAxisViews",[new j(Object.create(null)),new j(Object.create(null))]),t(this,"_priceAxisViews",[new S(Object.create(null)),new S(Object.create(null))]),t(this,"_paneView",[this._line]),t(this,"_angle",null),t(this,"_distance",0)}pointsCount(){return 2}angle(){return this._angle}distance(){return this._distance}addPoint(e,t){const i=super.addPoint(e,t);return t>0&&this._calculateAngle(),i}setPoint(e,t,i){super.setPoint(e,t,i),1==e&&this._calculateAngle()}_calculateAngle(){const e=n(this.pointToScreenPoint(this.controlPoints[0]));let t=n(this.pointToScreenPoint(this.controlPoints[1])).subtract(e);const i=t.length();i>0?(t=t.normalized(),this._angle=Math.acos(t.x),t.y>0&&(this._angle=-this._angle),this._distance=i):this._angle=0}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let s=0;s<this.controlPoints.length;s++){const t=this.controlPoints[s],i=this.pointToScreenPoint(t);if(!i)return;e.push(new m(i,{pointIndex:s}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i))),this._paneView[0].update({points:e})}isCreationFinished(){return this._line.isCreationFinished()}startTextEditing(){return this._line.startTextEditing()}}class C extends b{constructor(){super(...arguments),t(this,"type",A)}createPrimitive(e){const t=g(e);return new F({id:this.id,points:[],linecolor:"#2962FF",linewidth:2,linestyle:0,extendLeft:!1,extendRight:!1,textColor:"#2962FF",fontSize:14,text:"",placeholder:"",wordWrap:!0,bold:!1,italic:!1,alwaysShowStats:!1,showMiddlePoint:!1,showPriceLabels:!1,showPriceRange:!1,showPercentPriceRange:!1,showPipsPriceRange:!1,showBarsRange:!1,showAngle:!1,statsPosition:x.Right,formatBarCount:e=>t.t("tool.line.common.bars",e)},...this.getTextResetArgs(e))}finishDrawing(){n(this._drawingSession).finishDrawing()}}export{C as TrendAngleTool};
