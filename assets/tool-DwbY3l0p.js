var t=Object.defineProperty,e=(e,s,i)=>((e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i)(e,"symbol"!=typeof s?s+"":s,i);import{T as s,a as i,D as n}from"./toolPaneView-BkZhzbTB.js";import{ah as o}from"./index-iNH1zFVl.js";import{c8 as a,u as r,A as l,bD as c,y as h,z as d,bK as p,e as u}from"./index-5gyre0hA.js";import{a as P,t as m,r as x,s as w}from"./transform-CddyjF1Y.js";import{P as y}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as _}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as b,T as g}from"./axisPaneView-B6qY_qE1.js";import{t as T}from"./handle-C11jaV9I.js";import{C as f}from"./composite-CCMtJLBO.js";import"./baseTool-BM5mqL4_.js";class M extends c{drawImpl(t){const e=this._data;if(!e||e.points.length<2)return;const s=t.context,i=e.points[0],n=e.points[1];if(e.points.length<3)return s.strokeStyle=e.lineColor,s.lineWidth=e.lineWidth,s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(n.x,n.y),void s.stroke();let o=e.points[2];const{distance:l}=a(i,n,o);if(l<1)return s.strokeStyle=e.lineColor,s.lineWidth=e.lineWidth,s.beginPath(),s.moveTo(i.x,i.y),s.lineTo(n.x,n.y),void s.stroke();const c=n.subtract(i),h=i.add(n).scaled(.5),d=new r(-c.y,c.x).normalized();o=h.add(d.scaled(l)),s.strokeStyle=e.lineColor,s.lineWidth=e.lineWidth;const p=c.length(),u=c.x/p,y=c.y/p;let _=Math.acos(u);y<0&&(_=-_);let b=e.points[2],g=P(-h.x,-h.y);b=m(g,b),g=x(-_),b=m(g,b),g=w(1,p/(2*l)),b=m(g,b);const T=b.y<0;s.save(),s.beginPath(),s.translate(i.x,i.y),s.rotate(_);const f=p,M=l/(p*(1-Math.sqrt(3)/2));if(s.scale(1,M),T){const t=-2*Math.PI/3,e=-Math.PI/3;s.arc(.5*p,p*Math.sqrt(3)/2,f,t,e,!1)}else{const t=Math.PI/3,e=2*Math.PI/3;s.arc(.5*p,-p*Math.sqrt(3)/2,f,t,e,!1)}s.restore(),s.stroke(),s.fillStyle=e.background,s.fill()}hitTest(t){if(!this._data||this._data.points.length<3)return null;const e=p().curve,s=this._data.points[0],i=this._data.points[1];let n=this._data.points[2];const o=a(s,i,n).distance;if(o<1){return a(s,i,t).distance<e?new h(d.MovePoint):null}const l=i.subtract(s),c=l.length(),u=s.add(i).scaled(.5);let y=n.subtract(u).normalized();n=u.add(y.scaled(o));const _=l.x/c,b=l.y/c;let g=Math.acos(_);b<0&&(g=-g);let T=P(-s.x,-s.y);t=m(T,t),y=m(T,y),T=x(-g),t=m(T,t),y=m(T,y);const f=c*(1-Math.sqrt(3)/2)/o;if(T=w(1,f),t=m(T,t),y=m(T,y),t.y*y.y<0)return null;let M;M=t.y<0?new r(.5*c,c*Math.sqrt(3)/2):new r(.5*c,-c*Math.sqrt(3)/2);const j=t.subtract(M).length();return Math.abs(j-c)<=e?new h(d.MovePoint):null}}class j extends s{constructor(){super(...arguments),e(this,"_renderer",new f(this._hitTestCollector)),e(this,"_arcRenderer",new M)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const t=this._source.properties();if(this._arcRenderer.setData({points:this.points(),lineColor:t.lineColor,lineWidth:t.lineWidth,background:t.backgroundColor}),this._renderer.append(this._arcRenderer),this.points().length<=2)return void this.addAnchors(this._renderer);const[e,s,i]=this.points(),n=[e,s],{distance:o}=a(e,s,i),c=s.subtract(e),h=e.add(s).scaled(.5),d=new r(-c.y,c.x).normalized(),p=h.add(d.scaled(o)),u=h.add(d.scaled(-o)),y=c.length(),_=c.x/y,b=c.y/y;let g=Math.acos(_);b<0&&(g=-g);let f=i,M=P(-h.x,-h.y);f=m(M,f),M=x(-g),f=m(M,f),M=w(1,y/(2*o)),f=m(M,f);const j=f.y>=0?p:u,A=new l(j,{pointIndex:2,cursorType:T(e,s)});n.push(A);const V=this.createLineAnchor({points:n});this._renderer.append(V)}}class A extends i{constructor(){super(...arguments),e(this,"_lines",new j(this,this.model)),e(this,"_paneView",[this._lines]),e(this,"_priceAxisPaneViews",[new b(Object.create(null))]),e(this,"_timeAxisPaneViews",[new g(Object.create(null))]),e(this,"_timeAxisViews",[new _(Object.create(null)),new _(Object.create(null)),new _(Object.create(null))]),e(this,"_priceAxisViews",[new y(Object.create(null)),new y(Object.create(null)),new y(Object.create(null))]),e(this,"_dist",null)}pointsCount(){return 3}startChanging(){const[t,e,s]=this.controlPoints,i=u(this.pointToScreenPoint(t)),n=u(this.pointToScreenPoint(e)),o=u(this.pointToScreenPoint(s)),l=a(i,n,o).distance,c=n.subtract(i),h=new r(-c.y,c.x),d=i.add(n).scaled(.5),p=o.subtract(d).dotProduct(h)<0;this._dist=p?-l:l}onDragEnd(){super.onDragEnd(),this._dist=null}setPoint(t,e,s){const i=u(this.pointToScreenPoint(this.controlPoints[0])),n=u(this.pointToScreenPoint(this.controlPoints[1])),o=u(this._dist);switch(t){case 0:{const t={time:u(s.startPoint).time+s.deltaTime,price:u(s.startPoint).price+s.deltaPrice},e=u(this.pointToScreenPoint(t)),i=n.subtract(e),a=e.add(n).scaled(.5),l=new r(-i.y,i.x).normalized(),c=a.add(l.scaled(o));this.controlPoints[0]=t,this.controlPoints[2]=this.screenPointToPoint(c);break}case 1:{const t={time:u(s.startPoint).time+s.deltaTime,price:u(s.startPoint).price+s.deltaPrice},e=u(this.pointToScreenPoint(t)),n=e.subtract(i),a=i.add(e).scaled(.5),l=new r(-n.y,n.x).normalized(),c=a.add(l.scaled(o));this.controlPoints[1]=t,this.controlPoints[2]=this.screenPointToPoint(c);break}case 2:{let t=new r(s.screenPoint);const e=n.subtract(i),o=i.add(n).scaled(.5),{distance:l}=a(i,n,t),c=new r(-e.y,e.x).normalized(),h=o.add(c.scaled(l)),d=o.add(c.scaled(-l)),p=e.length(),u=e.x/p,y=e.y/p;let _=Math.acos(u);y<0&&(_=-_);let b=P(-o.x,-o.y);t=m(b,t);let g=m(b,h);b=x(-_),t=m(b,t),g=m(b,g),b=w(1,p/(2*l)),t=m(b,t),g=m(b,g);const T=t.y*g.y>=0?h:d;this.controlPoints[2]=this.screenPointToPoint(T);break}}}updateAllViews(){if(!this.controlPoints.length)return;const t=[],e=[],s=[];for(let i=0;i<this.controlPoints.length;i++){const n=this.controlPoints[i],o=this.pointToScreenPoint(n);if(!o)return;t.push(o.x),e.push(o.y);const a=new l(o,{pointIndex:i,hitTarget:d.ChangePoint});s.push(a),this._timeAxisViews[i].update(this._calculateTimeAxisViewData(n.time,o.x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(n.price,o.y))}t.length&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),e.length&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,e),Math.max.apply(null,e))),this._lines.update({points:s})}}class V extends n{constructor(){super(...arguments),e(this,"type",o)}createPrimitive(){return new A({id:this.id,points:[],lineColor:"#E91E63FF",lineWidth:2,backgroundColor:"#E91E6333"},...this.resetArgs)}}export{V as ArcTool};
