var t=Object.defineProperty,e=(e,i,o)=>((e,i,o)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o)(e,"symbol"!=typeof i?i+"":i,o);import{a1 as i,Q as o,U as a,b5 as s,bY as r,al as n,av as l,W as d,bZ as c,X as h,Z as x,ad as u,ae as _,bf as p,a5 as b,by as v,$ as f,a0 as g,a2 as m,b_ as E,f as w,au as C,p as k,R as A,e as M,ai as T,M as y,b$ as S,G as $}from"./index-5gyre0hA.js";import{D as H,a as P,T as R}from"./toolPaneView-BkZhzbTB.js";const z=new Map([["10b_2",.15],["10bi_2",.15],["12_3",.8],["12b_2",.5],["12bi_2",.45],["14b_2",.65],["14bi_2",.65],["16_2.5",.8],["16b_2",.8],["16bi_2",.75],["16b_2.5",.8],["16bi_2.5",.75],["16bi_3",.65],["20_2",1],["20b_2",.8],["20bi_2",.75],["20bi_3",.55],["20_2.5",.25],["20_3",.8],["24_2.5",.95],["24_3",.95],["28_2",1.4],["28_2.5",1.38],["28_3",1.38],["32_2",1.6],["32_2.5",1.6],["32_3",1.6]]),W=(t,e,i,o)=>{const a=new E(t);(a.keyCode===w.Esc||a.keyCode===w.Enter&&!i.multiLine)&&o()};var L=d('<textarea class="textArea svelte-s85b3a" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>');const D={hash:"svelte-s85b3a",code:".textArea.svelte-s85b3a {appearance:textfield;background-color:initial;border:0;box-sizing:border-box;display:block;height:100%;margin:0;outline:0;overflow:hidden;padding:2px;position:absolute;width:100%;-webkit-text-fill-color:currentColor;font-family:inherit;font-size:inherit;line-height:inherit;pointer-events:all;z-index:2;resize:none;}.textArea.svelte-s85b3a::placeholder {color:currentColor;opacity:0.5;}.textArea.svelte-s85b3a::-webkit-calendar-picker-indicator,\n.textArea.svelte-s85b3a::-webkit-clear-button,\n.textArea.svelte-s85b3a::-webkit-inner-spin-button,\n.textArea.svelte-s85b3a::-webkit-outer-spin-button,\n.textArea.svelte-s85b3a::-webkit-search-cancel-button {-webkit-appearance:none;appearance:none;}.textArea.svelte-s85b3a:-webkit-autofill,\n.textArea.svelte-s85b3a:-webkit-autofill:active,\n.textArea.svelte-s85b3a:-webkit-autofill:focus {border-radius:6px;}\n\n@media (any-hover: hover) {.textArea.svelte-s85b3a:-webkit-autofill:hover {border-radius:6px;}\n}"};function F(t,e){i(e,!0),o(t,D);let d=c(e,["$$slots","$$events","$$legacy","text","textColor"]);const E=a(s),w=_((()=>{const{font:t,fontSize:i,textLeft:o,textTop:a,textBottom:s,textRight:r,textAlign:n,centerRotation:l,lineSpacing:d}=e.textInfo,c=Math.ceil(r-o)+1,h=Math.ceil(s-a);let x,u,_=0;l&&0!==l.angle?(u=l.x-c/2,x=l.y-h/2,_=l.angle):(x=Math.round(a)+.5,u=Math.round(o)+.5);const p=devicePixelRatio<=2||devicePixelRatio>=3?devicePixelRatio:devicePixelRatio<2.5?2:2.5,b=`${i}${t.includes("bold")?"b":""}${t.includes("italic")?"i":""}_${p}`,v=z.get(b);return{width:m(c+4),height:m(h+4),top:m(x-2+e.offsetTop),left:m(u-2+e.offsetLeft),font:t,textColor:e.textColor,fontSize:m(i),lineHeight:m(i+d),textAlign:n,letterSpacing:e.multiLine&&void 0!==v?m(v):"normal",rotate:_?`${_}rad`:void 0}}));let C=!1;const k=()=>{C||(C=!0,e.onExit(),M&&M instanceof HTMLElement&&M.focus())};let A,M=null;r((()=>{M=E.root.activeElement,A.focus(),A.value=e.text,n.write(A,l.Textarea)}));var T=L();let y;T.__input=()=>{e.onInput(A.value)},T.__keydown=[W,d,e,k],h(T,(t=>A=t),(()=>A)),x((t=>{p(T,"placeholder",e.placeholder),y=b(T,"",y,t)}),[()=>({width:u(w).width,height:u(w).height,top:u(w).top,left:u(w).left,font:u(w).font,"font-size":u(w).fontSize,"line-height":u(w).lineHeight,"text-align":u(w).textAlign,"letter-spacing":u(w).letterSpacing,rotate:u(w).rotate,color:u(w).textColor})]),v("blur",T,(()=>{E.root.activeElement!==A&&k()})),f(t,T),g()}C(["input","keydown"]);class I extends H{getTextResetArgs(t){const e=super.resetArgs,i=t;return[...e,{showTextEditor:t=>{var e;const o=M(null==(e=i.chartService.getPane(i.paneIndex))?void 0:e.getHTMLElement()).getBoundingClientRect(),a=i.chartService.getContainerDomElement().getBoundingClientRect();return i.chartService.invokeWithinContext((e=>e.get(T).showComponent({Component:F,props:{...t,offsetTop:o.top-a.top,offsetLeft:o.left-a.left}})))},accept:()=>{i.chartService.getModel().markCreatingFinishedOrAborted(this.primitive),i.chartService.getModel().blur(this.primitive)},abort:()=>{i.chartService.invokeWithinContext((t=>t.get(k).executeCommand(A)))}}]}finishDrawing(){}}class V extends P{constructor(t,e,i,o,a,s,r){super(t,e,i,o,a,s),this.editingHelper=r}asTextToolPrimitive(){return this}}var B=(t=>(t[t.Preview=0]="Preview",t[t.Edit=1]="Edit",t))(B||{});class j extends R{constructor(t,i,o){super(t,i),e(this,"_creatingFinished",!1),e(this,"_mode",1),e(this,"_textWasEdited",!1),e(this,"_textEditor",null),this._editingHelper=o}isCreationFinished(){return this._creatingFinished}startTextEditing(){this._mode=1,this._textWasEdited=!1}_isTextEditMode(){return 1===this._mode}_placeHolderMode(t=!1){var e;const i=!this._isTextEditMode(),o=this._model.currentHovered===this._source,a=!t||(null==(e=this._model.lastHittestData())?void 0:e.areaName)!==y.AnchorPoint,s=!this._textValue(),r=this._model.isSelected(this._source);return i&&o&&a&&s&&r}_textValue(){return this._source.properties().text}_textDisplay(){const{text:t,placeholder:e}=this._source.properties();return t||(this._textWasEdited?"â€‹":e)}_textDisplayColor(){const t=this._textColor();return this._textValue()?t:S(t,.5)}_textColor(){return this._source.properties().textColor}_textCursorType(){return this.isSelectedSource()?$.text:$.unset}_updateEditor(t){var e;!this._textEditor&&this._isTextEditMode()?this._activateEditMode(t):null==(e=this._textEditor)||e.update({textInfo:t})}_activateEditMode(t){if(this._textEditor)return;const{textColor:e,text:i,placeholder:o,wordWrap:a}=this._source.properties();this._textEditor=this._editingHelper.showTextEditor({text:i,placeholder:o,textColor:e,multiLine:a,textInfo:t,onExit:()=>{this._deactiveEditMode(),this._textValue()?this._editingHelper.accept():this._editingHelper.abort()},onInput:t=>{this._source.updateProps({text:t})}})}_deactiveEditMode(){this._creatingFinished||(this._creatingFinished=!0),M(this._textEditor).dispose(),this._mode=0,this._textWasEdited=!0,this._textEditor=null}closeTextEditor(){this._deactiveEditMode()}}export{V as B,B as T,I as a,j as b};
