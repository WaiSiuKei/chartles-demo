var e=Object.defineProperty,t=(t,i,l)=>((t,i,l)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[i]=l)(t,"symbol"!=typeof i?i+"":i,l);import{g as i,V as l,H as s}from"./text-BhorOBkg.js";import{bH as n,e as r,bG as o,A as a,L as c}from"./index-5gyre0hA.js";import{a as h,D as d}from"./toolPaneView-BkZhzbTB.js";import{r as f}from"./index-iNH1zFVl.js";import{P as p}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as u}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as v,T as m}from"./axisPaneView-B6qY_qE1.js";import{C as b}from"./composite-CCMtJLBO.js";import{L as x}from"./line-BKuOqRrm.js";import{P as g}from"./parallelChannel-DC2OIzzc.js";import{F as _}from"./paneView-MhvZ7TYs.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./baseTool-BM5mqL4_.js";import"./line-Jebc4sVj.js";import"./formatter-BMswhHnL.js";import"./numericFormatter-DcPXx81O.js";class P extends g{_drawLine(e,t,i){var l;const{context:s,bitmapSize:n}=e,r=null==(l=this._data)?void 0:l.excludeBoundaries;if(void 0!==r){s.save(),s.beginPath(),s.rect(0,0,n.width,n.height);for(let t=0;t<r.length;t++){const{x:i,y:l}=r[t],n=i*e.horizontalPixelRatio,o=l*e.verticalPixelRatio;0===t?s.moveTo(n,o):s.lineTo(n,o)}s.closePath(),s.clip("evenodd")}super._drawLine(e,t,i),void 0!==r&&s.restore()}}class w extends _{constructor(){super(...arguments),t(this,"_baseLineRenderer",new x),t(this,"_lastLevelTrendRenderer",new x),t(this,"_renderer",new b(this._hitTestCollector))}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if(e.length<2)return void this.addAnchors(this._renderer);const t=this._source.properties(),l=e[0],s=e[1];if(e.length<3){const e={points:[l,s],lineColor:t.levels[0].color,lineWidth:t.levelsStyle.linewidth,lineStyle:t.levelsStyle.linestyle,extendLeft:t.extendLeft,extendRight:t.extendRight,leftEnd:n.Normal,rightEnd:n.Normal};return this._baseLineRenderer.setData(e),this._renderer.append(this._baseLineRenderer),void this.addAnchors(this._renderer)}const{width:a,height:c}=this._source.getScope().mediaSize;for(let n=0;n<t.levels.length;n++){const e=t.levels[n];if(!e.visible)continue;let l=null;for(let i=n+1;i<t.levels.length;i++){const e=t.levels[i];if(e.visible){l=e;break}}if(!l)break;const s=e.color,h=t.extendLeft,d=t.extendRight,f=t.levelsStyle.linestyle,p=t.levelsStyle.linewidth,u=this._data.levels[n],v=this._updateLabelForLevel({levelIndex:n,coeff:e.coeff,leftPoint:u.leftPoint1,rightPoint:r(u.rightPoint2),price:u.price,color:s,horzAlign:t.horzLabelsAlign,vertAlign:t.vertLabelsAlign});let m;null!==v&&(this._renderer.append(v),m=i(v,a,c)??void 0);const b={line1:{color:s,lineStyle:f,lineWidth:p,points:[u.leftPoint1,u.rightPoint1]},line2:{color:s,lineStyle:f,lineWidth:p,points:[r(u.leftPoint2),r(u.rightPoint2)]},extendLeft:h,extendRight:d,backColor:o(s,t.transparency,!0),skipTopLine:!0,fillBackground:t.fillBackground,hittestOnBackground:!0,excludeBoundaries:m},x=new P;x.setData(b),this._renderer.append(x)}let h=null;for(let i=t.levels.length-1;i>=0;i--){if(t.levels[i].visible){h=i;break}}if(null!==h){const e=t.levels[h];if(e.visible){const l=this._data.levels[h],s=this._updateLabelForLevel({levelIndex:h,coeff:e.coeff,leftPoint:l.leftPoint1,rightPoint:l.rightPoint1,price:l.price,color:e.color,horzAlign:t.horzLabelsAlign,vertAlign:t.vertLabelsAlign});let r;null!==s&&(this._renderer.append(s),r=i(s,a,c)??void 0);const o={points:[l.leftPoint1,l.rightPoint1],lineColor:e.color,lineWidth:t.levelsStyle.linewidth,lineStyle:t.levelsStyle.linestyle,extendLeft:t.extendLeft,extendRight:t.extendRight,leftEnd:n.Normal,rightEnd:n.Normal,excludeBoundaries:r?[r]:void 0};this._lastLevelTrendRenderer.setData(o),this._renderer.append(this._lastLevelTrendRenderer)}}this.addAnchors(this._renderer)}}class A extends h{constructor(){super(...arguments),t(this,"_lines",new w(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new v(Object.create(null))]),t(this,"_timeAxisPaneViews",[new m(Object.create(null))]),t(this,"_timeAxisViews",[new u(Object.create(null)),new u(Object.create(null)),new u(Object.create(null))]),t(this,"_priceAxisViews",[new p(Object.create(null)),new p(Object.create(null)),new p(Object.create(null))])}pointsCount(){return 3}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let r=0;r<this.controlPoints.length;r++){const t=this.controlPoints[r],i=this.pointToScreenPoint(t);if(!i)return;e.push(new a(i,{pointIndex:r}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));const l=e.length>2?e[2].subtract(e[0]):null,s=e[0],n=e[1],o=this._props.levels.reduce(((e,t,i)=>{if(!t.visible)return e;if(!l)return e;const o=l.scaled(t.coeff),a=s.add(o),c=n.add(o);let h=null,d=null,f=null;for(let l=i+1;l<this._props.levels.length;l++){const e=this._props.levels[l];if(e.visible){f=e;break}}if(f){const e=l.scaled(f.coeff);h=s.add(e),d=n.add(e)}const p=r(this.series.coordinateToPrice(a.y));return e.push({leftPoint1:a,rightPoint1:c,leftPoint2:h,rightPoint2:d,price:this.series.priceFormatter().format(p)}),e}),[]);this._lines.update({points:e,levels:o})}}class L extends d{constructor(){super(...arguments),t(this,"type",f)}createPrimitive(){return new A({id:this.id,points:[],showCoeffs:!0,showPrices:!0,fillBackground:!0,transparency:80,extendLeft:!1,extendRight:!1,horzLabelsAlign:s.Left,vertLabelsAlign:l.Middle,coeffsAsPercents:!1,labelFontSize:12,levelsStyle:{linewidth:2,linestyle:c.solid},levels:[{visible:!0,coeff:0,color:"#808080"},{visible:!0,coeff:.236,color:"#F23645"},{visible:!0,coeff:.382,color:"#FF9800"},{visible:!0,coeff:.5,color:"#4CAF50"},{visible:!0,coeff:.618,color:"#089981"},{visible:!0,coeff:.786,color:"#00BCD4"},{visible:!0,coeff:1,color:"#808080"},{visible:!0,coeff:1.618,color:"#2962FF"},{visible:!0,coeff:2.618,color:"#F23645"},{visible:!0,coeff:3.618,color:"#9C27B0"},{visible:!0,coeff:4.236,color:"#E91E63"}]},...this.resetArgs)}}export{L as FibChannelTool};
