var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{g as i}from"./toolPaneView-BkZhzbTB.js";import{b as s,T as r,B as o,a}from"./textPaneView-LQytaZVw.js";import{aw as n}from"./index-iNH1zFVl.js";import{A as l,u as h,r as d,y as p,z as c,M as m,b0 as u,B as _,bL as x,bK as b,J as w,bF as T,G as f,cv as g,e as R}from"./index-5gyre0hA.js";import{T as P}from"./timeLabelTimeAxisView-DLVMuesT.js";import{H as y,V as j}from"./text-BhorOBkg.js";import{C as v}from"./composite-CCMtJLBO.js";import{T as A}from"./renderer-CaYvdS1S.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";class C extends _{hitTest(e){if(null===this._data)return null;const[t,i]=this._hitTestLineOrEmoji(this._data,e);return t||i?new p(c.MovePoint):null}_hitTestLineOrEmoji(e,t){const i=b().line,{x:s,poleTopY:r,poleBottomY:o,plate:a}=e,n=new h(s,r),l=new h(s,o),d=x(n,l,t).distance<i;return d||void 0===a||u(),[d,!1]}drawImpl(e){if(!this._data)return;const t=e.context,{poleColor:i,plate:s}=this._data,{horizontalPixelRatio:r,verticalPixelRatio:o}=e;t.save();const a=Math.max(1,Math.floor(r)),n=a%2?.5:0;t.beginPath(),t.strokeStyle=i,t.lineWidth=a;const l=Math.round(this._data.x*r)+n,h=Math.round(this._data.poleTopY*o),d=Math.round(this._data.poleBottomY*o);t.moveTo(l,h),t.lineTo(l,d),s&&u(),t.stroke(),s&&u(),t.restore()}}class M extends s{constructor(){super(...arguments),t(this,"_renderer",new v(this._hitTestCollector)),t(this,"_labelRenderer",new A),t(this,"_signpostRenderer",new C),t(this,"_mode",r.Preview)}renderer(){return this._renderer}_updateImpl(){if(this._renderer.clear(),!this._data)return;if(!this.points().length)return;const e=this._updateLabelTextRenderer(this._source.getScope());this._updateTimelineRenderer(e),this._renderer.append(this._signpostRenderer),this._renderer.append(this._labelRenderer);const t=this.points()[0],i=new l(e.point,t);this._renderer.append(this.createLineAnchor({points:[i]},0))}_updateLabelTextRenderer(e){const t=this._source.properties(),{height:i,width:s}=e.mediaSize,r=this.points()[0];let o,a,n;this._data.startsOnSeriesData?r.y>this._data.barLow?(o=!0,n=Math.max(r.y,this._data.barLow),a=-1):(o=!1,n=Math.min(r.y,this._data.barHigh),a=1):(o=!1,n=r.y,a=r.y>i/2?-1:1),n>=-1e-10&&n<=i+1e-10&&(n=Math.min(i-2,Math.max(2,n)));const l={text:this._textDisplay(),fontSize:t.fontSize,bold:t.bold,italic:t.italic,offsetX:0,offsetY:0,points:[new h(r.x,n)],forceCalculateMaxLineWidth:!0,vertAlign:-1===a?j.Bottom:j.Top,horzAlign:y.Center,fontFamily:d,backgroundRoundRect:4,boxPaddingVert:6,boxPaddingHorz:8,wordWrapWidth:134,color:this._textDisplayColor(),borderColor:"#EBEBEB",borderWidth:1,backgroundColor:"#ffffff",skipTextDrawing:this._isTextEditMode()};this._labelRenderer.setData(l);const u=this._labelRenderer.measure().height;let _,x,b=n;this._data.startsOnSeriesData?o?(_=this._data.barLow+3,b=Math.max(_+u,n),x=b-u):(x=this._data.barHigh-3,b=Math.min(x-u,n),_=b+u):(x=i,_=-1===a?n:n+u);let w=r;return b!==n&&(w=new h(r.x,b),this._labelRenderer.setData({...l,points:[w]})),this._labelRenderer.setHitTestResult(new p(c.MovePoint,{areaName:m.Text,cursorType:this._textCursorType()})),this._labelRenderer.isOutOfScreen(s,i)?this._deactiveEditMode():this._updateEditor(this._labelRenderer.getTextInfo()),{point:w,shapeUpsideDown:o,poleTopY:_,poleBottomY:x,labelDirection:a}}_updateTimelineRenderer(e){const t=this._source.properties(),i={emojiRadius:16,poleColor:"#1A1A1AFF",svgRenderer:void 0,poleTopY:e.poleTopY,poleBottomY:e.poleBottomY,x:e.point.x};t.showImage&&u(),this._signpostRenderer.setData(i)}}class D extends o{constructor(){super(...arguments),t(this,"_lines",new M(this,this.model,this.editingHelper)),t(this,"_paneView",[this._lines]),t(this,"_timeAxisViews",[new P(Object.create(null))])}pointsCount(){return 1}updateAllViews(){if(!this.controlPoints.length)return;const e=[],t=this.controlPoints[0];if(!isFinite(t.time)||!isFinite(t.price))return this._lines.update({points:[],startsOnSeriesData:!0,barHigh:NaN,barLow:NaN}),void this._timeAxisViews[0].update(Object.create(null));const i=this.pointToScreenPoint(t);if(!i)return;const s=new l(i,{pointIndex:0,hitTarget:c.ChangePoint,cursorType:f.ns,style:T.square,resizeDirections:w});e.push(s),this._timeAxisViews[0].update(this._calculateTimeAxisViewData(t.time,i.x));const r=this.chart.timeScale().timeToIndex(t.time);let o=NaN,a=NaN;if(null!==r){const e=this.series.dataByIndex(r);e&&g(e)&&(o=R(this.series.priceToCoordinate(e.customValues.high)),a=R(this.series.priceToCoordinate(e.customValues.low)))}this._lines.update({points:e,startsOnSeriesData:isFinite(o)&&isFinite(a)&&null!==r,barHigh:o,barLow:a})}addPoint(e,t){const i=super.addPoint(e,t);return e.isTempForPreview||this.startTextEditing(),i}isCreationFinished(){return this._lines.isCreationFinished()}startTextEditing(){this._lines.startTextEditing()}}class B extends a{constructor(){super(...arguments),t(this,"type",n),t(this,"previewBeforePlace",!0)}createPrimitive(e){const t=i(e);return new D({id:this.id,points:[],text:"",placeholder:t.t("tool.text.common.addText"),fontSize:12,textColor:"#1A1A1AFF",wordWrap:!1,emoji:"",showImage:!1,position:50},...this.getTextResetArgs(e))}}export{B as SignpostTool};
