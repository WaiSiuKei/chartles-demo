var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{L as i,r,bH as n,A as s,b$ as a}from"./index-5gyre0hA.js";import{T as o,a as l,D as c}from"./toolPaneView-BkZhzbTB.js";import{a0 as d}from"./index-iNH1zFVl.js";import{P as h}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as p}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as m,T as _}from"./axisPaneView-B6qY_qE1.js";import{B as b,H as u,V as f}from"./text-BhorOBkg.js";import{b as x}from"./formatter-BMswhHnL.js";import{C as w}from"./composite-CCMtJLBO.js";import{L as R}from"./line-BKuOqRrm.js";import{P as A}from"./polygon-D49cV0Ps.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./numericFormatter-DcPXx81O.js";class g extends o{constructor(){super(...arguments),t(this,"_renderer",new w(this._hitTestCollector)),t(this,"_abRetracementTrend",new R),t(this,"_cdRetracementTrend",new R),t(this,"_polylineRenderer",new A),t(this,"_abLabelRenderer",new b),t(this,"_cdLabelRenderer",new b),t(this,"_textRendererALabel",new b),t(this,"_textRendererBLabel",new b),t(this,"_textRendererCLabel",new b),t(this,"_textRendererDLabel",new b)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if((null==e?void 0:e.length)<2)return;const t=this._source.properties(),s=(e,i)=>({points:[e],text:i,color:t.textColor,vertAlign:f.Middle,horzAlign:u.Center,fontFamily:r,offsetX:0,offsetY:0,fontSize:t.textFontSize,backgroundColor:t.color,backgroundRoundRect:4}),a=(e,r)=>({points:[e,r],lineColor:t.color,lineWidth:t.lineWidth,lineStyle:i.dotted,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal}),[o,l,c,d]=e,h={points:this.points(),lineColor:t.color,lineWidth:t.lineWidth,lineStyle:i.solid,filled:!1,background:"rgba(0, 0, 0, 0)"};this._polylineRenderer.setData(h),this._renderer.append(this._polylineRenderer);const p=s(o,"A");p.vertAlign=l.y>o.y?f.Bottom:f.Top,p.offsetY=5,this._textRendererALabel.setData(p),this._renderer.append(this._textRendererALabel);const m=s(l,"B");if(m.vertAlign=l.y<o.y?f.Bottom:f.Top,m.offsetY=5,this._textRendererBLabel.setData(m),this._renderer.append(this._textRendererBLabel),e.length>2){const e=s(c,"C");e.vertAlign=c.y<l.y?f.Bottom:f.Top,e.offsetY=5,this._textRendererCLabel.setData(e),this._renderer.append(this._textRendererCLabel)}if(e.length>3){const e=s(d,"D");e.vertAlign=d.y<c.y?f.Bottom:f.Top,e.offsetY=5,this._textRendererDLabel.setData(e),this._renderer.append(this._textRendererDLabel)}const _=x(3);if(e.length>=3){this._abRetracementTrend.setData(a(o,c)),this._renderer.append(this._abRetracementTrend);const e=s(o.add(c).scaled(.5),_.format(this._data.abRatio));this._abLabelRenderer.setData(e),this._renderer.append(this._abLabelRenderer)}if(e.length>=4){this._cdRetracementTrend.setData(a(l,d)),this._renderer.append(this._cdRetracementTrend);const e=s(l.add(d).scaled(.5),_.format(this._data.cdRatio));this._cdLabelRenderer.setData(e),this._renderer.append(this._cdLabelRenderer)}this.addAnchors(this._renderer)}}class j extends l{constructor(){super(...arguments),t(this,"_lines",new g(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new m(Object.create(null))]),t(this,"_timeAxisPaneViews",[new _(Object.create(null))]),t(this,"_timeAxisViews",[new p(Object.create(null)),new p(Object.create(null)),new p(Object.create(null)),new p(Object.create(null))]),t(this,"_priceAxisViews",[new h(Object.create(null)),new h(Object.create(null)),new h(Object.create(null)),new h(Object.create(null))])}pointsCount(){return 4}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let n=0;n<this.controlPoints.length;n++){const t=this.controlPoints[n],i=this.pointToScreenPoint(t);if(!i)return;e.push(new s(i,{pointIndex:n}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));const r={points:e,abRatio:NaN,cdRatio:NaN};if(e.length>=3){const[e,t,i]=this.controlPoints;r.abRatio=Math.round(1e3*Math.abs((i.price-t.price)/(t.price-e.price)))/1e3}if(e.length>=4){const[,e,t,i]=this.controlPoints;r.cdRatio=Math.round(1e3*Math.abs((i.price-t.price)/(t.price-e.price)))/1e3}this._lines.update(r)}}class y extends c{constructor(){super(...arguments),t(this,"type",d)}createPrimitive(){return new j({id:this.id,points:[],color:"#089981FF",lineWidth:2,background:a("#089981FF",.15),textColor:"#ffffff",textFontSize:12},...this.resetArgs)}}export{y as PatternABCDTool};
