var e=Object.defineProperty,i=(i,t,s)=>((i,t,s)=>t in i?e(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s)(i,"symbol"!=typeof t?t+"":t,s);import{L as t,bG as s,y as n,z as r,ch as a,e as o,bH as l,r as c,A as h,u as p}from"./index-5gyre0hA.js";import{T as d,a as u,D as m}from"./toolPaneView-BkZhzbTB.js";import{R as w}from"./index-iNH1zFVl.js";import{P as _}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as x}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as f,T as g}from"./axisPaneView-B6qY_qE1.js";import{B as P,H as V,V as b}from"./text-BhorOBkg.js";import{C as A}from"./composite-CCMtJLBO.js";import{L as T}from"./line-BKuOqRrm.js";import{P as L}from"./parallelChannel-DC2OIzzc.js";import{V as C}from"./verticalLine-EvGXqPib.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./line-Jebc4sVj.js";function y(e){if(0===e.length)throw new Error("mean requires at least one data point");return function(e){if(0===e.length)return 0;var i,t=e[0],s=0;if("number"!=typeof t)return Number.NaN;for(var n=1;n<e.length;n++){if("number"!=typeof e[n])return Number.NaN;i=t+e[n],Math.abs(t)>=Math.abs(e[n])?s+=t-i+e[n]:s+=e[n]-i+t,t=i}return t+s}(e)/e.length}function j(e){if(0===e.length)throw new Error("variance requires at least one data point");return function(e){var i,t,s=y(e),n=0;for(t=0;t<e.length;t++)n+=(i=e[t]-s)*i;return n}(e)/e.length}const D="#808080";class S extends d{constructor(){super(...arguments),i(this,"_pearsonsLabelRenderer",new P),i(this,"_renderer",new A(this._hitTestCollector))}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if(!(null==e?void 0:e.length))return;const i=this._buildGraphicData(),o=[i.lines[1],i.lines[0],i.lines[2]].filter(Boolean);if(!o.length)return this._renderer.append(...e.map((e=>new C({x:e.x,lineColor:D,lineWidth:1})))),void(e.length>1&&this._renderer.append(new T({points:e,lineColor:D,lineWidth:1,lineStyle:t.solid})));const l=this._source.properties().transparency;for(let t=1;t<o.length;t++){const e=o[t],i=o[t-1],a={line1:{color:e.lineColor,lineStyle:e.lineStyle,lineWidth:e.lineWidth,points:[e.points[0],e.points[1]]},line2:{color:e.lineColor,lineStyle:e.lineStyle,lineWidth:e.lineWidth,points:[i.points[0],i.points[1]]},extendLeft:!1,extendRight:e.extendRight,backColor:s(e.lineColor,l),skipLines:!0,fillBackground:!0},c=new L;c.setHitTest(new n(r.Regular)),c.setData(a),this._renderer.append(c)}const c=this._getTransparencyResetLines(o);for(let t=0;t<o.length;t++){const e=new T;e.setData(c[t]),e.setHitTest(new n(r.Regular)),this._renderer.append(e)}i.pearsons&&(i.pearsons.color=a(i.pearsons.color),this._pearsonsLabelRenderer.setData(i.pearsons),this._renderer.append(this._pearsonsLabelRenderer)),this.addAnchors(this._renderer)}_getTransparencyResetLines(e){return e.map((e=>({...e,lineColor:a(e.lineColor)})))}_buildGraphicData(){const e={lines:[],pearsons:null},i=this._source.properties(),t=[this._data.baseLine,this._data.downLine,this._data.upLine].filter(Boolean),s=[i.baseLine,i.downLine,i.upLine];for(let n=0;n<t.length;n++){const r=o(t[n]),a=s[n];e.lines.push({points:r.points,lineColor:a.color,lineWidth:a.lineWidth,lineStyle:a.lineStyle,extendLeft:!1,extendRight:i.extendLines,leftEnd:l.Normal,rightEnd:l.Normal})}return this._data.pearsons&&i.showPearsons&&(e.pearsons={points:[this._data.pearsons.point],text:String(this._data.pearsons.value),color:i.downLine.color,vertAlign:b.Top,horzAlign:V.Center,fontFamily:c,offsetX:0,offsetY:4,fontSize:12}),e}}class v extends u{constructor(){super(...arguments),i(this,"disableExtendTime",!0),i(this,"_lines",new S(this,this.model)),i(this,"_paneView",[this._lines]),i(this,"_priceAxisPaneViews",[new f(Object.create(null))]),i(this,"_timeAxisPaneViews",[new g(Object.create(null))]),i(this,"_timeAxisViews",[new x(Object.create(null)),new x(Object.create(null))]),i(this,"_priceAxisViews",[new _(Object.create(null)),new _(Object.create(null))]),i(this,"_regressionCache",null)}pointsCount(){return 2}setPoint(e,i,t){super.setPoint(e,i,t),this._regressionCache=null}_calculateRegression(){const[e,i]=this.controlPoints,t=o(this.chart.timeScale().timeToIndex(e.time)),s=o(this.chart.timeScale().timeToIndex(i.time)),n=Math.min(t,s),r=Math.max(t,s),a=this.series.data().slice(n,r+1),l=function(e){if(1===e.length)return 0;var i=j(e);return Math.sqrt(i)}(a.map((e=>e.customValues.close))),{m:c,b:h}=function(e){var i,t,s=e.length;if(1===s)i=0,t=e[0][1];else{for(var n,r,a,o=0,l=0,c=0,h=0,p=0;p<s;p++)o+=r=(n=e[p])[0],l+=a=n[1],c+=r*r,h+=r*a;t=l/s-(i=(s*h-o*l)/(s*c-o*o))*o/s}return{m:i,b:t}}(a.map(((e,i)=>[i,e.customValues.close]))),p=r-n,d=0*c+h,u=c*p+h,m=0*c+h+2*l,w=c*p+h+2*l,_=0*c+h-2*l,x=c*p+h-2*l;return{time0:e.time,time1:i.time,price0:d,price1:u,upPrice0:m,upPrice1:w,downPrice0:_,downPrice1:x}}updateAllViews(){if(!this.controlPoints.length)return;const e=Object.create(null),[i,t]=this.controlPoints,s=[];for(let n=0;n<this.controlPoints.length;n++){const e=this.controlPoints[n],i=this.pointToScreenPoint(e);if(!i)return;s.push(new h(i,{pointIndex:n}))}if(this.isDrawing||this._currentDragTarget)this._timeAxisViews[0].update(this._calculateTimeAxisViewData(i.time,s[0].x)),this._priceAxisViews[0].update(this._calculatePriceAxisViewData(i.price,s[0].y)),t&&(this._timeAxisViews[1].update(this._calculateTimeAxisViewData(t.time,s[1].x)),this._priceAxisViews[1].update(this._calculatePriceAxisViewData(t.price,s[1].y)),this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(s[1].y,s[1].y)),this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(s[0].x,s[1].x))),e.points=s;else{this._regressionCache||(this._regressionCache=this._calculateRegression());const{time0:i,time1:t,price0:s,price1:n,upPrice0:r,upPrice1:a,downPrice0:l,downPrice1:c}=this._regressionCache,d=o(this.chart.timeScale().timeToCoordinate(i)),u=o(this.chart.timeScale().timeToCoordinate(t)),m=o(this.series.priceToCoordinate(s)),w=o(this.series.priceToCoordinate(n)),_=o(this.series.priceToCoordinate(r)),x=o(this.series.priceToCoordinate(a)),f=o(this.series.priceToCoordinate(l)),g=o(this.series.priceToCoordinate(c));this._timeAxisViews[0].update(this._calculateTimeAxisViewData(i,d)),this._timeAxisViews[1].update(this._calculateTimeAxisViewData(t,u)),this._priceAxisViews[0].update(this._calculatePriceAxisViewData(s,m)),this._priceAxisViews[1].update(this._calculatePriceAxisViewData(n,w)),this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(m,w)),this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(d,u));const P=[new h(new p(d,m),{pointIndex:0}),new h(new p(u,w),{pointIndex:1})];e.baseLine={points:P},e.upLine={points:[new p(d,_),new p(u,x)]},e.downLine={points:[new p(d,f),new p(u,g)]},e.points=P}this._lines.update(e)}}class R extends m{constructor(){super(...arguments),i(this,"type",w),i(this,"disableExtendTime",!0)}createPrimitive(){return new v({id:this.id,points:[],baseLine:{color:"#F23645",lineStyle:t.dashed,lineWidth:1},upLine:{color:"#2962FF",lineStyle:t.solid,lineWidth:2},downLine:{color:"#2962FF",lineStyle:t.solid,lineWidth:2},extendLines:!1,showPearsons:!1,transparency:70},...this.resetArgs)}}export{R as RegressionTrendTool};
