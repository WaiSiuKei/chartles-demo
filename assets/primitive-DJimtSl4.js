var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{P as r}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as n}from"./timeLabelTimeAxisView-DLVMuesT.js";import{L as i,r as a,bH as s,A as o}from"./index-5gyre0hA.js";import{P as l,T as d}from"./axisPaneView-B6qY_qE1.js";import{T as c,a as h}from"./toolPaneView-BkZhzbTB.js";import{B as p,H as _,V as b}from"./text-BhorOBkg.js";import{b as m}from"./formatter-BMswhHnL.js";import{C as x}from"./composite-CCMtJLBO.js";import{L as u}from"./line-BKuOqRrm.js";import{P as R}from"./polygon-D49cV0Ps.js";import{T as f}from"./triangle-BThRCISa.js";class w extends c{constructor(){super(...arguments),t(this,"_renderer",new x(this._hitTestCollector)),t(this,"_bcRetracementTrend",new u),t(this,"_xdRetracementTrend",new u),t(this,"_xbTrend",new u),t(this,"_bdTrend",new u),t(this,"_polylineRenderer",new R),t(this,"_mainTriangleRenderer",new f),t(this,"_triangleRendererPoints234",new f),t(this,"_xbLabelRenderer",new p),t(this,"_acLabelRenderer",new p),t(this,"_bdLabelRenderer",new p),t(this,"_xdLabelRenderer",new p),t(this,"_textRendererALabel",new p),t(this,"_textRendererBLabel",new p),t(this,"_textRendererCLabel",new p),t(this,"_textRendererDLabel",new p),t(this,"_textRendererXLabel",new p)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if((null==e?void 0:e.length)<2)return;const t=this._source.properties(),r=(e,r)=>({points:[e],text:r,color:t.textColor,vertAlign:b.Middle,horzAlign:_.Center,fontFamily:a,offsetX:0,offsetY:0,fontSize:t.textFontSize,backgroundColor:t.color,backgroundRoundRect:4}),n=(e,r)=>({points:[e,r],lineColor:t.color,lineWidth:1,lineStyle:i.dotted,extendLeft:!1,extendRight:!1,leftEnd:s.Normal,rightEnd:s.Normal}),[o,l,d,c,h]=e,p={points:[o,l,e.length<3?l:d],color:"rgba(0, 0, 0, 0)",lineWidth:t.lineWidth,backColor:t.background,fillBackground:!0};if(this._mainTriangleRenderer.setData(p),this._renderer.append(this._mainTriangleRenderer),e.length>3){const r={points:[d,c,5===e.length?h:c],color:"rgba(0, 0, 0, 0)",lineWidth:t.lineWidth,backColor:t.background,fillBackground:!0};this._triangleRendererPoints234.setData(r),this._renderer.append(this._triangleRendererPoints234)}const x={points:e,lineColor:t.color,lineWidth:t.lineWidth,background:t.background,lineStyle:i.solid,filled:!1};this._polylineRenderer.setData(x),this._renderer.append(this._polylineRenderer);const u=m(3);if(e.length>=3){const e=r(o.add(d).scaled(.5),u.format(this._data.abRetracement));this._xbLabelRenderer.setData(e),this._renderer.append(this._xbLabelRenderer);const t=n(o,d);this._xbTrend.setData(t),this._renderer.append(this._xbTrend)}if(e.length>=4){const e=r(l.add(c).scaled(.5),u.format(this._data.bcRetracement));this._acLabelRenderer.setData(e),this._renderer.append(this._acLabelRenderer);const t=n(l,c);this._bcRetracementTrend.setData(t),this._renderer.append(this._bcRetracementTrend)}if(e.length>=5){const e=r(d.add(h).scaled(.5),u.format(this._data.cdRetracement));this._bdLabelRenderer.setData(e),this._renderer.append(this._bdLabelRenderer);const t=n(o,h);this._xdRetracementTrend.setData(t),this._renderer.append(this._xdRetracementTrend);const i=r(o.add(h).scaled(.5),u.format(this._data.xdRetracement));this._xdLabelRenderer.setData(i),this._renderer.append(this._xdLabelRenderer);const a=n(d,h);this._bdTrend.setData(a),this._renderer.append(this._bdTrend)}const R=r(o,"X");R.vertAlign=l.y>o.y?b.Bottom:b.Top,R.offsetY=5,this._textRendererXLabel.setData(R),this._renderer.append(this._textRendererXLabel);const f=r(l,"A");if(f.vertAlign=l.y<o.y?b.Bottom:b.Top,f.offsetY=5,this._textRendererALabel.setData(f),this._renderer.append(this._textRendererALabel),e.length>2){const e=r(d,"B");e.vertAlign=d.y<l.y?b.Bottom:b.Top,e.offsetY=5,this._textRendererBLabel.setData(e),this._renderer.append(this._textRendererBLabel)}if(e.length>3){const e=r(c,"C");e.vertAlign=c.y<d.y?b.Bottom:b.Top,e.offsetY=5,this._textRendererCLabel.setData(e),this._renderer.append(this._textRendererCLabel)}if(e.length>4){const e=r(h,"D");e.vertAlign=h.y<c.y?b.Bottom:b.Top,e.offsetY=5,this._textRendererDLabel.setData(e),this._renderer.append(this._textRendererDLabel)}this.addAnchors(this._renderer)}}class g extends h{constructor(){super(...arguments),t(this,"_lines",new w(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new l(Object.create(null))]),t(this,"_timeAxisPaneViews",[new d(Object.create(null))]),t(this,"_timeAxisViews",[new n(Object.create(null)),new n(Object.create(null)),new n(Object.create(null)),new n(Object.create(null)),new n(Object.create(null))]),t(this,"_priceAxisViews",[new r(Object.create(null)),new r(Object.create(null)),new r(Object.create(null)),new r(Object.create(null)),new r(Object.create(null))])}pointsCount(){return 5}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let i=0;i<this.controlPoints.length;i++){const t=this.controlPoints[i],r=this.pointToScreenPoint(t);if(!r)return;e.push(new o(r,{pointIndex:i}))}const t=e.map((e=>e.x)),r=e.map((e=>e.y));this.controlPoints.forEach(((t,r)=>{this._timeAxisViews[r].update(this._calculateTimeAxisViewData(t.time,e[r].x)),this._priceAxisViews[r].update(this._calculatePriceAxisViewData(t.price,e[r].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),r.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,r),Math.max.apply(null,r)));const n={points:e,abRetracement:NaN,bcRetracement:NaN,cdRetracement:NaN,xdRetracement:NaN};this._updateBaseData(n),this._lines.update(n)}_updateBaseData(e){const t=e.points;if(t.length>=3){const[t,r,n]=this.controlPoints,i=Math.abs((n.price-r.price)/(r.price-t.price));e.abRetracement=Math.round(1e3*i)/1e3}if(t.length>=4){const[,t,r,n]=this.controlPoints,i=Math.abs((n.price-r.price)/(r.price-t.price));e.bcRetracement=Math.round(1e3*i)/1e3}if(t.length>=5){const[t,r,n,i,a]=this.controlPoints,s=Math.abs((a.price-i.price)/(i.price-n.price)),o=Math.abs((a.price-r.price)/(r.price-t.price));e.cdRetracement=Math.round(1e3*s)/1e3,e.xdRetracement=Math.round(1e3*o)/1e3}}}export{g as P};
