var e=Object.defineProperty,t=(t,n,i)=>((t,n,i)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[n]=i)(t,"symbol"!=typeof n?n+"":n,i);import{u as n,bH as i,L as r,e as s,r as o,A as a,b$ as l}from"./index-5gyre0hA.js";import{T as d,a as h,D as c}from"./toolPaneView-BkZhzbTB.js";import{a4 as p}from"./index-iNH1zFVl.js";import{P as x}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as _}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as u,T as m}from"./axisPaneView-B6qY_qE1.js";import{B as f,H as w,V as b}from"./text-BhorOBkg.js";import{C as y}from"./composite-CCMtJLBO.js";import{L as P}from"./line-BKuOqRrm.js";import{T as g}from"./triangle-BThRCISa.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./line-Jebc4sVj.js";class A extends d{constructor(){super(...arguments),t(this,"_renderer",new y(this._hitTestCollector)),t(this,"_trendLineRendererPoints01",new P),t(this,"_trendLineRendererPoints12",new P),t(this,"_trendLineRendererPoints23",new P),t(this,"_intersectionRenderer",new g),t(this,"_aLabelRenderer",new f),t(this,"_bLabelRenderer",new f),t(this,"_cLabelRenderer",new f),t(this,"_dLabelRenderer",new f)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if((null==e?void 0:e.length)<2)return;const[t,a,l,d]=e;let h,c,p;if(4===e.length){if(Math.abs(l.x-t.x)<1||Math.abs(d.x-a.x)<1)return;const e=Math.min(t.x,a.x,l.x,d.x),i=(l.y-t.y)/(l.x-t.x),r=t.y+(e-t.x)*i,s=(d.y-a.y)/(d.x-a.x),o=a.y+(e-a.x)*s;if(Math.abs(i-s)<1e-6)return;c=new n(e,r),p=new n(e,o);const x=(a.y-t.y+(t.x*i-a.x*s))/(i-s);if(x<e){const e=Math.max(t.x,a.x,l.x,d.x);c=new n(e,t.y+(e-t.x)*i),p=new n(e,a.y+(e-a.x)*s)}const _=t.y+(x-t.x)*i;h=new n(x,_)}const x=this._source.properties(),_=(e,t)=>({points:[e],text:t,color:x.textColor,fontFamily:o,vertAlign:b.Middle,horzAlign:w.Center,offsetX:0,offsetY:0,fontSize:x.textFontSize,backgroundColor:x.lineColor,backgroundRoundRect:4}),u=(e,t)=>({points:[e,t],lineColor:x.lineColor,lineWidth:x.lineWidth,lineStyle:r.solid,extendLeft:!1,extendRight:!1,leftEnd:i.Normal,rightEnd:i.Normal});if(this._trendLineRendererPoints01.setData(u(t,a)),this._renderer.append(this._trendLineRendererPoints01),e.length>=3&&(this._trendLineRendererPoints12.setData(u(a,l)),this._renderer.append(this._trendLineRendererPoints12)),4===e.length&&(this._trendLineRendererPoints23.setData(u(l,d)),this._renderer.append(this._trendLineRendererPoints23),h&&c&&p)){const e={points:[s(c),s(p),h],color:x.lineColor,lineWidth:x.lineWidth,backColor:x.background,fillBackground:x.fillBackground,lineStyle:r.dotted};this._intersectionRenderer.setData(e),this._renderer.append(this._intersectionRenderer)}const m=_(t,"A");m.vertAlign=a.y>t.y?b.Bottom:b.Top,m.offsetY=5,this._aLabelRenderer.setData(m),this._renderer.append(this._aLabelRenderer);const f=_(a,"B");if(f.vertAlign=a.y<t.y?b.Bottom:b.Top,f.offsetY=5,this._bLabelRenderer.setData(f),this._renderer.append(this._bLabelRenderer),e.length>2){const e=_(l,"C");e.vertAlign=l.y<a.y?b.Bottom:b.Top,e.offsetY=5,this._cLabelRenderer.setData(e),this._renderer.append(this._cLabelRenderer)}if(e.length>3){const e=_(d,"D");e.vertAlign=d.y<l.y?b.Bottom:b.Top,e.offsetY=5,this._dLabelRenderer.setData(e),this._renderer.append(this._dLabelRenderer)}this.addAnchors(this._renderer)}}class R extends h{constructor(){super(...arguments),t(this,"_lines",new A(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new u(Object.create(null))]),t(this,"_timeAxisPaneViews",[new m(Object.create(null))]),t(this,"_timeAxisViews",[new _(Object.create(null)),new _(Object.create(null)),new _(Object.create(null)),new _(Object.create(null))]),t(this,"_priceAxisViews",[new x(Object.create(null)),new x(Object.create(null)),new x(Object.create(null)),new x(Object.create(null))])}pointsCount(){return 4}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let i=0;i<this.controlPoints.length;i++){const t=this.controlPoints[i],n=this.pointToScreenPoint(t);if(!n)return;e.push(new a(n,{pointIndex:i}))}const t=e.map((e=>e.x)),n=e.map((e=>e.y));this.controlPoints.forEach(((t,n)=>{this._timeAxisViews[n].update(this._calculateTimeAxisViewData(t.time,e[n].x)),this._priceAxisViews[n].update(this._calculatePriceAxisViewData(t.price,e[n].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),n.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,n),Math.max.apply(null,n))),this._lines.update({points:e})}}class L extends c{constructor(){super(...arguments),t(this,"type",p)}createPrimitive(){return new R({id:this.id,points:[],lineColor:"#673AB7FF",lineWidth:2,background:l("#673AB7FF",.15),fillBackground:!0,textColor:"#ffffff",textFontSize:12},...this.resetArgs)}}export{L as PatternTriangleTool};
