var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{T as i,a as r,D as s}from"./toolPaneView-BkZhzbTB.js";import{O as n}from"./index-iNH1zFVl.js";import{A as o,bH as l,L as a,u as c,e as h}from"./index-5gyre0hA.js";import{P as d}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as p}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as w,T as u}from"./axisPaneView-B6qY_qE1.js";import{C as x}from"./composite-CCMtJLBO.js";import{L as b}from"./line-BKuOqRrm.js";import{G as _}from"./gannArc-CNv-7ybb.js";import"./baseTool-BM5mqL4_.js";class v extends i{constructor(){super(...arguments),t(this,"_verticalLevelsRenderers",new Map),t(this,"_horizontalLevelsRenderers",new Map),t(this,"_fanRenderers",new Map),t(this,"_arcRenderers",new Map),t(this,"_renderer",new x(this._hitTestCollector))}getVerticalLevelRenderer(e){let t=this._verticalLevelsRenderers.get(e);return t||(t=new b,this._verticalLevelsRenderers.set(e,t)),t}getHorizontalLevelRenderer(e){let t=this._horizontalLevelsRenderers.get(e);return t||(t=new b,this._horizontalLevelsRenderers.set(e,t)),t}getFanRenderer(e){let t=this._fanRenderers.get(e);return t||(t=new b,this._fanRenderers.set(e,t)),t}getArcRenderer(e){let t=this._arcRenderers.get(e);return t||(t=new _,this._arcRenderers.set(e,t)),t}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points().slice(),t=this._data.screenPoints;if(e.length<2||t.length<2)return;const[i,r]=t;e[1]=new o(i,{pointIndex:1}),e[2]=new o(r,{pointIndex:2});const s=e[0],n=3===e.length?e[2]:e[1],l={barsCoordsRange:n.x-s.x,priceCoordsRange:n.y-s.y,startPoint:s,endPoint:n,p1:s,p2:n};this._prepareLevels(l),this._prepareFanLines(l),this._prepareArcs(l);const a=[s,e[1]];this._model.currentCreating===this._source&&a.pop(),this._renderer.append(this.createLineAnchor({points:a},0))}_prepareLevels(e){const{startPoint:t,endPoint:i,barsCoordsRange:r,priceCoordsRange:s}=e;this._source.properties().levels.forEach(((e,n)=>{if(!e.visible)return;const o=n/5,h=t.x+o*r,d={points:[new c(h,t.y),new c(h,i.y)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:l.Normal,rightEnd:l.Normal},p=this.getVerticalLevelRenderer(n);p.setData(d),this._renderer.append(p);const w=t.y+o*s,u={points:[new c(t.x,w),new c(i.x,w)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:l.Normal,rightEnd:l.Normal},x=this.getHorizontalLevelRenderer(n);x.setData(u),this._renderer.append(x)}))}_prepareFanLines(e){const{p1:t,startPoint:i,endPoint:r,barsCoordsRange:s,priceCoordsRange:n}=e;this._source.properties().fanlines.forEach(((e,o)=>{if(!e.visible)return;const h=e.x,d=e.y;let p,w;h>d?(p=r.x,w=i.y+d/h*n):(w=r.y,p=i.x+h/d*s);const u={points:[t,new c(p,w)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:l.Normal,rightEnd:l.Normal},x=this.getFanRenderer(o);x.setData(u),this._renderer.append(x)}))}_prepareArcs(e){const{p1:t,startPoint:i,endPoint:r,barsCoordsRange:s,priceCoordsRange:n}=e;let o=t;const l=this._source.properties().arcsBackground.fillBackground,a=this._source.properties().arcsBackground.transparency;this._source.properties().arcs.forEach(((e,t)=>{if(!e.visible)return;const h=e.x/5,d=e.y/5,p=i.x+h*s,w=i.y+d*n,u={center:i,point:new c(p,w),edge:r,color:e.color,linewidth:e.width,fillBack:l,transparency:a,prevPoint:o},x=this.getArcRenderer(t);x.setData(u),this._renderer.append(x),o=u.point}))}}class y extends r{constructor(){super(...arguments),t(this,"_lines",new v(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new w(Object.create(null))]),t(this,"_timeAxisPaneViews",[new u(Object.create(null))]),t(this,"_timeAxisViews",[new p(Object.create(null)),new p(Object.create(null))]),t(this,"_priceAxisViews",[new d(Object.create(null)),new d(Object.create(null))])}pointsCount(){return 2}_calcAngle(){const e=this.controlPoints;if(e.length<2)return null;const[t,i]=e,r=this.pointToScreenPoint(t),s=this.pointToScreenPoint(i);if(null===r||null===s)return null;let n=s.subtract(r);if(n.length()<=0)return null;n=n.normalized();let o=Math.acos(n.x);return n.y>0&&(o=-o),o}getScreenPoints(){const e=this.controlPoints;if(e.length<2)return[];const t=this._calcAngle();if(null===t)return[];const[i,r]=e,s=h(this.pointToScreenPoint(i)),n=h(this.pointToScreenPoint(r)),o=Math.sqrt(Math.pow(s.x-n.x,2)+Math.pow(s.y-n.y,2)),l=new c(Math.cos(t),-Math.sin(t)),a=l.normalized(),d=a.x<0?-1:1,p=a.y<0?-1:1;return[s.addScaled(l,o),s.add(new c(5*o*d,5*o*p))]}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let r=0;r<this.controlPoints.length;r++){const t=this.controlPoints[r],i=this.pointToScreenPoint(t);if(!i)return;e.push(new o(i,{pointIndex:r}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i))),this._lines.update({points:e,screenPoints:this.getScreenPoints()})}}class g extends s{constructor(){super(...arguments),t(this,"type",n)}createPrimitive(){return new y({id:this.id,points:[],fillBackground:!1,arcsBackground:{fillBackground:!0,transparency:80},reverse:!1,levels:[{color:"#808080",width:2,visible:!0},{color:"#FF9800",width:2,visible:!0},{color:"#00bcd4",width:2,visible:!0},{color:"#4caf50",width:2,visible:!0},{color:"#089981",width:2,visible:!0},{color:"#808080",width:2,visible:!0}],fanlines:[{color:"#B39DDB",visible:!1,width:2,x:8,y:1},{color:"#F23645",visible:!1,width:2,x:5,y:1},{color:"#808080",visible:!1,width:2,x:4,y:1},{color:"#FF9800",visible:!1,width:2,x:3,y:1},{color:"#00bcd4",visible:!0,width:2,x:2,y:1},{color:"#4caf50",visible:!0,width:2,x:1,y:1},{color:"#089981",visible:!0,width:2,x:1,y:2},{color:"#089981",visible:!1,width:2,x:1,y:3},{color:"#2962FF",visible:!1,width:2,x:1,y:4},{color:"#9575cd",visible:!1,width:2,x:1,y:5},{color:"#B39DDB",visible:!1,width:2,x:1,y:8}],arcs:[{color:"#FF9800",visible:!0,width:2,x:1,y:0},{color:"#FF9800",visible:!0,width:2,x:1,y:1},{color:"#FF9800",visible:!0,width:2,x:1.5,y:0},{color:"#00bcd4",visible:!0,width:2,x:2,y:0},{color:"#00bcd4",visible:!0,width:2,x:2,y:1},{color:"#4caf50",visible:!0,width:2,x:3,y:0},{color:"#4caf50",visible:!0,width:2,x:3,y:1},{color:"#089981",visible:!0,width:2,x:4,y:0},{color:"#089981",visible:!0,width:2,x:4,y:1},{color:"#2962FF",visible:!0,width:2,x:5,y:0},{color:"#2962FF",visible:!0,width:2,x:5,y:1}]},...this.resetArgs)}}export{g as GannSquareFixedTool};
