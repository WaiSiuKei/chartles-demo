var e=Object.defineProperty,t=(t,s,o)=>((t,s,o)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o)(t,"symbol"!=typeof s?s+"":s,o);import{u as s,bH as o,r as i,A as r,e as n,L as l}from"./index-5gyre0hA.js";import{T as a,a as c,D as h}from"./toolPaneView-BkZhzbTB.js";import{J as p}from"./index-iNH1zFVl.js";import{P as f}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as d}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as m,T as x}from"./axisPaneView-B6qY_qE1.js";import{B as w,V as u,H as v}from"./text-BhorOBkg.js";import{b as _}from"./formatter-BMswhHnL.js";import{C as g}from"./composite-CCMtJLBO.js";import{L}from"./line-BKuOqRrm.js";import{R as b}from"./rectangle-E0x1RaIQ.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./numericFormatter-DcPXx81O.js";class y extends a{constructor(){super(...arguments),t(this,"_renderer",new g(this._hitTestCollector)),t(this,"_leftTextRenderers",new Map),t(this,"_rightTextRenderers",new Map),t(this,"_topTextRenderers",new Map),t(this,"_bottomTextRenderers",new Map)}getTextRenderers(e,t){const s={left:this._leftTextRenderers,right:this._rightTextRenderers,top:this._topTextRenderers,bottom:this._bottomTextRenderers};let o=s[e].get(t);return o||(o=new w,s[e].set(t,o)),o}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if((null==e?void 0:e.length)<2)return;const t=this._source.properties();if(e.length<2)return void this.addAnchors(this._renderer);const n=e[0],l=e[1],a=Math.min(n.x,l.x),c=Math.min(n.y,l.y),h=Math.max(n.x,l.x),p=Math.max(n.y,l.y),f=t.fillHorzBackground,d=t.horzTransparency,m=t.fillVertBackground,x=t.vertTransparency,w=_();for(let r=0;r<t.hLevels.length;r++){if(r>0&&f){const e=new b;e.setData({points:[new s(a,this._data.hLevels[r].y),new s(h,this._data.hLevels[r-1].y)],color:t.hLevels[r].color,backColor:t.hLevels[r].color,transparency:d,lineWidth:0,extendLeft:!1,extendRight:!1}),this._renderer.append(e)}const e=new L,n=new s(a,this._data.hLevels[r].y),l=new s(h,this._data.hLevels[r].y);if(e.setData({points:[n,l],lineColor:t.hLevels[r].color,lineWidth:t.linewidth,lineStyle:t.linestyle,extendLeft:!1,extendRight:!1,leftEnd:o.Normal,rightEnd:o.Normal}),this._renderer.append(e),t.showLeftLabels){const e=this.getTextRenderers("left",r);e.setData({points:[n],text:w.format(t.hLevels[r].coeff),color:t.hLevels[r].color,horzAlign:v.Right,vertAlign:u.Middle,fontFamily:i,offsetX:5,offsetY:0,fontSize:12,forceTextAlign:!0}),this._renderer.append(e)}if(t.showRightLabels){const e=this.getTextRenderers("right",r);e.setData({points:[l],text:w.format(t.hLevels[r].coeff),color:t.hLevels[r].color,horzAlign:v.Left,vertAlign:u.Middle,fontFamily:i,offsetX:5,offsetY:0,fontSize:12}),this._renderer.append(e)}}for(let r=0;r<t.vLevels.length;r++){const e=this._data.vLevels[r].x;if(r>0&&m){const o=new b;o.setData({points:[new s(this._data.vLevels[r-1].x,c),new s(e,p)],color:t.vLevels[r].color,backColor:t.vLevels[r].color,transparency:x,lineWidth:0,extendLeft:!1,extendRight:!1}),this._renderer.append(o)}const n=new L,l=new s(e,c),a=new s(e,p);if(n.setData({points:[l,a],lineColor:t.vLevels[r].color,lineWidth:t.linewidth,lineStyle:t.linestyle,extendLeft:!1,extendRight:!1,leftEnd:o.Normal,rightEnd:o.Normal}),this._renderer.append(n),t.showTopLabels){const e=this.getTextRenderers("top",r);e.setData({points:[l],text:w.format(t.vLevels[r].coeff),color:t.vLevels[r].color,vertAlign:u.Bottom,horzAlign:v.Center,fontFamily:i,offsetX:0,offsetY:3,fontSize:12}),this._renderer.append(e)}if(t.showBottomLabels){const e=this.getTextRenderers("bottom",r);e.setData({points:[a],text:w.format(t.vLevels[r].coeff),color:t.vLevels[r].color,vertAlign:u.Top,horzAlign:v.Center,fontFamily:i,offsetX:0,offsetY:5,fontSize:12}),this._renderer.append(e)}}const g=new r(new s(e[0].x,e[1].y),{pointIndex:2}),y=new r(new s(e[1].x,e[0].y),{pointIndex:3}),T=this.createLineAnchor({points:[...e,g,y]},0);this._renderer.append(T)}}class T extends c{constructor(){super(...arguments),t(this,"_lines",new y(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new m(Object.create(null))]),t(this,"_timeAxisPaneViews",[new x(Object.create(null))]),t(this,"_timeAxisViews",[new d(Object.create(null)),new d(Object.create(null))]),t(this,"_priceAxisViews",[new f(Object.create(null)),new f(Object.create(null))])}pointsCount(){return 2}setPoint(e,t,s){switch(e){case 2:this.controlPoints[0].time=t.time,this.controlPoints[1].price=t.price;break;case 3:this.controlPoints[1].time=t.time,this.controlPoints[0].price=t.price;break;default:super.setPoint(e,t,s)}}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let n=0;n<this.controlPoints.length;n++){const t=this.controlPoints[n],s=this.pointToScreenPoint(t);if(!s)return;e.push(new r(s,{pointIndex:n}))}const t=e.map((e=>e.x)),s=e.map((e=>e.y));this.controlPoints.forEach(((t,s)=>{this._timeAxisViews[s].update(this._calculateTimeAxisViewData(t.time,e[s].x)),this._priceAxisViews[s].update(this._calculatePriceAxisViewData(t.price,e[s].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),s.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,s),Math.max.apply(null,s)));let o=[],i=[];if(this.controlPoints.length>1&&this.chart.timeScale().getVisibleRange()){const[e,t]=this.controlPoints,s=this._props.reverse,r=s?e.price-t.price:t.price-e.price,l=s?t.price:e.price;o=this._props.hLevels.reduce(((e,t)=>{const s=t.coeff,o=l+s*r;return e.push({y:n(this.series.priceToCoordinate(o))}),e}),[]);const a=n(this.chart.timeScale().timeToIndexEx(e.time)),c=n(this.chart.timeScale().timeToIndexEx(t.time)),h=s?a-c:c-a,p=s?c:a;i=this._props.vLevels.reduce(((e,t)=>{const s=t.coeff,o=Math.round(p+s*h),i=n(this.chart.timeScale().logicalToCoordinate(o));return e.push({x:i}),e}),[])}this._lines.update({points:e,hLevels:o,vLevels:i})}}class A extends h{constructor(){super(...arguments),t(this,"type",p)}createPrimitive(){return new T({id:this.id,points:[],color:"rgba(21, 56, 153, 0.8)",linewidth:2,linestyle:l.solid,showTopLabels:!0,showBottomLabels:!0,showLeftLabels:!0,showRightLabels:!0,fillHorzBackground:!0,horzTransparency:80,fillVertBackground:!0,vertTransparency:80,reverse:!1,fans:{color:"rgb(156, 156, 156)",visible:!1},hLevels:[{coeff:0,color:"#808080"},{coeff:.25,color:"#FF9800"},{coeff:.382,color:"#00BCD4"},{coeff:.5,color:"#4CAF50"},{coeff:.618,color:"#089981"},{coeff:.75,color:"#2962FF"},{coeff:1,color:"#808080"}],vLevels:[{coeff:0,color:"#808080 "},{coeff:.25,color:"#FF9800"},{coeff:.382,color:"#00BCD4"},{coeff:.5,color:"#4CAF50"},{coeff:.618,color:"#089981"},{coeff:.75,color:"#2962FF"},{coeff:1,color:"#808080"}]},...this.resetArgs)}}export{A as GannBoxTool};
