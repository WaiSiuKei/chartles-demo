var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{a1 as i,Q as s,S as a,bz as n,W as r,a8 as o,bA as c,aa as l,bB as h,bC as d,$ as p,ad as m,b9 as u,a0 as g,b8 as v,ae as w,a9 as x,au as f,a4 as _,Z as b,bf as y,ac as P,A as k,u as S,G as T,bD as A,w as j,v as C,y as I,z as W,bE as z,e as H,I as L,b5 as M,m as R,b as V}from"./index-5gyre0hA.js";import{T as B,a as O,D}from"./toolPaneView-BkZhzbTB.js";import{P as U}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as E}from"./timeLabelTimeAxisView-DLVMuesT.js";import{C as $}from"./composite-CCMtJLBO.js";import"./baseTool-BM5mqL4_.js";const G=new Set;const Z=async(e,t,i)=>{const s=await function(){for(const e of G)e.remove();return new Promise((e=>{const t=document.createElement("input");t.type="file",t.accept=".jpg,.jpeg,.png,.webp",Object.assign(t.style,{display:"none"}),document.body.append(t),G.add(t),t.addEventListener("change",(function(i){const{files:s}=i.target;if(s.length>0){const t=s[0];t.size?e(t):e(null)}else e(null);t.remove(),G.delete(t)})),setTimeout((()=>{t.click()}))}))}();s&&(v(t,s,!0),v(i,await function(e){return new Promise((t=>{const i=new FileReader;i.onload=()=>{t(i.result)},i.onerror=()=>{t("")},i.readAsDataURL(e)}))}(s),!0))};var F=r('<img class="img svelte-1k3ap48" alt=""/>'),K=r('<div class="texts svelte-1k3ap48"><div class="headline svelte-1k3ap48"> </div> <div> </div> <div> </div></div>'),Q=r('<div class="drop-zone svelte-1k3ap48"><!></div>'),Y=r("<!> <!> <!>",1);const q={hash:"svelte-1k3ap48",code:".drop-zone.svelte-1k3ap48 {width:340px;height:190px;margin-top:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9f9f9;border:1px dashed #dbdbdb;border-radius:4px;cursor:pointer;}.drop-zone.svelte-1k3ap48:hover .headline:where(.svelte-1k3ap48) {color:#2962ff;}.texts.svelte-1k3ap48 {align-items:center;color:#9c9c9c;display:flex;flex-direction:column;justify-content:center;line-height:21px;font-size:14px;font-style:normal;font-weight:400;}.headline.svelte-1k3ap48 {color:#0f0f0f;margin-bottom:8px;padding:8px;text-align:center;line-height:24px;font-size:16px;font-style:normal;font-weight:400;}.img.svelte-1k3ap48 {width:100%;height:100%;object-fit:contain;}"};function J(e,t){i(t,!0),s(e,q);const{t:r}=a();let f=u(!0),k=u(void 0),S=u("");const T=()=>{v(f,!1),t.onClose()},A=()=>{v(f,!1),t.onClose(m(k))};n(e,{get open(){return m(f)},onSMUIDialogClosed:T,children:(e,t)=>{var i=Y(),s=o(i);{let e=w((()=>r("tool.image.dialog.title")));c(s,{get title(){return m(e)},noBorder:!0})}var a=l(s,2);h(a,{children:(e,t)=>{var i=Q();i.__click=[Z,k,S];var s=_(i),a=e=>{var t=F();b((()=>y(t,"src",m(S)))),p(e,t)},n=e=>{var t=K(),i=_(t),s=_(i),a=l(i,2),n=_(a),o=l(a,2),c=_(o);b(((e,t,i)=>{P(s,e),P(n,t),P(c,i)}),[()=>r("tool.image.dialog.choose"),()=>r("tool.image.dialog.imageTypes"),()=>r("tool.image.dialog.sizeLimit")]),p(e,t)};x(s,(e=>{m(S)?e(a):e(n,!1)})),p(e,i)},$$slots:{default:!0}});var n=l(a,2);{let e=w((()=>r("common.ok"))),t=w((()=>r("common.cancel")));d(n,{get mainButtonText(){return m(e)},get cancelButtonText(){return m(t)},onConfirm:A,onCancel:T})}p(e,i)},$$slots:{default:!0}}),g()}f(["click"]);class N extends A{hitTest(e){if(!this._data)return null;const{point:t,cssWidth:i,cssHeight:s}=this._data,a=new S(t.x,t.y),n=new S(t.x+i,t.y+s),r=j(a,n);return C(e,r)?new I(W.MovePoint):null}drawImpl(e){if(!this._data)return;const{angle:t,img:i,point:s,cssWidth:a,cssHeight:n}=this._data,r=e.context;Math.abs(t)<1e-4?r.drawImage(i,s.x,s.y,a,n):(r.translate(s.x,s.y),r.rotate(t),r.drawImage(i,0,0,a,n))}}class X extends B{constructor(){super(...arguments),t(this,"_renderer",new $(this._hitTestCollector)),t(this,"_imageRenderer",new N)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this._source.properties();if(!e.image)return;const t=this._calculateBox();t&&(this._imageRenderer.setData({point:t[0],img:this._data.imageElement,cssWidth:e.cssWidth,cssHeight:e.cssHeight,angle:0}),this._renderer.append(this._imageRenderer),this._addAnchors())}_addAnchors(){const e=this._calculateBox();if(void 0===e)return;const[t,i]=e,s=[new k(new S(t.x+1,t.y+1),{pointIndex:0,cursorType:T.nwse}),new k(new S(i.x-1,t.y+1),{pointIndex:0,cursorType:T.nesw}),new k(new S(t.x+1,i.y-1),{pointIndex:2,cursorType:T.nesw}),new k(new S(i.x-1,i.y-1),{pointIndex:3,cursorType:T.nwse})];this._renderer.append(this.createLineAnchor({points:s},0))}_calculateBox(){const e=this._source.properties(),t=e.cssWidth,i=e.cssHeight,[s]=this.points();if(!s)return;const a=t/2,n=i/2;return[new S(s.x-a,s.y-n),new S(s.x+a,s.y+n)]}}class ee extends O{constructor(){super(...arguments),t(this,"_image",new X(this,this.model)),t(this,"_paneView",[this._image]),t(this,"_timeAxisViews",[new E(Object.create(null))]),t(this,"_priceAxisViews",[new U(Object.create(null))]),t(this,"_promise")}pointsCount(){return 0}updateAllViews(){if(!this.controlPoints.length)return;if(!this._promise)return void this.loadImage();const e=this._promise.value;if(!e)return;const[t]=this.controlPoints,i=this.pointToScreenPoint(t);if(!i)return;const s=new k(i);this._timeAxisViews[0].update(this._calculateTimeAxisViewData(t.time,s.x)),this._priceAxisViews[0].update(this._calculatePriceAxisViewData(t.price,s.y)),this._image.update({points:[s],imageElement:e})}loadImage(){const e=new z;var t;return(t=this._props.image,new Promise((e=>{const i=new Image,s=URL.createObjectURL(t);i.onload=()=>{URL.revokeObjectURL(s),e(i)},i.onerror=()=>{URL.revokeObjectURL(s),e(null)},i.src=s}))).then((t=>{e.complete(t)})),this._promise=e,e.p}setPoint(e,t,i){var s;const a=H(null==(s=this._promise)?void 0:s.value),n=H(this.pointToScreenPoint(this.controlPoints[0])),r=a.naturalWidth/a.naturalHeight,o=Math.abs(n.x-i.screenPoint.x),c=Math.round(2*o);this._props.cssWidth=c,this._props.cssHeight=c/r}fitSize(){var e;if(this._props.cssWidth&&this._props.cssHeight)return;const t=H(null==(e=this._promise)?void 0:e.value),i=this.getScope(),{width:s,height:a}=i.mediaSize,n=s/4,r=a/4,o=t.naturalWidth,c=t.naturalHeight,l=Math.min(1,n/o),h=Math.min(1,r/c),d=Math.min(l,h),p=Math.round(d*o),m=Math.round(d*c);this.updateProps({cssWidth:p,cssHeight:m})}}var te=Object.getOwnPropertyDescriptor,ie=(e,t)=>(i,s)=>t(i,s,e);let se=class extends D{constructor(e,i,s){super(),t(this,"type",L),t(this,"canGoBackward",!1),t(this,"image"),this.guiService=e,this.toolService=i,this.chartManagementService=s}activated(){const e=this.guiService.showComponent({Component:J,props:{onClose:async t=>{this.canGoBackward=!0,e.dispose(),t&&this.onImage(t),this.toolService.switchBack()}}})}async onImage(e){this.image=e;const t=this.chartManagementService.activeChart();this._startCreationOnChart(t,0,!1);const i=t.mainSeriesApi.getSeries(),s=t.chartApi.timeScale().width()/2,a=i.getPane().getHeight()/2,n=H(t.chartApi.timeScale().coordinateToTimeEx(s)),r=H(t.mainSeriesApi.getSeries().coordinateToPrice(a)),o=this.createPrimitive();o.attach(i),await o.loadImage(),o.addPoint({time:n,price:r},0),o.fitSize(),t.getController().attachToolPrimitive(o,!0)}processEvent(){}createPrimitive(){var e;return new ee({id:this.id,points:[],image:H(this.image||(null==(e=this.presetProps)?void 0:e.image)),cssWidth:0,cssHeight:0},...this.resetArgs)}canKeepDrawing(){return!1}};se=((e,t,i,s)=>{for(var a,n=s>1?void 0:s?te(t,i):t,r=e.length-1;r>=0;r--)(a=e[r])&&(n=a(n)||n);return n})([ie(0,M),ie(1,R),ie(2,V)],se);class ae extends se{activated(){}}export{se as ImageTool,ae as PasteImageTool};
