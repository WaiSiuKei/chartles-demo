var t=Object.defineProperty,e=(e,i,o)=>((e,i,o)=>i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[i]=o)(e,"symbol"!=typeof i?i+"":i,o);import{u as i,bM as o,w as n,bQ as s,bR as r,bW as a,e as h,r as l,B as d,y as c,z as g,aX as p,aY as u,v as f,bX as m}from"./index-5gyre0hA.js";import{H as w,V as _,w as x}from"./text-BhorOBkg.js";import{f as v,s as R}from"./text-BFLAaZ9z.js";import{d as b,c as M,g as y}from"./ctx-BQtFq0AI.js";import{m as P}from"./font-DVjjKW8j.js";import{g as S,a as C,b as D}from"./formatter-BMswhHnL.js";import{C as z}from"./composite-CCMtJLBO.js";import{s as A}from"./svg-D8gy4lKT.js";import{b as T,T as L}from"./textPaneView-LQytaZVw.js";var j=(t=>(t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right",t[t.Auto=3]="Auto",t))(j||{});const B=18;let H=null,F=null;class V extends d{constructor(){super(...arguments),e(this,"_hitTest",new c(g.MovePoint)),e(this,"_preRenderedData",null),e(this,"_textWidthCache",new p)}setData(t){super.setData(t),this._preRenderedData=null}updatePoint(t){this._data&&(this._data.point=t)}drawImpl(t){const e=t.context;if(!this._data||null===this._data.text)return;const i=this._preRender();if(!i)return;const{horizontalPixelRatio:o,verticalPixelRatio:n}=t,{point:s,horzAlign:r,doNotAlignText:a,backgroundRoundRect:h,backgroundColor:l,color:d,lineSpacing:c,icons:g,isDark:p}=this._data,{font:f,lineHeight:m,lines:_,padding:x,rectSize:v,textPointOffset:R}=i,M=Math.round(s.x*o),y=Math.round(s.y*n),P=Math.round(v.width*o),S=Math.round(v.height*n);if(r!==w.Right&&r!==w.Center||a||(e.textAlign=r===w.Right?"end":"center"),h?(u(e,M,y,P,S,h*o),e.fillStyle=l,e.fill(),e.globalAlpha=1):(e.fillStyle=l,e.fillRect(M,y,P,S),e.globalAlpha=1),g){const i=Math.max(0,(m-B)/2),r=Math.round((s.x+x.left)*o);let a=s.y+x.top+i;for(const o of g){const i=Math.round(a*n);this._drawIcon(e,r,i,(F||(F={angle:A('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M8.55 2.78 2.7 15H15v-1h-4.01a6.2 6.2 0 0 0-1.36-3.95 7.94 7.94 0 0 0-2.57-1.83l2.4-5-.91-.44ZM6.63 9.12 4.29 14H10a5.18 5.18 0 0 0-1.12-3.3 6.93 6.93 0 0 0-2.24-1.58Z"/></svg>\n'),priceRange:A('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M3 2h11v1H3V2Zm5.5 1.8.35.35 2 2 .36.35-.71.7-.35-.35L9 5.71v6.58l1.15-1.14.35-.36.7.71-.35.35-2 2-.35.36-.35-.36-2-2-.36-.35.71-.7.35.35L8 12.29V5.71L6.85 6.85l-.35.36-.7-.71.35-.35 2-2 .35-.36ZM3.5 16H3v-1h11v1H3.5Z"/></svg>\n'),barsRange:A('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M2 3v2H1v9h1v2h1v-2h1V5H3V3H2Zm6.2 4.5-.35.35L6.71 9h4.58l-1.14-1.15-.36-.35.71-.7.35.35 2 2 .36.35-.36.35-2 2-.35.36-.7-.71.35-.35L11.29 10H6.71l1.14 1.15.36.35-.71.7-.35-.35-2-2-.36-.35.36-.35 2-2 .35-.36.7.71ZM3 6H2v7h1V6Zm12-2.5V3h1v2h1v9h-1v2h-1v-2h-1V5h1V3.5ZM15 6h1v7h-1V6Z"/></svg>\n')}),F)[o],Boolean(p),t),a+=m+c}}const C=s.x+R.x;let D=s.y+R.y;e.fillStyle=d,e.textBaseline="middle",e.font=f;const z=Math.round(m/2);b(e,o,n,(()=>{for(const t of _)e.fillText(t,C,D+z),D+=m+c}))}hitTest(t){const e=this._data,o=this._preRender();if(!e||!o)return null;const s=new i(e.point.x+o.rectSize.width,e.point.y+o.rectSize.height);return f(t,n(e.point,s))?this._hitTest:null}rectSize(){const t=this._preRender();return t?m({width:t.rectSize.width,height:t.rectSize.height}):null}_preRender(){if(!this._data)return null;if(this._preRenderedData)return this._preRenderedData;const{fontSize:t=12,text:e,wordWrapWidth:i,paddingBottom:o,paddingTop:n,paddingLeft:s,paddingRight:r,icons:a,bold:h,italic:l,lineSpacing:d}=this._data,c=P(t,this._data.font,l?"italic":void 0,h?"bold":void 0),g=(()=>{if(null!==H)return H;const t=M(document,m({width:0,height:0}));return H=y(t),H})();g.textBaseline="middle",g.font=c;const p=null===e?[]:x(e,c,this._textWidthCache,!0,i).map((t=>t.text));let u=0;if(i)u=i;else for(const m of p)u=Math.max(u,g.measureText(m).width);const f={top:n,right:r,bottom:o,left:s},w=Math.max(t,(null==a?void 0:a.length)?B:0),_=w*p.length+d*(p.length-1),v={width:u+f.left+f.right,height:_+f.top+f.bottom},R={x:f.left,y:f.top};if(a){const e=void 0!==this._data.textPadding?this._data.textPadding:t/2;R.x+=B+e,v.width+=B+e}return v.width%2!=0&&(v.width+=1),this._preRenderedData={rectSize:v,padding:f,textPointOffset:R,lines:p,lineHeight:w,font:c},this._preRenderedData}_drawIcon(t,e,i,o,n,s){t.fillStyle=n?"#F9F9F9":"#303030",o.render(t,{targetViewBox:{x:e,y:i,width:Math.round(B*s.horizontalPixelRatio),height:Math.round(B*s.verticalPixelRatio)},doNotApplyColors:!0})}}class Z extends T{constructor(){super(...arguments),e(this,"_mode",L.Preview),e(this,"_renderer",new z(this._hitTestCollector)),e(this,"_labelData",null),e(this,"_label",null),e(this,"_middlePoint",null),e(this,"_statsRenderer",new V)}renderer(){return this._renderer}_updateAndReturnStatsRenderer(t){this._statsRenderer.setData(this._statLabelData());const e=this._statsRenderer.rectSize();if(null!==e){const o=this._targetRect(t,e);this._statsRenderer.updatePoint(new i(o.left,o.top))}return this._statsRenderer}_targetRect(t,e){const a=this._source.properties().statsPosition,h=this._getPointsForStats(),l=a===j.Auto?j.Center:a;let d=h[l].x+12,c=h[l].y;const g=this.points(),p=g[1].y<g[0].y&&g[1].x<g[0].x||g[1].y>g[0].y&&g[1].x>g[0].x;p?c-=12+e.height:c+=12;const{mediaSize:u}=t;if(a===j.Auto&&!o(h[j.Left],h[j.Right])){d<0?d=0:d+e.width>u.width&&(d=u.width-e.width),c<0?c=0:c+e.height>u.height&&(c=u.height-e.height);const t=n(new i(d,c),new i(d+e.width,c+e.height)),o=s(h[j.Left],h[j.Right]);r(o,t)&&(c=p?h[l].y+12:h[l].y-12-e.height,d=Math.min(h[j.Center].x,u.width)-e.width)}return{left:Math.floor(d),top:Math.floor(c),width:e.width,height:e.height}}_priceRange(){var t;const[e,i]=this._source.controlPoints,o=this._source.properties(),n=o.showPriceRange,s=o.showPercentPriceRange,r=o.showPipsPriceRange;let h=null;if(this._source.priceScale()&&(n||s||r)){const o=[],l=i.price-e.price;if(n||s){const r=l/Math.abs(e.price),h=[];if(n){const o=this._source.series.priceFormatter(),n="formatChange"in o&&a(o.formatChange)?null==(t=o.formatChange)?void 0:t.call(o,i.price,e.price):o.format(l);h.push(n)}if(s){const t=S().format(100*r);h.push(n?`(${t})`:t)}o.push(h.join(" "))}const d=this._source.symbolInfo(),c=d&&C(d);r&&c&&o.push(c.format(l)),h=o.join(", ")}return h}_statLabelData(){const[t,e]=this._source.controlPoints,i=this._source.properties(),o=[];let n,s,r,a;const d=this._priceRange();void 0!==d&&o.push("priceRange");const c=i.showBarsRange,g=i.showDateTimeRange,p=i.showDistance,u=i.showAngle;if(u||p){const i=h(this._source.pointToScreenPoint(t));r=h(this._source.pointToScreenPoint(e)).subtract(i),a=Math.round(1e5*r.length())/1e5}if(c||g||p){if(n="",c){const o=h(this._source.getIndex(e))-h(this._source.getIndex(t));n+=h(i.formatBarCount)({count:v(String(o))})}if(g){const i=t.time,o=e.time;if(i&&o){const t=R(this._source.timeSpanFormatter()(i,o));t&&(n+=c?" ("+t+")":t)}}p&&(n&&(n+=", "),n+=h(i.formatDistance)({distance:v(D().format(Math.round(Number(a))))})),n&&o.push("barsRange")}if(u){let t;if(void 0!==a&&a>0&&void 0!==r&&(r=r.normalized(),t=Math.acos(r.x),r.y>0&&(t=-t)),"number"==typeof t&&!isNaN(t)){const e=180*t/Math.PI;s=Math.round(100*e)/100+"ยบ",o.push("angle")}}this._label=[v(d??""),n,s].filter((t=>!!t)).join("\n")||null;const f=this._model.isDarkTheme(),m=f?"#464646e6":"#f2f2f2e6",x=f?"#FFFFFF":"#1a1a1a",b=this.points(),M={point:b[1],text:this._label,color:x,isDark:f,font:l,fontSize:12,lineSpacing:8,backgroundColor:m,backgroundRoundRect:4,paddingLeft:12,paddingRight:12,paddingTop:12,paddingBottom:12,textPadding:12,doNotAlignText:!0,icons:o,bold:!1,italic:!1,lines:[],wordWrapWidth:0,vertAlign:_.Top,horzAlign:w.Left};return b[1].y<b[0].y&&(M.vertAlign=_.Bottom),b[1].x<b[0].x&&(M.horzAlign=w.Right),this._labelData=M,M}}export{j as S,Z as T};
