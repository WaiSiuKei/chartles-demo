var e;function t(e,t){return e[13]=1,e[14]=t>>8,e[15]=255&t,e[16]=t>>8,e[17]=255&t,e}const n="p".charCodeAt(0),r="H".charCodeAt(0),o="Y".charCodeAt(0),a="s".charCodeAt(0);let i;function l(e){let t=-1;i||(i=function(){const e=new Int32Array(256);for(let t=0;t<256;t++){let n=t;for(let e=0;e<8;e++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n}return e}());for(let n=0;n<e.length;n++)t=i[255&(t^e[n])]^t>>>8;return~t}function s(e,t,i=!1){const s=new Uint8Array(13);t*=39.3701,s[0]=n,s[1]=r,s[2]=o,s[3]=a,s[4]=t>>>24,s[5]=t>>>16,s[6]=t>>>8,s[7]=255&t,s[8]=s[4],s[9]=s[5],s[10]=s[6],s[11]=s[7],s[12]=1;const c=l(s),u=new Uint8Array(4);if(u[0]=c>>>24,u[1]=c>>>16,u[2]=c>>>8,u[3]=255&c,i){const t=function(e){for(let t=e.length-1;t>=4;t--)if(9===e[t-4]&&e[t-3]===n&&e[t-2]===r&&e[t-1]===o&&e[t]===a)return t-3;return 0}(e);return e.set(s,t),e.set(u,t+13),e}{const t=new Uint8Array(4);t[0]=0,t[1]=0,t[2]=0,t[3]=9;const n=new Uint8Array(54);return n.set(e,0),n.set(t,33),n.set(s,37),n.set(u,50),n}}const c="[modern-screenshot]",u="undefined"!=typeof window,d=u&&"Worker"in window,f=u&&"atob"in window,g=u&&"btoa"in window,m=u?null==(e=window.navigator)?void 0:e.userAgent:"",h=m.includes("Chrome"),w=m.includes("AppleWebKit")&&!h,p=m.includes("Firefox"),y=e=>1===e.nodeType,v=e=>"object"==typeof e.className,b=e=>"image"===e.tagName,S=e=>y(e)&&void 0!==e.style&&!v(e),E=e=>8===e.nodeType,A=e=>"IMG"===e.tagName,x=e=>"VIDEO"===e.tagName,C=e=>"SLOT"===e.tagName;function N(e){var t;const n=null==(t=null==e?void 0:e.createElement)?void 0:t.call(e,"canvas");return n&&(n.height=n.width=1),Boolean(n)&&"toDataURL"in n&&Boolean(n.toDataURL("image/webp").includes("image/webp"))}const D=e=>e.startsWith("data:");function k(e,t){if(e.match(/^[a-z]+:\/\//i))return e;if(u&&e.match(/^\/\//))return window.location.protocol+e;if(e.match(/^[a-z]+:/i))return e;if(!u)return e;const n=T().implementation.createHTMLDocument(),r=n.createElement("base"),o=n.createElement("a");return n.head.appendChild(r),n.body.appendChild(o),t&&(r.href=t),o.href=e,o.href}function T(e){return(e&&y(e)?null==e?void 0:e.ownerDocument:e)??window.document}const $="http://www.w3.org/2000/svg";async function F(e,t="image/png",n=1){try{return await new Promise(((r,o)=>{e.toBlob((e=>{e?r(e):o(new Error("Blob is null"))}),t,n)}))}catch(r){if(f)return function(e){var t;const[n,r]=e.split(","),o=(null==(t=n.match(/data:(.+);/))?void 0:t[1])??void 0,a=window.atob(r),i=a.length,l=new Uint8Array(i);for(let s=0;s<i;s+=1)l[s]=a.charCodeAt(s);return new Blob([l],{type:o})}(e.toDataURL(t,n));throw r}}function I(e,t){return new Promise(((n,r)=>{const o=new FileReader;o.onload=()=>n(o.result),o.onerror=()=>r(o.error),o.onabort=()=>r(new Error(`Failed read blob to ${t}`)),"dataUrl"===t?o.readAsDataURL(e):"arrayBuffer"===t&&o.readAsArrayBuffer(e)}))}const P=e=>I(e,"dataUrl");function R(e,t){const n=T(t).createElement("img");return n.decoding="sync",n.loading="eager",n.src=e,n}function B(e,t){return new Promise((n=>{const{timeout:r,ownerDocument:o,onError:a,onWarn:i}=t??{},l="string"==typeof e?R(e,T(o)):e;let s=null,c=null;function u(){n(l),s&&clearTimeout(s),null==c||c()}if(r&&(s=setTimeout(u,r)),x(l)){const e=l.currentSrc||l.src;if(!e)return l.poster?B(l.poster,t).then(n):u();if(l.readyState>=2)return u();const r=u,o=t=>{null==i||i("Failed video load",e,t),null==a||a(t),u()};c=()=>{l.removeEventListener("loadeddata",r),l.removeEventListener("error",o)},l.addEventListener("loadeddata",r,{once:!0}),l.addEventListener("error",o,{once:!0})}else{const e=b(l)?l.href.baseVal:l.currentSrc||l.src;if(!e)return u();const t=async()=>{if(A(l)&&"decode"in l)try{await l.decode()}catch(t){null==i||i("Failed to decode image, trying to render anyway",l.dataset.originalSrc||e,t)}u()},n=t=>{null==i||i("Failed image load",l.dataset.originalSrc||e,t),u()};if(A(l)&&l.complete)return t();c=()=>{l.removeEventListener("load",t),l.removeEventListener("error",n)},l.addEventListener("load",t,{once:!0}),l.addEventListener("error",n,{once:!0})}}))}async function _(e,t){S(e)&&(A(e)||x(e)?await B(e,t):await Promise.all(["img","video"].flatMap((n=>Array.from(e.querySelectorAll(n)).map((e=>B(e,t)))))))}const U=function(){let e=0;return()=>(e+=1,`u${`0000${(Math.random()*36**4|0).toString(36)}`.slice(-4)}${e}`)}();function L(e){return null==e?void 0:e.split(",").map((e=>e.trim().replace(/"|'/g,"").toLowerCase())).filter(Boolean)}let M=0;function W(e){const t=`${c}[#${M}]`;return M++,{time:n=>e&&console.time(`${t} ${n}`),timeEnd:n=>e&&console.timeEnd(`${t} ${n}`),warn:(...t)=>e&&((...e)=>console.warn(c,...e))(...t)}}async function j(e,t){return(n=e)&&"__CONTEXT__"in n?e:q(e,{...t,autoDestruct:!0});var n}async function q(e,t){var n,r;const{scale:o=1,workerUrl:a,workerNumber:i=1}=t||{},l=Boolean(null==t?void 0:t.debug),s=(null==t?void 0:t.features)??!0,c=e.ownerDocument??(u?window.document:void 0),f=(null==(n=e.ownerDocument)?void 0:n.defaultView)??(u?window:void 0),g=new Map,m={width:0,height:0,quality:1,type:"image/png",scale:o,backgroundColor:null,style:null,filter:null,maximumCanvasSize:0,timeout:3e4,progress:null,debug:l,fetch:{requestInit:(h=null==(r=null==t?void 0:t.fetch)?void 0:r.bypassingCache,{cache:h?"no-cache":"force-cache"}),placeholderImage:"data:image/png;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",bypassingCache:!1,...null==t?void 0:t.fetch},fetchFn:null,font:{},drawImageInterval:100,workerUrl:null,workerNumber:i,onCloneNode:null,onEmbedNode:null,onCreateForeignObjectSvg:null,includeStyleProperties:null,autoDestruct:!1,...t,__CONTEXT__:!0,log:W(l),node:e,ownerDocument:c,ownerWindow:f,dpi:1===o?null:96*o,svgStyleElement:O(c),svgDefsElement:null==c?void 0:c.createElementNS($,"defs"),svgStyles:new Map,defaultComputedStyles:new Map,workers:[...Array.from({length:d&&a&&i?i:0})].map((()=>{try{const e=new Worker(a);return e.onmessage=async e=>{var t,n,r,o;const{url:a,result:i}=e.data;i?null==(n=null==(t=g.get(a))?void 0:t.resolve)||n.call(t,i):null==(o=null==(r=g.get(a))?void 0:r.reject)||o.call(r,new Error(`Error receiving message from worker: ${a}`))},e.onmessageerror=e=>{var t,n;const{url:r}=e.data;null==(n=null==(t=g.get(r))?void 0:t.reject)||n.call(t,new Error(`Error receiving message from worker: ${r}`))},e}catch(e){return m.log.warn("Failed to new Worker",e),null}})).filter(Boolean),fontFamilies:new Map,fontCssTexts:new Map,acceptOfImage:`${[N(c)&&"image/webp","image/svg+xml","image/*","*/*"].filter(Boolean).join(",")};q=0.8`,requests:g,drawImageCount:0,tasks:[],features:s,isEnable:e=>"restoreScrollPosition"===e?"boolean"!=typeof s&&(s[e]??!1):"boolean"==typeof s?s:s[e]??!0,shadowRoots:[]};var h;m.log.time("wait until load"),await _(e,{timeout:m.timeout,onWarn:m.log.warn}),m.log.timeEnd("wait until load");const{width:w,height:p}=function(e,t){let{width:n,height:r}=t;if(y(e)&&(!n||!r)){const t=e.getBoundingClientRect();n=n||t.width||Number(e.getAttribute("width"))||0,r=r||t.height||Number(e.getAttribute("height"))||0}return{width:n,height:r}}(e,m);return m.width=w,m.height=p,m}function O(e){if(!e)return;const t=e.createElement("style"),n=t.ownerDocument.createTextNode("\n.______background-clip--text {\n  background-clip: text;\n  -webkit-background-clip: text;\n}\n");return t.appendChild(n),t}async function z(e,t){const{log:n,timeout:r,drawImageCount:o,drawImageInterval:a}=t;n.time("image to canvas");const i=await B(e,{timeout:r,onWarn:t.log.warn}),{canvas:l,context2d:s}=function(e,t){const{width:n,height:r,scale:o,backgroundColor:a,maximumCanvasSize:i}=t,l=e.createElement("canvas");l.width=Math.floor(n*o),l.height=Math.floor(r*o),l.style.width=`${n}px`,l.style.height=`${r}px`,i&&(l.width>i||l.height>i)&&(l.width>i&&l.height>i?l.width>l.height?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i):l.width>i?(l.height*=i/l.width,l.width=i):(l.width*=i/l.height,l.height=i));const s=l.getContext("2d");s&&a&&(s.fillStyle=a,s.fillRect(0,0,l.width,l.height));return{canvas:l,context2d:s}}(e.ownerDocument,t),c=()=>{try{null==s||s.drawImage(i,0,0,l.width,l.height)}catch(e){t.log.warn("Failed to drawImage",e)}};if(c(),t.isEnable("fixSvgXmlDecode"))for(let u=0;u<o;u++)await new Promise((e=>{setTimeout((()=>{c(),e()}),u+a)}));return t.drawImageCount=0,n.timeEnd("image to canvas"),l}function V(e,t){if(e.ownerDocument)try{const t=e.toDataURL();if("data:,"!==t)return R(t,e.ownerDocument)}catch(a){t.log.warn("Failed to clone canvas",a)}const n=e.cloneNode(!1),r=e.getContext("2d"),o=n.getContext("2d");try{return r&&o&&o.putImageData(r.getImageData(0,0,e.width,e.height),0,0),n}catch(a){t.log.warn("Failed to clone canvas",a)}return n}function H(e,t){return(e=>"CANVAS"===e.tagName)(e)?V(e,t):(e=>"IFRAME"===e.tagName)(e)?function(e,t){var n;try{if(null==(n=null==e?void 0:e.contentDocument)?void 0:n.body)return re(e.contentDocument.body,t)}catch(r){t.log.warn("Failed to clone iframe",r)}return e.cloneNode(!1)}(e,t):A(e)?function(e){const t=e.cloneNode(!1);return e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),"lazy"===t.loading&&(t.loading="eager"),t}(e):x(e)?async function(e,t){if(e.ownerDocument&&!e.currentSrc&&e.poster)return R(e.poster,e.ownerDocument);const n=e.cloneNode(!1);n.crossOrigin="anonymous",e.currentSrc&&e.currentSrc!==e.src&&(n.src=e.currentSrc);const r=n.ownerDocument;if(r){let a=!0;if(await B(n,{onError:()=>a=!1,onWarn:t.log.warn}),!a)return e.poster?R(e.poster,e.ownerDocument):n;n.currentTime=e.currentTime,await new Promise((e=>{n.addEventListener("seeked",e,{once:!0})}));const i=r.createElement("canvas");i.width=e.offsetWidth,i.height=e.offsetHeight;try{const e=i.getContext("2d");e&&e.drawImage(n,0,0,i.width,i.height)}catch(o){return t.log.warn("Failed to clone video",o),e.poster?R(e.poster,e.ownerDocument):n}return V(i,t)}return n}(e,t):e.cloneNode(!1)}const X=["width","height","-webkit-text-fill-color"],Y=["stroke","fill"];function G(e,t,n){const{defaultComputedStyles:r}=n,o=e.nodeName.toLowerCase(),a=v(e)&&"svg"!==o,i=a?Y.map((t=>[t,e.getAttribute(t)])).filter((([,e])=>null!==e)):[],l=[a&&"svg",o,i.map(((e,t)=>`${e}=${t}`)).join(","),t].filter(Boolean).join(":");if(r.has(l))return r.get(l);const s=function(e){let t=e.sandbox;if(!t){const{ownerDocument:r}=e;try{r&&(t=r.createElement("iframe"),t.id=`__SANDBOX__${U()}`,t.width="0",t.height="0",t.style.visibility="hidden",t.style.position="fixed",r.body.appendChild(t),t.srcdoc='<!DOCTYPE html><meta charset="UTF-8"><title></title><body>',e.sandbox=t)}catch(n){e.log.warn("Failed to getSandBox",n)}}return t}(n),c=null==s?void 0:s.contentWindow;if(!c)return new Map;const u=null==c?void 0:c.document;let d,f;a?(d=u.createElementNS($,"svg"),f=d.ownerDocument.createElementNS(d.namespaceURI,o),i.forEach((([e,t])=>{f.setAttributeNS(null,e,t)})),d.appendChild(f)):d=f=u.createElement(o),f.textContent=" ",u.body.appendChild(d);const g=c.getComputedStyle(f,t),m=new Map;for(let h=g.length,w=0;w<h;w++){const e=g.item(w);X.includes(e)||m.set(e,g.getPropertyValue(e))}return u.body.removeChild(d),r.set(l,m),m}function J(e,t,n){var r;const o=new Map,a=[],i=new Map;if(n)for(const s of n)l(s);else for(let s=e.length,c=0;c<s;c++){l(e.item(c))}for(let s=a.length,c=0;c<s;c++)null==(r=i.get(a[c]))||r.forEach(((e,t)=>o.set(t,e)));function l(n){const r=e.getPropertyValue(n),l=e.getPropertyPriority(n),s=n.lastIndexOf("-"),c=s>-1?n.substring(0,s):void 0;if(c){let e=i.get(c);e||(e=new Map,i.set(c,e)),e.set(n,[r,l])}(t.get(n)!==r||l)&&(c?a.push(c):o.set(n,[r,l]))}return o}const K=[":before",":after"],Q=[":-webkit-scrollbar",":-webkit-scrollbar-button",":-webkit-scrollbar-thumb",":-webkit-scrollbar-track",":-webkit-scrollbar-track-piece",":-webkit-scrollbar-corner",":-webkit-resizer"];const Z=new Set(["symbol"]);async function ee(e,t,n,r,o){if(y(n)&&((e=>"STYLE"===e.tagName)(n)||(e=>"SCRIPT"===e.tagName)(n)))return;if(r.filter&&!r.filter(n))return;Z.has(t.nodeName)||Z.has(n.nodeName)?r.currentParentNodeStyle=void 0:r.currentParentNodeStyle=r.currentNodeStyle;const a=await re(n,r,!1,o);r.isEnable("restoreScrollPosition")&&function(e,t){if(!S(e)||!S(t))return;const{scrollTop:n,scrollLeft:r}=e;if(!n&&!r)return;const{transform:o}=t.style,a=new DOMMatrix(o),{a:i,b:l,c:s,d:c}=a;a.a=1,a.b=0,a.c=0,a.d=1,a.translateSelf(-r,-n),a.a=i,a.b=l,a.c=s,a.d=c,t.style.transform=a.toString()}(e,a),t.appendChild(a)}async function te(e,t,n,r){var o;let a=e.firstChild;y(e)&&e.shadowRoot&&(a=null==(o=e.shadowRoot)?void 0:o.firstChild,n.shadowRoots.push(e.shadowRoot));for(let i=a;i;i=i.nextSibling)if(!E(i))if(y(i)&&C(i)&&"function"==typeof i.assignedNodes){const o=i.assignedNodes();for(let a=0;a<o.length;a++)await ee(e,t,o[a],n,r)}else await ee(e,t,i,n,r)}const ne=/^[\w-:]+$/;async function re(e,t,n=!1,r){var o,a,i,l;const{ownerDocument:s,ownerWindow:c,fontFamilies:u}=t;if(s&&(e=>3===e.nodeType)(e))return r&&/\S/.test(e.data)&&r(e.data),s.createTextNode(e.data);if(s&&c&&y(e)&&(S(e)||v(e))){const r=await H(e,t);if(t.isEnable("removeAbnormalAttributes")){const e=r.getAttributeNames();for(let t=e.length,n=0;n<t;n++){const t=e[n];ne.test(t)||r.removeAttribute(t)}}const s=t.currentNodeStyle=function(e,t,n,r){var o,a,i,l;const{ownerWindow:s,includeStyleProperties:c,currentParentNodeStyle:u}=r,d=t.style,f=s.getComputedStyle(e),g=G(e,null,r);null==u||u.forEach(((e,t)=>{g.delete(t)}));const m=J(f,g,c);m.delete("transition-property"),m.delete("all"),m.delete("d"),m.delete("content"),n&&(m.delete("margin-top"),m.delete("margin-right"),m.delete("margin-bottom"),m.delete("margin-left"),m.delete("margin-block-start"),m.delete("margin-block-end"),m.delete("margin-inline-start"),m.delete("margin-inline-end"),m.set("box-sizing",["border-box",""])),"text"===(null==(o=m.get("background-clip"))?void 0:o[0])&&t.classList.add("______background-clip--text"),h&&(m.has("font-kerning")||m.set("font-kerning",["normal",""]),"hidden"!==(null==(a=m.get("overflow-x"))?void 0:a[0])&&"hidden"!==(null==(i=m.get("overflow-y"))?void 0:i[0])||"ellipsis"!==(null==(l=m.get("text-overflow"))?void 0:l[0])||e.scrollWidth!==e.clientWidth||m.set("text-overflow",["clip",""]));for(let h=d.length,w=0;w<h;w++)d.removeProperty(d.item(w));return m.forEach((([e,t],n)=>{d.setProperty(n,e,t)})),m}(e,r,n,t);n&&function(e,t){const{backgroundColor:n,width:r,height:o,style:a}=t,i=e.style;if(n&&i.setProperty("background-color",n,"important"),r&&i.setProperty("width",`${r}px`,"important"),o&&i.setProperty("height",`${o}px`,"important"),a)for(const l in a)i[l]=a[l]}(r,t);let c=!1;if(t.isEnable("copyScrollbar")){const t=[null==(o=s.get("overflow-x"))?void 0:o[0],null==(a=s.get("overflow-y"))?void 0:a[0]];c=t.includes("scroll")||(t.includes("auto")||t.includes("overlay"))&&(e.scrollHeight>e.clientHeight||e.scrollWidth>e.clientWidth)}const d=null==(i=s.get("text-transform"))?void 0:i[0],f=L(null==(l=s.get("font-family"))?void 0:l[0]),g=f?e=>{"uppercase"===d?e=e.toUpperCase():"lowercase"===d?e=e.toLowerCase():"capitalize"===d&&(e=e[0].toUpperCase()+e.substring(1)),f.forEach((t=>{let n=u.get(t);n||u.set(t,n=new Set),e.split("").forEach((e=>n.add(e)))}))}:void 0;return function(e,t,n,r,o){const{ownerWindow:a,svgStyleElement:i,svgStyles:l,currentNodeStyle:s}=r;function c(n){var i;const c=a.getComputedStyle(e,n);let u=c.getPropertyValue("content");if(!u||"none"===u)return;null==o||o(u),u=u.replace(/(')|(")|(counter\(.+\))/g,"");const d=[U()],f=G(e,n,r);null==s||s.forEach(((e,t)=>{f.delete(t)}));const g=J(c,f,r.includeStyleProperties);g.delete("content"),g.delete("-webkit-locale"),"text"===(null==(i=g.get("background-clip"))?void 0:i[0])&&t.classList.add("______background-clip--text");const m=[`content: '${u}';`];if(g.forEach((([e,t],n)=>{m.push(`${n}: ${e}${t?" !important":""};`)})),1===m.length)return;try{t.className=[t.className,...d].join(" ")}catch(p){return void r.log.warn("Failed to copyPseudoClass",p)}const h=m.join("\n  ");let w=l.get(h);w||(w=[],l.set(h,w)),w.push(`.${d[0]}:${n}`)}i&&a&&(K.forEach(c),n&&Q.forEach(c))}(e,r,c,t,g),function(e,t){((e=>"TEXTAREA"===e.tagName)(e)||(e=>"INPUT"===e.tagName)(e)||(e=>"SELECT"===e.tagName)(e))&&t.setAttribute("value",e.value)}(e,r),x(e)||await te(e,r,t,g),r}const d=e.cloneNode(!1);return await te(e,d,t),d}function oe(e){if(e.ownerDocument=void 0,e.ownerWindow=void 0,e.svgStyleElement=void 0,e.svgDefsElement=void 0,e.svgStyles.clear(),e.defaultComputedStyles.clear(),e.sandbox){try{e.sandbox.remove()}catch(t){e.log.warn("Failed to destroyContext",t)}e.sandbox=void 0}e.workers=[],e.fontFamilies.clear(),e.fontCssTexts.clear(),e.requests.clear(),e.tasks=[],e.shadowRoots=[]}function ae(e,t){const{url:n,requestType:r="text",responseType:o="text",imageDom:a}=t;let i=n;const{timeout:l,acceptOfImage:s,requests:c,fetchFn:u,fetch:{requestInit:d,bypassingCache:f,placeholderImage:g},font:m,workers:h,fontFamilies:y}=e;"image"===r&&(w||p)&&e.drawImageCount++;let v=c.get(n);if(!v){f&&f instanceof RegExp&&f.test(i)&&(i+=(/\?/.test(i)?"&":"?")+(new Date).getTime());const t=r.startsWith("font")&&m&&m.minify,p=new Set;if(t){r.split(";")[1].split(",").forEach((e=>{y.has(e)&&y.get(e).forEach((e=>p.add(e)))}))}const b=t&&p.size,S={url:i,timeout:l,responseType:b?"arrayBuffer":o,headers:"image"===r?{accept:s}:void 0,...d};v={type:r,resolve:void 0,reject:void 0,response:null},v.response=(async()=>{if(u&&"image"===r){const e=await u(n);if(e)return e}return!w&&n.startsWith("http")&&h.length?new Promise(((e,t)=>{h[c.size&h.length-1].postMessage({rawUrl:n,...S}),v.resolve=e,v.reject=t})):function(e){const{url:t,timeout:n,responseType:r,...o}=e,a=new AbortController,i=n?setTimeout((()=>a.abort()),n):void 0;return fetch(t,{signal:a.signal,...o}).then((e=>{if(!e.ok)throw new Error("Failed fetch, not 2xx response",{cause:e});switch(r){case"arrayBuffer":return e.arrayBuffer();case"dataUrl":return e.blob().then(P);default:return e.text()}})).finally((()=>clearTimeout(i)))}(S)})().catch((t=>{if(c.delete(n),"image"===r&&g)return e.log.warn("Failed to fetch image base64, trying to use placeholder image",i),"string"==typeof g?g:g(a);throw t})),c.set(n,v)}return v.response}async function ie(e,t,n,r){if(!le(e))return e;for(const[a,i]of function(e,t){const n=[];return e.replace(se,((e,r,o)=>(n.push([o,k(o,t)]),e))),n.filter((([e])=>!D(e)))}(e,t))try{const t=await ae(n,{url:i,requestType:r?"image":"text",responseType:"dataUrl"});e=e.replace(ce(a),`$1${t}$3`)}catch(o){n.log.warn("Failed to fetch css data url",a,o)}return e}function le(e){return/url\((['"]?)([^'"]+?)\1\)/.test(e)}const se=/url\((['"]?)([^'"]+?)\1\)/g;function ce(e){const t=e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1");return new RegExp(`(url\\(['"]?)(${t})(['"]?\\))`,"g")}const ue=["background-image","border-image-source","-webkit-border-image","-webkit-mask-image","list-style-image"];function de(e,t){const{tasks:n}=t;y(e)&&((A(e)||b(e))&&n.push(...function(e,t){if(A(e)){const n=e.currentSrc||e.src;if(!D(n))return[ae(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then((t=>{t&&(e.srcset="",e.dataset.originalSrc=n,e.src=t||"")}))];(w||p)&&t.drawImageCount++}else if(v(e)&&!D(e.href.baseVal)){const n=e.href.baseVal;return[ae(t,{url:n,imageDom:e,requestType:"image",responseType:"dataUrl"}).then((t=>{t&&(e.dataset.originalSrc=n,e.href.baseVal=t||"")}))]}return[]}(e,t)),"use"===e.tagName&&n.push(...function(e,t){const{ownerDocument:n,svgDefsElement:r}=t,o=e.getAttribute("href")??e.getAttribute("xlink:href");if(!o)return[];const[a,i]=o.split("#");if(i){const o=`#${i}`,l=t.shadowRoots.reduce(((e,t)=>e??t.querySelector(`svg ${o}`)),null==n?void 0:n.querySelector(`svg ${o}`));if(a&&e.setAttribute("href",o),null==r?void 0:r.querySelector(o))return[];if(l)return null==r||r.appendChild(l.cloneNode(!0)),[];if(a)return[ae(t,{url:a,responseType:"text"}).then((e=>{null==r||r.insertAdjacentHTML("beforeend",e)}))]}return[]}(e,t))),S(e)&&n.push(...function(e,t){return ue.map((n=>{const r=e.getPropertyValue(n);return r&&"none"!==r?((w||p)&&t.drawImageCount++,ie(r,null,t,!0).then((t=>{t&&r!==t&&e.setProperty(n,t,e.getPropertyPriority(n))}))):null})).filter(Boolean)}(e.style,t)),e.childNodes.forEach((e=>{de(e,t)}))}async function fe(e,t){const{ownerDocument:n,svgStyleElement:r,fontFamilies:o,fontCssTexts:a,tasks:i,font:l}=t;if(n&&r&&o.size)if(l&&l.cssText){const e=pe(l.cssText,t);r.appendChild(n.createTextNode(`${e}\n`))}else{const e=Array.from(n.styleSheets).filter((e=>{try{return"cssRules"in e&&Boolean(e.cssRules.length)}catch(n){return t.log.warn(`Error while reading CSS rules from ${e.href}`,n),!1}}));await Promise.all(e.flatMap((e=>Array.from(e.cssRules).map((async(n,r)=>{if("CSSImportRule"===n.constructor.name){let a=r+1;const i=n.href;let l="";try{l=await ae(t,{url:i,requestType:"text",responseType:"text"})}catch(o){t.log.warn(`Error fetch remote css import from ${i}`,o)}const s=l.replace(se,((e,t,n)=>e.replace(n,k(n,i))));for(const n of function(e){if(null==e)return[];const t=[];let n=e.replace(ge,"");for(;;){const e=me.exec(n);if(!e)break;t.push(e[0])}n=n.replace(me,"");const r=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi,o=new RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");for(;;){let e=r.exec(n);if(e)o.lastIndex=r.lastIndex;else{if(e=o.exec(n),!e)break;r.lastIndex=o.lastIndex}t.push(e[0])}return t}(s))try{e.insertRule(n,n.startsWith("@import")?a+=1:e.cssRules.length)}catch(o){t.log.warn("Error inserting rule from remote css import",{rule:n,error:o})}}})))));e.flatMap((e=>Array.from(e.cssRules))).filter((e=>{var t;return"CSSFontFaceRule"===e.constructor.name&&le(e.style.getPropertyValue("src"))&&(null==(t=L(e.style.getPropertyValue("font-family")))?void 0:t.some((e=>o.has(e))))})).forEach((e=>{const o=e,l=a.get(o.cssText);l?r.appendChild(n.createTextNode(`${l}\n`)):i.push(ie(o.cssText,o.parentStyleSheet?o.parentStyleSheet.href:null,t).then((e=>{e=pe(e,t),a.set(o.cssText,e),r.appendChild(n.createTextNode(`${e}\n`))})))}))}}const ge=/(\/\*[\s\S]*?\*\/)/g,me=/((@.*?keyframes [\s\S]*?){([\s\S]*?}\s*?)})/gi;const he=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,we=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function pe(e,t){const{font:n}=t,r=n?null==n?void 0:n.preferredFormat:void 0;return r?e.replace(we,(e=>{for(;;){const[t,,n]=he.exec(e)||[];if(!n)return"";if(n===r)return`src: ${t};`}})):e}async function ye(e,t){const n=await j(e,t);if(y(n.node)&&v(n.node))return n.node;const{ownerDocument:r,log:o,tasks:a,svgStyleElement:i,svgDefsElement:l,svgStyles:s,font:c,progress:u,autoDestruct:d,onCloneNode:f,onEmbedNode:g,onCreateForeignObjectSvg:m}=n;o.time("clone node");const h=await re(n.node,n,!0);if(i&&r){let e="";s.forEach(((t,n)=>{e+=`${t.join(",\n")} {\n  ${n}\n}\n`})),i.appendChild(r.createTextNode(e))}o.timeEnd("clone node"),await(null==f?void 0:f(h)),!1!==c&&y(h)&&(o.time("embed web font"),await fe(0,n),o.timeEnd("embed web font")),o.time("embed node"),de(h,n);const w=a.length;let p=0;null==u||u(p,w),await Promise.all([...Array.from({length:4})].map((async()=>{for(;;){const t=a.pop();if(!t)break;try{await t}catch(e){n.log.warn("Failed to run task",e)}null==u||u(++p,w)}}))),o.timeEnd("embed node"),await(null==g?void 0:g(h));const b=function(e,t){const{width:n,height:r}=t,o=function(e,t,n){const r=T(n).createElementNS($,"svg");return r.setAttributeNS(null,"width",e.toString()),r.setAttributeNS(null,"height",t.toString()),r.setAttributeNS(null,"viewBox",`0 0 ${e} ${t}`),r}(n,r,e.ownerDocument),a=o.ownerDocument.createElementNS(o.namespaceURI,"foreignObject");return a.setAttributeNS(null,"x","0%"),a.setAttributeNS(null,"y","0%"),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.append(e),o.appendChild(a),o}(h,n);return l&&b.insertBefore(l,b.children[0]),i&&b.insertBefore(i,b.children[0]),d&&oe(n),await(null==m?void 0:m(b)),b}async function ve(e,t){var n;const r=await j(e,t),o=await ye(r),a=function(e,t){let n=(new XMLSerializer).serializeToString(e);return t&&(n=n.replace(/[\u0000-\u0008\v\f\u000E-\u001F\uD800-\uDFFF\uFFFE\uFFFF]/gu,"")),`data:image/svg+xml;charset=utf-8,${encodeURIComponent(n)}`}(o,r.isEnable("removeControlCharacter"));r.autoDestruct||(r.svgStyleElement=O(r.ownerDocument),r.svgDefsElement=null==(n=r.ownerDocument)?void 0:n.createElementNS($,"defs"),r.svgStyles.clear());const i=R(a,o.ownerDocument);return await z(i,r)}async function be(e,n){const r=await j(e,n),{log:o,type:a,quality:i,dpi:l}=r,c=await ve(r);o.time("canvas to blob");const u=await F(c,a,i);if(["image/png","image/jpeg"].includes(a)&&l){const e=await(e=>I(e,"arrayBuffer"))(u.slice(0,33));let n=new Uint8Array(e);return"image/png"===a?n=s(n,l):"image/jpeg"===a&&(n=t(n,l)),o.timeEnd("canvas to blob"),new Blob([n,u.slice(33)],{type:a})}return o.timeEnd("canvas to blob"),u}async function Se(e,n){const r=await j(e,n),{log:o,quality:a,type:i,dpi:l}=r,c=await ve(r);o.time("canvas to data url");let u=c.toDataURL(i,a);if(["image/png","image/jpeg"].includes(i)&&l&&f&&g){const[e,n]=u.split(",");let r=0,o=!1;if("image/png"===i){const e=function(e){let t=e.indexOf("AAlwSFlz");return-1===t&&(t=e.indexOf("AAAJcEhZ")),-1===t&&(t=e.indexOf("AAAACXBI")),t}(n);e>=0?(r=4*Math.ceil((e+28)/3),o=!0):r=44}else"image/jpeg"===i&&(r=24);const a=n.substring(0,r),c=n.substring(r),d=window.atob(a),f=new Uint8Array(d.length);for(let t=0;t<f.length;t++)f[t]=d.charCodeAt(t);const g="image/png"===i?s(f,l,o):t(f,l);u=[e,",",window.btoa(String.fromCharCode(...g)),c].join("")}return o.timeEnd("canvas to data url"),u}async function Ee(e,t){return Se(await j(e,{...t,type:"image/png"}))}export{q as createContext,oe as destroyContext,be as domToBlob,ve as domToCanvas,Se as domToDataUrl,ye as domToForeignObjectSvg,Ee as domToPng,B as loadMedia,_ as waitUntilLoad};
