const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./tool-k8sYaoBr.js","./index-5gyre0hA.js","./toolPaneView-BkZhzbTB.js","./baseTool-BM5mqL4_.js","./priceLabelPriceAxisView-CKrbEFjY.js","./timeLabelTimeAxisView-DLVMuesT.js","./composite-CCMtJLBO.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,r,i)=>((t,r,i)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[r]=i)(t,"symbol"!=typeof r?r+"":r,i);import{t as r,c as i,I as s,F as n,D as a,H as o,L as l,A as c,P as h,i as d,a as p,e as g,b as u,d as v,T as m,K as _,f as w,E as C,s as f,g as y,R as b,C as S,h as P,j as T,_ as M,k as x,l as A,m as D,n as I,o as E,p as j,q as O}from"./index-5gyre0hA.js";import{T as R,a as V,D as k}from"./toolPaneView-BkZhzbTB.js";import{C as K,a as L,L as B,b as N,F as z,P as q,M as F,S as W,A as $,i as H,c as J,d as X,m as Y,z as Z}from"./index-iNH1zFVl.js";import{r as G}from"./adjustValue-DAhiMl70.js";import"./baseTool-BM5mqL4_.js";var Q,U=(Q={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},function(e){return null==Q?void 0:Q[e]}),ee=/[&<>"']/g,te=RegExp(ee.source);function re(e){const t=i(e.properties());e.type===s&&Reflect.set(t,n,e.properties().image.name);const o=JSON.stringify({type:e.type,props:t}),l=(c=r(c=o))&&te.test(c)?c.replace(ee,U):c;var c;return`<span ${a}="${l}"> </span>`}class ie extends R{constructor(){super(...arguments),t(this,"_renderer",new o)}renderer(){return this._renderer}_updateImpl(){const e=this.points();e&&e.length?this._renderer.setData({lineWidth:1,lineStyle:l.solid,lineColor:"#999999",y:e[0].y}):this._renderer.setData(null)}}class se extends V{constructor(){super(...arguments),t(this,"_line",new ie(this,this.model)),t(this,"_paneView",[this._line])}pointsCount(){return 1}updateMove(e,t){super.updateMove(e,t),this._props.onChange({price:e.price})}updateAllViews(){if(!this.controlPoints.length)return;const[e]=this.controlPoints,t=this.pointToScreenPoint(e);t&&this._line.update({points:[new c(t)]})}}var ne=Object.getOwnPropertyDescriptor;let ae=class extends k{constructor(e){super(),t(this,"type",h),t(this,"previewBeforePlace",!0),t(this,"_drawingSessions",new Map),this.chartManagementService=e}createPrimitive(){return new se({id:this.id,points:[],onDone(){},onChange(){}},...this.resetArgs)}receiveProps(e){this._ensureDrawings(),this._drawingSessions.values().forEach((t=>{t.primitive.updateProps(e)}))}_onMouseMove(e){var t;const r=e.source.chartApi.getCrosshairPosition();(!d(r)||p(this._forcedPaneIndex)&&r.paneIndex&&r.paneIndex!==this._forcedPaneIndex||this._drawingSession&&p(this._forcedPaneIndex)&&r.paneIndex!==this._drawingSession.paneIndex)&&this._drawingSessions.values().forEach((e=>{var t,r;null==(r=null==(t=e.primitive)?void 0:t.updateMove)||r.call(t,{time:NaN,price:NaN},g(this._drawingSession).currentStep)})),this._ensureDrawings();const i=g(this._drawingSessions.get(e.source));i!==this._drawingSession&&(this._drawingSession&&this._leaveChart(this._drawingSession.chartService),this._enterChart(i.chartService),this._drawingSession=i);const s=g(null==(t=this._drawingSession)?void 0:t.getTargetSeries().coordinateToPrice(r.y));this._drawingSessions.values().forEach((e=>{var t,r;null==(r=(t=e.primitive).updateMove)||r.call(t,{time:0,price:s},g(this._drawingSession).currentStep)}))}_ensureDrawings(){this._drawingSessions.size||this.chartManagementService.getCharts().forEach((e=>{const t=this._startCreationOnChart(e,g(this._forcedPaneIndex),!0);this._drawingSessions.set(e,t);const r=this.doCreatePrimitive(t);t.startPreview(r)}))}_enterChart(e){e.chartApi.applyOptions({handleScale:!1,handleScroll:!1,crosshair:{horzLine:{visible:!1,labelVisible:!1},vertLine:{visible:!1,labelVisible:!1}}})}_leaveChart(e){e.chartApi.applyOptions({handleScale:!0,handleScroll:!0,crosshair:{horzLine:{visible:!0,labelVisible:!0},vertLine:{visible:!0,labelVisible:!0}}})}finishDrawing(){var e,t,r,i,s;const n=g(null==(e=this._drawingSession)?void 0:e.primitive),a={price:G(n.controlPoints[0].price,this.chartService.symbolInfo().minmov)};null==(r=null==(t=this._presetProps)?void 0:t.onChange)||r.call(t,a),null==(s=null==(i=this._presetProps)?void 0:i.onDone)||s.call(i,a),this._drawingSessions.values().forEach((e=>{e.chartService.getController().detachToolPrimitive(e.primitive)})),super.finishDrawing()}};var oe,le;ae=((e,t,r,i)=>{for(var s,n=i>1?void 0:i?ne(t,r):t,a=e.length-1;a>=0;a--)(s=e[a])&&(n=s(n)||n);return n})([(oe=0,le=u,(e,t)=>le(e,t,oe))],ae);const ce={type:h,icon:"",Ctor:()=>Promise.resolve(ae)};var he=Object.getOwnPropertyDescriptor,de=(e,t,r,i)=>{for(var s,n=i>1?void 0:i?he(t,r):t,a=e.length-1;a>=0;a--)(s=e[a])&&(n=s(n)||n);return n},pe=(e,t)=>(r,i)=>t(r,i,e);let ge=class extends v{constructor(e,t){super(),this._register(t.createInstance(ve)),this._register(t.createInstance(ue)),e.activeTool||e.switchTool(K,m.program)}};ge=de([pe(0,D),pe(1,A)],ge);let ue=class extends v{constructor(e,t,r,i,n){super(),this._register(i.registerCommandAndKeybindingRule({id:C,primary:w.Esc,weight:_.ChartContrib,when:()=>!!y(e.store).activeType,handler:()=>{var r,i;const s=t.activeChart(),n=s.getModel().currentActive;if(n){if(null==(r=n.isTool)?void 0:r.call(n)){f(n instanceof V);let t=!1;const r=n;if(s.getModel().currentCreating===n){r.abort()&&(s.getController().detachToolPrimitive(n),t=!0)}t||(s.getModel().blur(r),s.getModel().unhover(r)),n.type===(null==(i=e.activeTool)?void 0:i.type)&&y(e.store).keepDrawingMode?e.keepDrawingOrSwitchBack():e.switchBack()}}else e.switchBack()}})),this._register(i.registerCommandAndKeybindingRule({id:b,primary:w.Delete,secondary:[w.Backspace],weight:_.ChartContrib,when:()=>{var e;const r=t.activeChart().getModel().currentActive;return!!r&&!!(null==(e=r.isTool)?void 0:e.call(r))},handler:()=>{const e=t.activeChart(),r=g(e.getModel().currentActive);if(f(r instanceof V),!r.disableDelete)return e.getModel().currentCreating===r?n.executeCommand(C):void e.getController().detachToolPrimitive(r)}})),this._register(i.registerCommandAndKeybindingRule({id:S,primary:w.KeyC|P.CtrlCmd,weight:_.ChartContrib,when:()=>{const e=t.activeChart().getModel().currentActive;return!!e&&e instanceof V},handler:async()=>{const e=t.activeChart(),i=g(e.getModel().currentActive);f(i instanceof V);const n={html:re(i)};if(i.type===s){const e=i.properties().image;n.files=[e]}r.writeClipboard(n)}})),this._register(i.registerCommandAndKeybindingRule({id:T,primary:w.KeyD|P.CtrlCmd,weight:_.ChartContrib,when:()=>{const e=t.activeChart().getModel().currentActive;return!!e&&e instanceof V},handler:()=>{const e=t.activeChart(),r=g(e.getModel().currentActive);f(r instanceof V);const i={html:re(r)};if(r.type===s){const e=r.properties().image;i.files=[e]}e.getController().handlePaste(i)}}))}};ue=de([pe(0,D),pe(1,u),pe(2,I),pe(3,E),pe(4,j)],ue);let ve=class extends v{constructor(e){super(),this.toolRegistry=e;[L,B,N,z,q,F,W,$].forEach((({groups:e})=>{e.forEach((({items:e})=>{e.forEach((e=>{this.registerTool(e)}))}))})),this.registerTool(H),this.registerTool(J),this.registerTool({...X,type:x,Ctor:()=>M((()=>import("./tool-k8sYaoBr.js")),__vite__mapDeps([0,1,2,3,4,5,6]),import.meta.url).then((e=>e.PasteImageTool))}),this.registerTool(Y),this.registerTool(Z),this.registerTool(ce)}registerTool(e){return this.toolRegistry.registerTool({id:e.type,keybinding:e.keybinding,createTool:async t=>{const r=t.get(A),i=await g(e.Ctor)();return r.createInstance(i)}})}};ve=de([pe(0,O)],ve);export{ge as DrawingContrib,ue as DrawingKeybindingContrib,ve as DrawingRegistryContrib};
