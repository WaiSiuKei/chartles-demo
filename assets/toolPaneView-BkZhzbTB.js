var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{e as i,ax as r,z as s,s as n,ay as a,u as o,az as h,ag as c,aA as d,i as u,m as l,aB as p,a as g,O as v,aC as _,aD as m,aj as S,aE as w,aF as P}from"./index-5gyre0hA.js";import{B as x}from"./baseTool-BM5mqL4_.js";class C{constructor(e=void 0,i=void 0){t(this,"_chart"),t(this,"_series"),t(this,"_prevSeries"),t(this,"_isAttached",!1),t(this,"_requestUpdate"),t(this,"_fireDataUpdated",(e=>{this.dataUpdated&&this.dataUpdated(e)})),e&&(this._chart=e),i&&(this._series=i)}requestUpdate(){this.isAttached&&this._requestUpdate&&this._requestUpdate()}attached({chart:e,series:t,requestUpdate:i}){this._isAttached=!0,this._chart=e,this._series=t,this._series.subscribeDataChanged(this._fireDataUpdated),this._requestUpdate=i,this.requestUpdate()}attach(e){e.attachPrimitive(this)}reAttach(){i(this._prevSeries).attachPrimitive(this),this._prevSeries=void 0}detach(){var e;null==(e=this._series)||e.detachPrimitive(this)}detached(){var e;this._isAttached=!1,null==(e=this._series)||e.unsubscribeDataChanged(this._fireDataUpdated),this._prevSeries=this.series,this._chart=void 0,this._series=void 0,this._requestUpdate=void 0}get isAttached(){return this._isAttached}get chart(){return i(this._chart)}get series(){return i(this._series)}}var f=(e=>(e[e.None=0]="None",e[e.Remove=1]="Remove",e))(f||{});var A,T=((A=T||{})[A.Accept=1]="Accept",A[A.AcceptAndFinish=3]="AcceptAndFinish",A[A.Reject=8]="Reject",A);function b(e){return!!(1&e)}const D="#2A62FF",k="#FFFFFF",F="#2962FF33";var I=Object.defineProperty,M=Object.getOwnPropertyDescriptor;class O extends C{constructor(e,i,r,s,n,a){super(s,n),t(this,"disableDelete",!1),t(this,"disableUserSelection",!1),t(this,"disableToolbar",!1),t(this,"_paneView",[]),t(this,"_priceAxisPaneViews",[]),t(this,"_timeAxisPaneViews",[]),t(this,"_timeAxisViews",[]),t(this,"_priceAxisViews",[]),t(this,"disableExtendTime",!1),t(this,"_currentDragTarget",0),this._props=e,this.type=i,this._ctx=r,this.model=a}get id(){return this._props.id}get controlPoints(){return this._props.points}get isDrawing(){return this.model.currentCreating===this}isActive(){return this.model.currentActive===this}isCreationFinished(){return this.model.currentCreating!==this}properties(){return this._props}priceScale(){return this.series}timeScale(){return this.chart.timeScale()}getScope(){return{mediaSize:{width:this.chart.timeScale().width(),height:this.series.getPane().getHeight()}}}symbolInfo(){return this._ctx.chartService.symbolInfo()}timeSpanFormatter(){return this._ctx.timeSpanFormatter}get hitTestCollector(){return e=>{this._ctx.hitTestCollector(this.id,e)}}updateProps(e){r(this._props,e),this.updateAllViews(),this.requestUpdate()}updateActive(){this.updateAllViews(),this.requestUpdate()}updateHover(e){this.updateAllViews(),this.requestUpdate()}paneIndex(){return this.series.getPane().paneIndex()}isTool(){return!0}onDragStart(e){this._currentDragTarget=e.target,this._currentDragTarget===s.MovePoint&&this.startMoving(),this._currentDragTarget===s.ChangePoint&&(n(a(e.details)),this.startChanging(e.details.componentIndex))}onDragEnd(){this._currentDragTarget===s.MovePoint&&this.endMoving(),this._currentDragTarget===s.ChangePoint&&this.endChanging(),this._currentDragTarget=0}updateMove(e,t){this.addPoint({...e,isTempForPreview:!0},t),this.updateAllViews(),this.requestUpdate()}updateStroke(e){}startChanging(e){}endChanging(){}startMoving(){}move(){}endMoving(){}updateDrag(e,t,i,r,o,h,c,d,u){this._currentDragTarget=e;const l=r-i,p=h-o;switch(e){case s.MovePoint:this._props.points.forEach(((e,i)=>{t[i]&&(e.time=t[i].time+l,e.price=t[i].price+p)})),this.move();break;case s.ChangePoint:{n(a(d));const e=d.componentIndex;this.setPoint(e,{time:r,price:h},{shiftkey:u.shiftkey,startTime:i,endTime:r,get deltaTime(){return r-i},startPrice:o,endPrice:h,get deltaPrice(){return h-o},startPoint:t[e],screenPoint:c,startPoints:t,hitTestDetails:d});break}}this.updateAllViews(),this.requestUpdate()}setPoint(e,t,i){this.controlPoints[e]=t}addPoint(e,t){return this.controlPoints[t]=e,T.Accept}finish(){this.isAttached&&(this.updateAllViews(),this.requestUpdate())}abort(){return this.model.currentCreating===this&&this.model.markCreatingFinishedOrAborted(this),f.Remove}pointToScreenPoint(e){const t=e.time?this.chart.timeScale().timeToCoordinateEx(e.time):NaN;if(null===t)return null;const i=this.series.priceToCoordinate(e.price);return null===i?null:new o(t,i)}screenPointToPoint(e){return{time:i(this.chart.timeScale().coordinateToTimeEx(e.x)),price:i(this.series.coordinateToPrice(e.y))}}getIndex(e){return this.chart.timeScale().timeToIndexEx(e.time)}paneViews(){return this._paneView}timeAxisPaneViews(){return this._timeAxisPaneViews}priceAxisPaneViews(){return this._priceAxisPaneViews}timeAxisViews(){return this._timeAxisViews}priceAxisViews(){return this._priceAxisViews}asTextToolPrimitive(){}_calculateTimeAxisViewData(e,t,i){return{foreground:k,background:D,coordinate:t,text:this._ctx.dateTimeFormatter(e),visible:!h(e)&&this.isActive(),...i}}_calculatePriceAxisViewData(e,t,i){return{foreground:k,background:D,coordinate:t,text:this._ctx.priceLabelFormatter(e),visible:this.isActive(),...i}}_calculatePriceAxisPaneViewData(e,t){const i=this.series.priceScale().width();return{p0:e,p1:t,visible:this.isActive(),background:F,maxDimension:i}}_calculateTimeAxisPaneViewsData(e,t){const i=this.chart.timeScale().height();return{p0:e,p1:t,visible:this.isActive(),background:F,maxDimension:i}}}((e,t,i)=>{for(var r,s=M(t,i),n=e.length-1;n>=0;n--)(r=e[n])&&(s=r(t,i,s)||s);s&&I(t,i,s)})([c],O.prototype,"paneIndex");var V=Object.defineProperty,y=Object.getOwnPropertyDescriptor;class U{constructor(e,i,r=!1){t(this,"primitive"),t(this,"_clickCount",0),this.chartService=e,this.paneIndex=i,this.inPreview=r}get clickCount(){return this._clickCount}get currentStep(){return this._clickCount}getTargetSeries(){return 0===this.paneIndex?this.chartService.mainSeriesApi.getSeries():i(this.chartService.getPaneSeries(this.paneIndex))}startPreview(e){this.inPreview=!0,this.primitive=e,this.primitive.attach(this.getTargetSeries()),this.chartService.getModel().markCreatingStarted(e),this.chartService.getController().attachToolPrimitive(e,!1)}endPreview(){n(this.inPreview),this.inPreview=!1,this.chartService.getModel().focus(this.primitive,m.select)}startDrawing(e){this.primitive=e,this.primitive.attach(this.getTargetSeries()),this.chartService.getModel().markCreatingStarted(e),this.chartService.getController().attachToolPrimitive(e,!0)}onPoint(){this.chartService.getModel().markCreatingPoint(this._clickCount),this._clickCount++}finishDrawing(){this.chartService.getModel().markCreatingFinishedOrAborted(this.primitive),this.primitive.finish()}abortDrawing(){this.chartService.getModel().markCreatingFinishedOrAborted(this.primitive),this.primitive.abort(),this.chartService.getController().detachToolPrimitive(this.primitive)}detach(){this.chartService.getController().detachToolPrimitive(this.primitive)}dispose(){var e;const t=this.primitive;t&&(this.inPreview||!1!==(null==(e=t.isCreationFinished)?void 0:e.call(t)))&&this.chartService.getModel().currentCreating===t&&(this.chartService.getController().detachToolPrimitive(t),this.chartService.getModel().markCreatingFinishedOrAborted(this.primitive))}}((e,t,i)=>{for(var r,s=y(t,i),n=e.length-1;n>=0;n--)(r=e[n])&&(s=r(t,i,s)||s);s&&V(t,i,s)})([c],U.prototype,"getTargetSeries");class E extends x{constructor(){super(...arguments),t(this,"canGoBackward",!0),t(this,"disableExtendTime",!1),t(this,"previewBeforePlace",!1),t(this,"_drawingSession"),t(this,"_presetProps"),t(this,"_forcedPaneIndex")}get chartService(){var e;return i(null==(e=this._drawingSession)?void 0:e.chartService)}get presetProps(){return this._presetProps}get primitive(){var e;return i(null==(e=this._drawingSession)?void 0:e.primitive)}_startCreationOnChart(e,t,i,r=!0){var s;if(e===(null==(s=this._drawingSession)?void 0:s.chartService)){if(r)return this._drawingSession;this._drawingSession.finishDrawing()}return this._drawingSession=new U(e,t,i),this._drawingSession}processEvent(e){var t,r;switch(e.type){case d.CLICK:{const s=i(e.asChartInputEvent());if(!s.point)return;const a=s.source.chartApi.getCrosshairPosition();if(!u(a))return;if(this.onlyDrawingOnMainSeries()&&0!==a.paneIndex)return void e.source.invokeWithinContext((e=>{e.get(l).keepDrawingOrSwitchBack()}));if(this._drawingSession&&(this._drawingSession.chartService!==s.source||this._drawingSession.paneIndex!==a.paneIndex))return this._drawingSession.abortDrawing(),void(r=this._drawingSession,r.chartService.invokeWithinContext((e=>e.get(l)))).keepDrawingOrSwitchBack();const o=i(s.paneIndex);this._drawingSession||this._startCreationOnChart(s.source,o,!1);const h=p(this.chartService,a.x,{useExtended:!this.disableExtendTime}),c=i(null==(t=this._drawingSession)?void 0:t.getTargetSeries().coordinateToPrice(a.y));n(g(h)),e.accept(),this._addPoint({time:h,price:c});break}case d.MOUSE_MOVE:{const t=e.asChartInputEvent();t&&this._onMouseMove(t);break}}}_stepCount(){var e;return(null==(e=this._drawingSession)?void 0:e.primitive.pointsCount())??1}_addPoint(e){let t;if(n(this._drawingSession),0===this._drawingSession.clickCount)this.previewBeforePlace?(n(this._drawingSession.primitive),this._drawingSession.endPreview()):this._drawingSession.startDrawing(this.doCreatePrimitive(this._drawingSession)),t=this.primitive.addPoint(e,this._drawingSession.currentStep);else if(t=this.primitive.addPoint(e,this._drawingSession.currentStep),t===T.Reject)return;this._drawingSession.onPoint();(this._drawingSession.clickCount===this._stepCount()||t===T.AcceptAndFinish)&&(this.finishDrawing(),this.chartService.invokeWithinContext((e=>{e.get(l).keepDrawingOrSwitchBack()})))}_onMouseMove(e){var t,r,s,n,a,o,h,c;if(this.previewBeforePlace){const a=e.source.chartApi.getCrosshairPosition();if(!u(a)||g(this._forcedPaneIndex)&&a.paneIndex&&a.paneIndex!==this._forcedPaneIndex||this._drawingSession&&g(this._forcedPaneIndex)&&a.paneIndex!==(null==(t=this._drawingSession)?void 0:t.paneIndex))return void((null==(r=this._drawingSession)?void 0:r.primitive)&&(null==(n=(s=this._drawingSession.primitive).updateMove)||n.call(s,{time:NaN,price:NaN},i(this._drawingSession).currentStep)));if(this._drawingSession&&(this._drawingSession.chartService!==e.source||!this._forcedPaneIndex&&a.paneIndex!==this._drawingSession.paneIndex)&&(this._drawingSession.abortDrawing(),this._drawingSession=void 0),this._drawingSession||(this._drawingSession=this._startCreationOnChart(e.source,i(a.paneIndex),!0)),!this._drawingSession.primitive){const e=this.doCreatePrimitive(this._drawingSession);this._drawingSession.startPreview(e)}}const d=null==(a=this._drawingSession)?void 0:a.primitive;if(!d)return;if(!(null==d?void 0:d.updateMove))return;if(!e.point)return;if(e.source!==(null==(o=this._drawingSession)?void 0:o.chartService))return;const l=e.source.chartApi.getCrosshairPosition();if(!u(l))return;if(l.paneIndex!==(null==(h=this._drawingSession)?void 0:h.paneIndex))return;const v=p(this.chartService,l.x,{useExtended:!this.disableExtendTime}),_=i(null==(c=this._drawingSession)?void 0:c.getTargetSeries().coordinateToPrice(l.y));d.updateMove({time:v,price:_},i(this._drawingSession).currentStep)}get resetArgs(){const e=i(this._drawingSession),t=function(e){return e.chartService.invokeWithinContext((e=>e.get(w)))}(e).getColorTheme(),r=j(e);return[this.type,{chartService:this.chartService,colorTheme:t,priceLabelFormatter:N(e),dateTimeFormatter:B(e),dateFormatter:H(e),hitTestCollector:R(e),percentageFormatter:e=>(100*e).toFixed(2)+"%",amountFormatter:e=>e.toFixed(0),timeSpanFormatter:(e,t)=>{let i=t.valueOf()-e.valueOf();const s=Math.sign(i);i=Math.abs(i);const n=Math.floor(i/86400);i%=86400;const a=Math.floor(i/3600);i%=3600;const o=Math.floor(i/60);i%=60;const h=i,c=[];n>0&&c.push(n+r.t("resolution.timeSpan.day")),a>0&&c.push(a+r.t("resolution.timeSpan.hour")),o>0&&c.push(o+r.t("resolution.timeSpan.minute")),(h>0||0===c.length)&&c.push(h+r.t("resolution.timeSpan.second"));const d=c.join(" ");return 1===s?d:`-${d}`}},q(e),e.getTargetSeries(),L(e)]}receivePresetProps({chartService:e,paneIndex:t,props:i}){var r;if(this._forcedPaneIndex=t,e&&this._startCreationOnChart(e,t,!1),this._presetProps=i,!e&&(null==(r=i.points)?void 0:r.length)&&v(),i.points)for(const s of i.points)this._addPoint(s)}doCreatePrimitive(e){const t=this.createPrimitive(e);return this._presetProps&&t.updateProps(_(this._presetProps,["points"])),t}finishDrawing(){i(this._drawingSession).finishDrawing()}abortDrawing(){i(this._drawingSession).abortDrawing()}deactivated(){var e;null==(e=this._drawingSession)||e.dispose()}useMagnetedPosition(){return!0}isDrawingTool(){return!0}canKeepDrawing(){return!0}onlyDrawingOnMainSeries(){return!1}}function j(e){return e.chartService.invokeWithinContext((e=>e.get(S)))}function q(e){return e.chartService.chartApi}function R(e){return(t,i)=>{e.chartService.getController().collectToolHitTestObjects(t,i)}}function B(e){return t=>e.chartService.formatDateTime(t)}function H(e){return t=>e.chartService.formatDate(t)}function N(e){return t=>e.getTargetSeries().priceFormatter().format(t)}function L(e){return e.chartService.getModel()}const W=6,z=1,K=3;class G{constructor(e,i){t(this,"_lineAnchorRenderers",[]),t(this,"_data",Object.create(null)),this._source=e,this._model=i}get _hitTestCollector(){return this._source.hitTestCollector}zOrder(){return this._model.currentCreating==this._source||this._model.currentActive===this._source||this._model.currentHovered===this._source?"top":"under"}points(){return this._data.points}update(e){this._data=e,this._updateImpl()}addAnchors(e){let t=this.points();this._model.currentCreating===this._source&&(t=t.slice(0,i(this._model.pointCreating)+1)),e.append(this.createLineAnchor({points:t},0))}_anchorRadius(){return W}isHoveredSource(){return this._model.currentHovered===this._source}isSelectedSource(){return this._model.isSelected(this._source)}areAnchorsVisible(){return this.isHoveredSource()||this.isSelectedSource()}_lineAnchorColors(e){const t=this._source.series.getPane().getHeight();return e.map((e=>this._model.backgroundColorAtYPercentFromTop(e.y/t)))}createLineAnchor(e,t=0){const{points:i}=e,r=this._getLineAnchorRenderer(t);return r.setData({points:i,color:"#2A62FF",backgroundColors:this._lineAnchorColors(i),currentPoint:this._model.currentPoint,radius:W,strokeWidth:z,selected:this.isSelectedSource(),selectedStrokeWidth:K,visible:this.areAnchorsVisible(),linePointBeingEdited:this._model.currentEditing===this._source?this._model.pointEditing:null}),r}_getLineAnchorRenderer(e){for(;this._lineAnchorRenderers.length<=e;)this._lineAnchorRenderers.push(new P);return this._lineAnchorRenderers[e]}}export{T as A,E as D,G as T,O as a,U as b,f as c,j as g,b as i};
