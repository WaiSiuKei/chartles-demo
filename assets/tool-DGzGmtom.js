var t=Object.defineProperty,e=(e,s,i)=>((e,s,i)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i)(e,"symbol"!=typeof s?s+"":s,i);import{T as s,a as i,D as a,g as r}from"./toolPaneView-BkZhzbTB.js";import{ac as o,ad as n,ae as c}from"./index-iNH1zFVl.js";import{bE as l,bG as h,bD as u,aX as d,cj as f,y as g,z as _,aY as x,r as m,e as T,A as p}from"./index-5gyre0hA.js";import{i as A,c as w,f as y,s as C}from"./text-BFLAaZ9z.js";import{n as b,g as S}from"./formatter-BMswhHnL.js";import{P as M}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as k}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P,T as W}from"./axisPaneView-B6qY_qE1.js";import{m as L}from"./font-DVjjKW8j.js";import{C as v}from"./composite-CCMtJLBO.js";import"./baseTool-BM5mqL4_.js";import"./numericFormatter-DcPXx81O.js";const B="%h:%m:%s",V="%h:%m",H=/%h|%m|%s+|%ss+|%ss|%ampm|%s/g;class I{constructor(t=B){e(this,"_isTwelveHoursFormat",!1),e(this,"_tokensAndDelimiters",[]);const s=H;let i,a=0;for(;null!==(i=s.exec(t));){const e=i[0],s=t.substring(a,i.index);""!==s&&this._tokensAndDelimiters.push(s),this._tokensAndDelimiters.push(e),"%ampm"===e&&(this._isTwelveHoursFormat=!0),a=i.index+e.length}const r=t.substring(a);r&&this._tokensAndDelimiters.push(r)}format(t){return this._formatTime(t,!1)}formatLocal(t){return this._formatTime(t,!0)}_formatTime(t,e){let s=e?t.getHours():t.getUTCHours();const i=e?t.getMinutes():t.getUTCMinutes(),a=e?t.getSeconds():t.getUTCSeconds(),r=e?t.getMilliseconds():t.getUTCMilliseconds();let o="";this._isTwelveHoursFormat&&(o=s>=12?"PM":"AM",s=s%12||12);let n="",c=!1;for(let l=this._tokensAndDelimiters.length-1;l>=0;l--){const t=this._tokensAndDelimiters[l];let e="";switch(t){case"%h":e=b(s,2);break;case"%m":e=b(i,2);break;case"%s":e=b(a,2);break;case"%s+":if(0===a){c=!0;continue}e=b(a,2);break;case"%ss":e=b(r,3);break;case"%ss+":if(0===r){c=!0;continue}e=b(r,3);break;case"%ampm":e=o;break;default:if(c){c=!1;continue}e=t}n=e+n}return n}}let D;function R(t){D||(D=new Map);const e=D.get(t);if(e)return e;const s=new l;D.set(t,s);const i=new Image;return i.onload=()=>{URL.revokeObjectURL(t),s.complete(i)},i.src=t,s}const U="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAQAAABKmM6bAAAAZ0lEQVR4Xl2OsQmAMBRErwgSsHAJV3GHgEVKl3ADixSClViKYPkHfEI+Wsg1j8dxnCQCiQ1jJRFcFIybHsNYCCJXvCSsJonzp/YXbiKzs7d8pavyEBP2yQEji5YV+1KIkmjI/ouRID31wXKLSuZPUAAAAABJRU5ErkJggg==",O="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAQAAABKmM6bAAAARElEQVR4AWMgHvy/9//5f34gzQZiQYSeAyEPkOYE0iAhMJOTAc4ixXjR/13/r/7////h/zn/pSFCT/43/lcHS6X9fwgANMArS3ikrioAAAAASUVORK5CYII=",j="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAKCAQAAADI+WwIAAAAb0lEQVQIHWXAMQpBAQAG4L9eKQdQSr3JpFzC5CoOoJzBSUzK+iallNWkrG99pUymDxHw5Z+RdX4ZOpnmm57aXiuWunnScXAxTGLhqMyNth1muVNq1AYKK2wVeTBGo8JZP2/mgEk+KWxQ5ZfSUS8vV97kThm/FD/aAAAAAElFTkSuQmCC",F=L(14,m,"normal"),E=L(14,m,"bold"),Q=L(11,m,"normal"),K=L(12,m,"normal"),J=L(10,m,"normal");class X extends u{constructor(){super(...arguments),e(this,"_sourceWidth"),e(this,"_sourceHeight"),e(this,"_sourceRectLeftOffset"),e(this,"_targetWidth"),e(this,"_targetHeight"),e(this,"_targetRectLeftOffset"),e(this,"_target1TextWidthCache",new d),e(this,"_target1BoldTextWidthCache",new d),e(this,"_target2TextWidthCache",new d),e(this,"_source1TextWidthCache",new d),e(this,"_source2TextWidthCache",new d)}hitTest(t){if(null===this._data||this._data.points.length<2)return null;const e=this._data.points[0],s=this._data.points[1].subtract(e),i=t.subtract(e),a=Math.abs(s.x),r=Math.abs(s.y),o=f(s.y)*(r-r*Math.sqrt(1-i.x*i.x/(a*a)));if(Math.abs(o-i.y)<3)return new g(_.MovePoint);const n=this._targetLabelHitTest(t);if(n)return n;return this._sourceLabelHitTest(t)}_targetLabelHitTest(t){if(null===this._data||void 0===this._targetWidth||void 0===this._targetHeight||void 0===this._targetRectLeftOffset)return null;let e=this._targetHeight+5;this._data.status&&(e+=24);const s=this._data.direction===o.Up?-1:1,i=this._data.points[1],a=i.x-this._targetRectLeftOffset,r=i.y+3*s,n=i.y+s*(e+3),c=Math.min(r,n),l=Math.max(r,n);return t.x>=a&&t.x<=a+this._targetWidth&&t.y>=c&&t.y<=l?new g(_.MovePoint):null}_sourceLabelHitTest(t){if(null===this._data||void 0===this._sourceWidth||void 0===this._sourceHeight||void 0===this._sourceRectLeftOffset)return null;const e=this._data.direction===o.Up?1:-1,s=this._data.points[0],i=s.x-this._sourceRectLeftOffset,a=s.y+3*e,r=s.y+e*(3+this._sourceHeight+5),n=Math.min(a,r),c=Math.max(a,r);return t.x>=i&&t.x<=i+this._sourceWidth&&t.y>=n&&t.y<=c?new g(_.MovePoint):null}drawImpl(t){if(!this._data||this._data.points.length<2)return;const e=t.context,s=t.mediaSize,i=this._data.points[0],a=this._data.points[1],r=a.subtract(i),o=Math.abs(r.x),n=Math.abs(r.y);let c,l,h;e.lineCap="butt",e.strokeStyle=this._data.color,e.lineWidth=this._data.linewidth,r.y<0?(c=Math.PI/2,l=r.x>0?0:Math.PI,h=1):(c=-Math.PI/2,l=r.x>0?0:-Math.PI,h=-1),e.beginPath(),e.ellipse(i.x,a.y,o,n,0,c,l,c>l),e.stroke(),this._drawTargetLabel(e,s),this._drawStartLabel(e,s);const u=Math.max(8,4*this._data.linewidth);let d;if(Math.abs(r.x)<1||Math.abs(r.y)<1)d=Math.atan(r.x/r.y);else{let t=0,e=Math.PI/2,s=(t+e)/2,i=0,a=0;if(r.length()>u){let r=0;for(;r<10;){i=o*Math.sin(s),a=n*(1-Math.cos(s));const c=Math.sqrt((i-o)**2+(a-n)**2);if(Math.abs(c-u)<1)break;c>u?t=s:e=s,s=(t+e)/2,r++}}d=Math.atan((o-i)/(n-a)),r.x*r.y<0&&(d=-d)}e.fillStyle=this._data.color,e.save(),e.beginPath(),e.translate(a.x,a.y),e.rotate(-d),e.moveTo(0,0),e.lineTo(-u/2,h*u),e.lineTo(u/2,h*u),e.lineTo(0,0),e.restore(),e.fill()}_drawTargetLabel(t,e){if(null===this._data)return;t.save();const{targetLine1:s,targetLine2:i,targetLine3:a,targetLine4:r,clockWhite:c,direction:l,targetBackColor:h,targetStrokeColor:u,centersColor:d,targetTextColor:f,successBackground:g,successTextColor:_,failureBackground:m,failureTextColor:T,successIcon:p,failureIcon:y,status:C,points:b}=this._data,S=b[1];t.font=F;const M=this._target1TextWidthCache.measureText(t,s),k=this._target1TextWidthCache.measureText(t,i),P=this._target1TextWidthCache.measureText(t," ");t.font=Q;const W=this._target2TextWidthCache.measureText(t,a),L=this._target2TextWidthCache.measureText(t,r),v=this._target2TextWidthCache.measureText(t," "),B=(null==c?void 0:c.width)??0;this._targetWidth=Math.max(M+k+P,W+L+B+2*v)+8+4,this._targetHeight=38;const V=S.x+this._targetWidth-e.width+5;this._targetRectLeftOffset=Math.max(20,Math.min(this._targetWidth-15,V));const H=l===o.Up?o.Down:o.Up,I=this._drawBalloon(t,S,this._targetWidth,this._targetHeight,H,this._targetRectLeftOffset);t.fillStyle=h,t.fill(),t.lineWidth=2,t.strokeStyle=u,t.stroke(),t.beginPath(),t.arc(S.x,S.y,3,0,2*Math.PI,!1),t.fillStyle=d,t.fill(),t.textBaseline="top",t.fillStyle=f,t.font=F,t.textAlign=A()?"right":"left";const D=I.x+4+2,R=I.y+3+2,U=this._targetWidth-8-4,O=w(t,U-k-P);t.fillText(s,D+O,R);const j=w(t,U-M);t.fillText(i,D+M+P+j,R);const K=R+14+3;t.font=Q;const J=w(t,U-L-B-v);t.fillText(a,D+J,K);const X=w(t,U-W-v-B-L);c&&t.drawImage(c,D+W+v+X,K+1);const Y=w(t,U-W-B);if(t.fillText(r,D+W+B+2*v+Y,K),!C)return void t.restore();let z,G,N,Z;t.font=E;const $=18;C===n.Success?(z=this._data.successText,G=g,N=_,Z=p):(z=this._data.failureText,G=m,N=T,Z=y);const q=this._target1BoldTextWidthCache.measureText(t,z),tt=Math.round((this._targetWidth-q)/2),et=w(t,q);t.fillStyle=G,l===o.Up?(x(t,I.x-1,I.y-$-2,this._targetWidth+2,$,5),t.fill(),t.fillStyle=N,t.fillText(z,I.x+tt+et,I.y-$+1),Z&&t.drawImage(Z,I.x+tt-Z.width-4,I.y-$-2+Math.abs($-Z.height)/2)):(x(t,I.x-1,I.y+this._targetHeight+2,this._targetWidth+2,$,5),t.fill(),t.fillStyle=N,t.fillText(z,I.x+tt+et,I.y+this._targetHeight+5),Z&&t.drawImage(Z,I.x+tt-Z.width-4,I.y+this._targetHeight+10-Math.abs($-Z.height)/2)),t.restore()}_drawStartLabel(t,e){if(!this._data)return;t.save(),t.font=K;const s=this._source1TextWidthCache.measureText(t,this._data.sourceLine1);t.font=J;const i=this._source2TextWidthCache.measureText(t,this._data.sourceLine2);this._sourceWidth=Math.max(s,i)+6+4,this._sourceHeight=32;const a=this._data.points[0],r=a.x+this._sourceWidth-e.width+5;this._sourceRectLeftOffset=Math.max(20,Math.min(this._sourceWidth-15,r));const o=this._drawBalloon(t,a,this._sourceWidth,this._sourceHeight,this._data.direction,this._sourceRectLeftOffset);t.fillStyle=this._data.sourceBackColor,t.fill(),t.lineWidth=2,t.strokeStyle=this._data.sourceStrokeColor,t.stroke(),t.textAlign=A()?"right":"left",t.textBaseline="top",t.fillStyle=this._data.sourceTextColor;const n=w(t,this._sourceWidth-6-4),c=o.x+4+2+n,l=o.y+2+2;t.font=K,t.fillText(this._data.sourceLine1,c,l),t.font=J,t.fillText(this._data.sourceLine2,c,l+14),t.beginPath(),t.arc(a.x,a.y,3,0,2*Math.PI,!1),t.fillStyle=this._data.centersColor,t.fill(),t.restore()}_drawBalloon(t,e,s,i,a,r=20){t.beginPath();let n;if(a===o.Down){n={x:e.x-r,y:e.y-5-6-i};const a=n.x,o=n.y,c=a+s;return t.moveTo(a+3,o),t.lineTo(c-3,o),t.arcTo(c,o,c,o+3,3),t.lineTo(c,o+i-3),t.arcTo(c,o+i,c-3,o+i,3),t.lineTo(a+r+5,o+i),t.lineTo(a+r,o+i+5),t.lineTo(a+r-5,o+i),t.lineTo(a+3,o+i),t.arcTo(a,o+i,a,o+i-3,3),t.lineTo(a,o+3),t.arcTo(a,o,a+3,o,3),n}{n={x:e.x-r,y:e.y+5+6+i};const a=n.x,o=n.y,c=a+s;return t.moveTo(a+3,o),t.lineTo(c-3,o),t.arcTo(c,o,c,o-3,3),t.lineTo(c,o-i+3),t.arcTo(c,o-i,c-3,o-i,3),t.lineTo(a+r+5,o-i),t.lineTo(a+r,o-i-5),t.lineTo(a+r-5,o-i),t.lineTo(a+3,o-i),t.arcTo(a,o-i,a,o-i+3,3),t.lineTo(a,o-3),t.arcTo(a,o,a+3,o,3),{x:a,y:o-i}}}}class Y extends s{constructor(t,s){super(t,s),e(this,"_predictionRenderer",new X),e(this,"_renderer",new v(this._hitTestCollector)),R(U).p.then((()=>{this._source.requestUpdate()})),R(j).p.then((()=>{this._source.requestUpdate()})),R(O).p.then((()=>{this._source.requestUpdate()}))}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const t=this.points();if((null==t?void 0:t.length)<2)return;const e=this._source.properties(),s=e.transparency;this._predictionRenderer.setData({points:t,color:e.linecolor,linewidth:e.linewidth,targetLine1:this._data.diffText,targetLine2:this._data.durationString,targetLine3:this._data.priceText,targetLine4:this._data.targetTimeText,status:this._data.status,targetBackColor:h(e.targetBackColor,s),targetStrokeColor:h(e.targetStrokeColor,s),targetTextColor:e.targetTextColor,sourceBackColor:h(e.sourceBackColor,s),sourceStrokeColor:h(e.sourceStrokeColor,s),sourceTextColor:e.sourceTextColor,successBackground:h(e.successBackground,s),successTextColor:e.successTextColor,failureBackground:h(e.failureBackground,s),failureTextColor:e.failureTextColor,sourceLine1:this._data.sourcePriceText,sourceLine2:this._data.sourceTimeText,direction:this._data.direction,clockWhite:R(U).value??void 0,successIcon:R(j).value??void 0,failureIcon:R(O).value??void 0,centersColor:"#000000",successText:e.successText,failureText:e.failureText}),this._renderer.append(this._predictionRenderer),this.addAnchors(this._renderer)}}class z extends i{constructor(){super(...arguments),e(this,"_lines",new Y(this,this.model)),e(this,"_paneView",[this._lines]),e(this,"_priceAxisPaneViews",[new P(Object.create(null))]),e(this,"_timeAxisPaneViews",[new W(Object.create(null))]),e(this,"_timeAxisViews",[new k(Object.create(null)),new k(Object.create(null))]),e(this,"_priceAxisViews",[new M(Object.create(null)),new M(Object.create(null))])}pointsCount(){return 2}addPoint(t,e){const s=super.addPoint(t,e);return this.recalculateStateByData(),s}setPoint(t,e,s){super.setPoint(t,e,s),this.recalculateStateByData()}endMoving(){super.endMoving(),this.recalculateStateByData()}status(){return this._props.status}setStatus(t){this._props.status=t}direction(){if(this.controlPoints.length<2)return o.Up;const t=this.controlPoints[0];return this.controlPoints[1].price>t.price?o.Up:o.Down}recalculateStateByData(){if(this.setStatus(n.Waiting),this.controlPoints.length<2)return;const t=this.controlPoints[1],e=this.chart.timeScale().getVisibleRange();if(!e)return;if(t.time>e.to)return;const s=this.chart.timeScale().timeToIndex(t.time);if(null===s)return;const i=this.series.dataByIndex(s);if(null===i)return;const a=this.direction(),r=T(i.customValues.high),c=T(i.customValues.low),l=t.price,h=a===o.Up&&r>=l||a===o.Down&&c<=l;this.setStatus(h?n.Success:n.Failure)}updateAllViews(){var t;if((null==(t=this.controlPoints)?void 0:t.length)<1)return;const e=[];for(let y=0;y<this.controlPoints.length;y++){const t=this.controlPoints[y],s=this.pointToScreenPoint(t);if(!s)return;e.push(new p(s,{pointIndex:y}))}const s=e.map((t=>t.x)),i=e.map((t=>t.y));this.controlPoints.forEach(((t,s)=>{this._timeAxisViews[s].update(this._calculateTimeAxisViewData(t.time,e[s].x)),this._priceAxisViews[s].update(this._calculatePriceAxisViewData(t.price,e[s].y))})),s.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,s),Math.max.apply(null,s))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));const a=this.series.priceFormatter(),[r,o]=this.controlPoints,n=o.price-r.price,c=n/Math.abs(r.price)*100,l=y(a.format(o.price)),h=y(`${a.format(n)} (${S().format(c)})`),u=new Date(1e3*r.time),d=new Date(1e3*o.time),f=this._ctx.chartService.interval(),g=f.isDWM(),_=f.isSeconds()||f.isTicks();let x="",m="";const T=this._ctx.dateFormatter;if(u&&d){const t=new I(_?B:V),e=g?"":`  ${t.format(d)}`;x=`${T(d)}${e}`,m=this._props.formatTargetLine2(C(this._ctx.timeSpanFormatter(u.getTime(),d.getTime())))}const A=a.format(r.price);let w="";const b=new I(_?B:V);w=`${T(u)}${g?"":"  "+b.format(u)}`,this._paneView[0].update({points:e,priceText:l,diffText:h,targetTimeText:x,durationString:m,sourcePriceText:A,sourceTimeText:w,direction:this.direction(),status:this.status()})}}class G extends a{constructor(){super(...arguments),e(this,"type",c)}createPrimitive(t){const e=r(t);return new z({id:this.id,points:[],linecolor:"#2962FF",linewidth:2,sourceBackColor:"#2962FF",sourceTextColor:"#ffffff",sourceStrokeColor:"#2962FF",targetStrokeColor:"#2962FF",targetBackColor:"#2962FF",targetTextColor:"#ffffff",successBackground:"#4caf50",successTextColor:"#ffffff",failureBackground:"#F23645",failureTextColor:"#ffffff",status:n.Waiting,transparency:10,centersColor:"#202020",successText:e.t("tool.forecast.success"),failureText:e.t("tool.forecast.failure"),formatTargetLine2:t=>e.t("tool.forecast.in",{timeSpan:t})},...this.resetArgs)}}export{G as ForecastTool};
