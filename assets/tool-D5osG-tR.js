var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{V as i,H as s}from"./text-BhorOBkg.js";import{e as r,bH as n,u as l,A as o,ck as c,L as a}from"./index-5gyre0hA.js";import{a as h,D as d}from"./toolPaneView-BkZhzbTB.js";import{G as p}from"./index-iNH1zFVl.js";import{P as f}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as m}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as u,T as x}from"./axisPaneView-B6qY_qE1.js";import{F as w,f as b,a as g}from"./horizontalLevelsPaneView-DeGMu8P0.js";import{L as v}from"./line-BKuOqRrm.js";import{R as _}from"./rectangle-E0x1RaIQ.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./baseTool-BM5mqL4_.js";import"./composite-CCMtJLBO.js";import"./paneView-MhvZ7TYs.js";import"./formatter-BMswhHnL.js";import"./numericFormatter-DcPXx81O.js";class L extends w{constructor(){super(...arguments),t(this,"_trendLineRendererPoints12",new v),t(this,"_trendLineRendererPoints23",new v),t(this,"_rectangleRenderers",new Map)}renderer(){return this._renderer}getRectRenderer(e){return this._rectangleRenderers.has(e)||this._rectangleRenderers.set(e,new _),r(this._rectangleRenderers.get(e))}_updateImpl(){this._renderer.clear();const e=this.points();if(e.length<2)return;const[t,i]=e,s=this._source.properties(),r=s.trendline;if(r.visible){const e={points:[t,i],lineColor:r.color,lineWidth:r.linewidth,lineStyle:r.linestyle,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal};this._trendLineRendererPoints12.setData(e),this._renderer.append(this._trendLineRendererPoints12)}if(e.length<3)return void this.addAnchors(this._renderer);const o=s.levels.reduce(((e,t,i)=>{const r=s.levels[i];if(!r.visible)return e;const n=r.coeff,l=r.color;return e.push({color:l,coeff:n,price:this._data.levels[i].price,y:this._data.levels[i].y,linewidth:s.levelsStyle.linewidth,linestyle:s.levelsStyle.linestyle,index:i}),e}),[]),c=e[2];let a=null;r.visible&&(a=this._trendLineRendererPoints23,a.setData({points:[i,c],lineColor:r.color,lineWidth:r.linewidth,lineStyle:r.linestyle,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal}));const h=s.fillBackground,d=s.transparency,p=s.extendLinesLeft,f=s.extendLines,m=Math.min(c.x,i.x),u=Math.max(c.x,i.x);if(h)for(let n=1;n<o.length;n++){const e=o[n-1],t=o[n],i={points:[new l(m,t.y),new l(u,e.y)],color:t.color,lineWidth:0,backColor:t.color,transparency:d,extendLeft:p,extendRight:f},s=this.getRectRenderer(n);s.setData(i),this._renderer.append(s)}const x=this._source.getScope();this._addLevels({levels:o,mediaSize:x.mediaSize,left:m,right:u,showLabel:s.showCoeffs||s.showPrices,showText:s.showText,labelAlign:[s.horzLabelsAlign,s.vertLabelsAlign],textAlign:[s.horzTextAlign,s.vertTextAlign],extendLeft:p,extendRight:f,fontSize:s.labelFontSize,isOnScreen:!0,trendLineRenderer:a}),this.addAnchors(this._renderer)}}class P extends h{constructor(){super(...arguments),t(this,"_lines",new L(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new u(Object.create(null))]),t(this,"_timeAxisPaneViews",[new x(Object.create(null))]),t(this,"_timeAxisViews",[new m(Object.create(null)),new m(Object.create(null)),new m(Object.create(null))]),t(this,"_priceAxisViews",[new f(Object.create(null)),new f(Object.create(null)),new f(Object.create(null))])}pointsCount(){return 3}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let r=0;r<this.controlPoints.length;r++){const t=this.controlPoints[r],i=this.pointToScreenPoint(t);if(!i)return;e.push(new o(i,{pointIndex:r}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));let s=[];if(this.controlPoints.length>2){const[e,t,i]=this.controlPoints,n=this._props.reverse??!1,l=n?e.price:t.price,o=n?t.price:e.price,a=l-o;let h,d=0;const p=this.chart.options().rightPriceScale.mode===c.Logarithmic&&this._props.fibLevelsBasedOnLogScale;if(p){d=r(this.priceScale().priceToCoordinate(l))-r(this.priceScale().priceToCoordinate(o)),h=r(this.priceScale().priceToCoordinate(i.price))}const f={price:i.price,coordinate:h??NaN},m={price:a,coordinate:d};s=this._props.levels.reduce(((e,t)=>{if(!t.visible)return e;const i=b(f,m,t.coeff,this.series,p),s=g(f,m,t.coeff,this.series,p);return e.push({y:i,price:this.series.priceFormatter().format(s)}),e}),[])}this._lines.update({points:e,levels:s})}}class A extends d{constructor(){super(...arguments),t(this,"type",p)}createPrimitive(){return new P({id:this.id,points:[],showCoeffs:!0,showPrices:!0,fillBackground:!0,transparency:80,extendLines:!1,extendLinesLeft:!1,horzLabelsAlign:s.Left,vertLabelsAlign:i.Middle,showText:!0,horzTextAlign:s.Center,vertTextAlign:i.Middle,reverse:!1,coeffsAsPercents:!1,fibLevelsBasedOnLogScale:!1,labelFontSize:12,trendline:{visible:!0,color:"#808080",linewidth:2,linestyle:a.dashed},levelsStyle:{linewidth:2,linestyle:a.solid},levels:[{visible:!0,coeff:0,color:"#808080"},{visible:!0,coeff:.236,color:"#F23645"},{visible:!0,coeff:.382,color:"#FF9800"},{visible:!0,coeff:.5,color:"#4CAF50"},{visible:!0,coeff:.618,color:"#089981"},{visible:!0,coeff:.786,color:"#00BCD4"},{visible:!0,coeff:1,color:"#808080"},{visible:!0,coeff:1.618,color:"#2962FF"},{visible:!0,coeff:2.618,color:"#F23645"},{visible:!0,coeff:3.618,color:"#9C27B0"},{visible:!0,coeff:4.236,color:"#E91E63"}]},...this.resetArgs)}}export{A as TrendBasedFibExtensionTool};
