var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{A as s,z as i,bV as r,u as n,L as a,aU as o,aA as l,e as h,i as c,bS as p,c5 as u,aB as d}from"./index-5gyre0hA.js";import{T as g,a as _,c as m,D as w}from"./toolPaneView-BkZhzbTB.js";import{B as f}from"./index-iNH1zFVl.js";import{P,T as b}from"./axisPaneView-B6qY_qE1.js";import{C as x}from"./composite-CCMtJLBO.js";import{P as D}from"./polygon-D49cV0Ps.js";class y extends g{constructor(){super(...arguments),t(this,"_renderer",new x(this._hitTestCollector)),t(this,"_polygonRenderer",new D)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if(0===e.length)return;const t=[e[0]],n=Math.max(1,this._source.properties().smooth);for(let s=1;s<e.length;s++){const i=e[s].subtract(e[s-1]),r=i.length(),a=Math.min(5,Math.floor(r/n)),o=i.normalized().scaled(r/a);for(let n=0;n<a-1;n++){const i=e[s-1].add(o.scaled(n));t.push(i)}t.push(e[s])}const a=this._smoothArray(t,n),o=this._createPolygonRendererData(a);if(this._polygonRenderer.setData(o),this._renderer.append(this._polygonRenderer),this._source.isCreationFinished()){const e=o.points.length;if(e>0){const t=e>1?[new s(o.points[0],{hitTarget:i.Regular,pointIndex:0}),new s(o.points[e-1],{hitTarget:i.Regular,pointIndex:1})]:[new s(o.points[0],{hitTarget:i.Regular,pointIndex:0})],n=new r({points:t,bgColors:this._lineAnchorColors(t),visible:this.areAnchorsVisible(),hitTarget:i.Regular});this._renderer.append(n)}}}_smoothArray(e,t){if(1===e.length)return e;const s=new Array(e.length);for(let i=0;i<e.length;i++){let r=new n(0,0);for(let s=0;s<t;s++){const t=Math.max(i-s,0),n=Math.min(i+s,e.length-1);r=r.add(e[t]),r=r.add(e[n])}s[i]=r.scaled(.5/t)}return s.push(e[e.length-1]),s}_createPolygonRendererData(e){const t=this._source.properties();return{points:e,lineColor:t.lineColor,lineWidth:t.lineWidth,lineStyle:a.solid}}}class A extends _{constructor(){super(...arguments),t(this,"_lines",new y(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new P(Object.create(null))]),t(this,"_timeAxisPaneViews",[new b(Object.create(null))])}pointsCount(){return 1/0}updateDrag(e,t,s,i,r,n){this._currentDragTarget=e;const a=i-s,o=n-r;this._props.points.forEach(((e,s)=>{e.time=t[s].time+a,e.price=t[s].price+o})),this.updateAllViews(),this.requestUpdate()}updateStroke(e){this.controlPoints.push(e),this.updateAllViews(),this.requestUpdate()}abort(){return m.None}updateAllViews(){const e=[],t=[],i=[];for(let r=0;r<this.controlPoints.length;r++){const t=this.controlPoints[r],i=this.pointToScreenPoint(t);if(!i)return;e.push(new s(i,{pointIndex:r}))}this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i))),this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),this._lines.update({points:e})}}class S extends w{constructor(){super(...arguments),t(this,"type",f),t(this,"_drawPoints",[])}createPrimitive(){return new A({id:o(),points:[],smooth:5,lineColor:"#00BCD4FF",lineWidth:2},...this.resetArgs)}processEvent(e){var t;switch(e.type){case l.DRAG_START:{const t=h(e.asMouseInputEvent()),s=t.source.chartApi.getCrosshairPosition();if(!c(s))return;const i=h(s.paneIndex),r=this._startCreationOnChart(t.source,i,!1,!1),n=s,a=h(d(this.chartService,s.x,{useExtended:!this.disableExtendTime})),o=h(r.getTargetSeries().coordinateToPrice(s.y));t.accept(),this._disableDefaultDrag(),this._drawPoints.push(n);const l=this.createPrimitive();r.startDrawing(l),l.updateStroke({time:a,price:o});break}case l.MOUSE_MOVE:e.accept();break;case l.DRAG:{const s=h(e.asMouseInputEvent()),i=s.source.chartApi.getCrosshairPosition();if(!c(i))return;const r=i;if(p(r,h(u(this._drawPoints)))>3){const e={time:h(d(this.chartService,i.x,{useExtended:!this.disableExtendTime})),price:h(null==(t=this._drawingSession)?void 0:t.getTargetSeries().coordinateToPrice(i.y))};this._drawPoints.push(r),this.primitive.updateStroke(e)}s.accept();break}case l.DRAG_END:h(e.asMouseInputEvent()).accept(),this.abortDrawing();break;case l.DROP:h(e.asMouseInputEvent()).accept(),this._drawingSession&&this.finishDrawing();break}}_disableDefaultDrag(){this.chartService.chartApi.applyOptions({handleScale:!1,handleScroll:!1})}_enableDefaultDrag(){this.chartService.chartApi.applyOptions({handleScale:!0,handleScroll:!0})}finishDrawing(){super.finishDrawing(),this._enableDefaultDrag(),this._drawPoints=[]}useMagnetedPosition(){return!1}}const T=Object.freeze(Object.defineProperty({__proto__:null,BrushTool:S},Symbol.toStringTag,{value:"Module"}));export{S as B,A as a,T as t};
