var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{B as i,H as s,g as n,V as r}from"./text-BhorOBkg.js";import{bH as l,u as o,r as a,y as c,z as h,A as d,e as p,L as f}from"./index-5gyre0hA.js";import{T as m,a as u,D as x}from"./toolPaneView-BkZhzbTB.js";import{I as w}from"./index-iNH1zFVl.js";import{P as _}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as b}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as g,T as v}from"./axisPaneView-B6qY_qE1.js";import{C as P}from"./composite-CCMtJLBO.js";import{L as A}from"./line-BKuOqRrm.js";import{R as y}from"./rectangle-E0x1RaIQ.js";import{V as j}from"./verticalLine-EvGXqPib.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./baseTool-BM5mqL4_.js";class L extends m{constructor(){super(...arguments),t(this,"_trendLineRendererPoints12",new A),t(this,"_trendLineRendererPoints23",new A),t(this,"_textRenderers",new Map),t(this,"_renderer",new P(this._hitTestCollector))}renderer(){return this._renderer}getTextRenderers(e){let t=this._textRenderers.get(e);return t||(t=new i,this._textRenderers.set(e,t)),t}_needLabelExclusionPath(){return"center"===this._source.properties().horzLabelsAlign}_updateImpl(){this._renderer.clear();const e=this._source.properties(),t=this.points();if((null==t?void 0:t.length)<2)return;const[i,r]=t,d=e.trendline;if(d.visible){const e={points:[i,r],lineColor:d.color,lineWidth:d.linewidth,lineStyle:d.linestyle,extendLeft:!1,extendRight:!1,leftEnd:l.Normal,rightEnd:l.Normal};this._trendLineRendererPoints12.setData(e),this._renderer.append(this._trendLineRendererPoints12)}if(t.length<3)return void this.addAnchors(this._renderer);const p=t[2];if(d.visible){const e={points:[r,p],lineColor:d.color,lineWidth:d.linewidth,lineStyle:d.linestyle,extendLeft:!1,extendRight:!1,leftEnd:l.Normal,rightEnd:l.Normal};this._trendLineRendererPoints23.setData(e),this._renderer.append(this._trendLineRendererPoints23)}const{width:f,height:m}=this._source.getScope().mediaSize;if(e.fillBackground){const t=e.transparency;for(let i=1;i<this._data.levels.length;i++){const s=this._data.levels[i-1],n=this._data.levels[i],r=e.levels[i],l={points:[new o(s.x,0),new o(n.x,m)],color:r.color,lineWidth:0,backColor:r.color,transparency:t,extendLeft:!1,extendRight:!1},a=new y;a.setData(l),this._renderer.append(a)}}let u=e.horzLabelsAlign;u=u===s.Left?s.Right:u===s.Right?s.Left:s.Center;const x=e.vertLabelsAlign,w=e.showCoeffs;for(let s=0;s<e.levels.length;s++){const t=e.levels[s],i=this._data.levels[s];let r;if(w){let e;switch(x){case"top":e=new o(i.x,0);break;case"middle":e=new o(i.x,m/2);break;default:e=new o(i.x,m)}const l={points:[e],text:String(t.coeff),color:t.color,vertAlign:x,horzAlign:u,fontFamily:a,offsetX:2,offsetY:0,fontSize:12},c=this.getTextRenderers(s);c.setData(l),this._needLabelExclusionPath()&&(r=n(c,f,m)??void 0),this._renderer.append(c)}const l={x:i.x,lineColor:t.color,lineWidth:e.levelsStyle.linewidth,lineStyle:e.levelsStyle.linestyle,excludeBoundaries:r},d=new c(h.MovePoint),p=new j;p.setData(l),p.setHitTest(d),this._renderer.append(p)}this.addAnchors(this._renderer)}}class V extends u{constructor(){super(...arguments),t(this,"_lines",new L(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new g(Object.create(null))]),t(this,"_timeAxisPaneViews",[new v(Object.create(null))]),t(this,"_timeAxisViews",[new b(Object.create(null)),new b(Object.create(null)),new b(Object.create(null))]),t(this,"_priceAxisViews",[new _(Object.create(null)),new _(Object.create(null)),new _(Object.create(null))])}pointsCount(){return 3}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let o=0;o<this.controlPoints.length;o++){const t=this.controlPoints[o],i=this.pointToScreenPoint(t);if(!i)return;e.push(new d(i,{pointIndex:o}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));let s=[];const[n,r,l]=this.controlPoints;if(this.controlPoints.length>2&&r.time!==n.time&&this.chart.timeScale().getVisibleRange()){const e=p(this.chart.timeScale().timeToIndexEx(n.time)),t=p(this.chart.timeScale().timeToIndexEx(r.time)),i=p(this.chart.timeScale().timeToIndexEx(l.time)),o=t-e,a=i;s=this._props.levels.reduce(((e,t)=>{if(!t.visible)return e;const i=t.coeff,s=Math.round(a+i*o);return e.push({x:p(this.chart.timeScale().logicalToCoordinate(s))}),e}),[])}this._lines.update({points:e,levels:s})}}class R extends x{constructor(){super(...arguments),t(this,"type",w)}createPrimitive(){return new V({id:this.id,points:[],showCoeffs:!0,fillBackground:!0,transparency:80,horzLabelsAlign:s.Right,vertLabelsAlign:r.Bottom,trendline:{visible:!0,color:"#808080",linewidth:2,linestyle:f.dashed},levelsStyle:{linewidth:2,linestyle:f.solid},levels:[{visible:!0,coeff:0,color:"#808080"},{visible:!0,coeff:.382,color:"#F23645"},{visible:!0,coeff:.618,color:"#4CAF50"},{visible:!0,coeff:1,color:"#089981"},{visible:!0,coeff:1.382,color:"#00BCD4"},{visible:!0,coeff:1.618,color:"#808080"},{visible:!0,coeff:2,color:"#2962FF"},{visible:!0,coeff:2.382,color:"#E91E63"},{visible:!0,coeff:2.618,color:"#9C27B0"},{visible:!0,coeff:3,color:"#673AB7"}]},...this.resetArgs)}}export{R as TrendBasedFibTimeTool};
