var e=Object.defineProperty,t=(t,i,o)=>((t,i,o)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o)(t,"symbol"!=typeof i?i+"":i,o);import{T as i,a as o,D as r}from"./toolPaneView-BkZhzbTB.js";import{av as s}from"./index-iNH1zFVl.js";import{u as n,G as a,r as l,B as c,y as d,z as h,bL as p,aZ as u,L as x,ct as f,bI as b,cu as m,bK as _,A as w}from"./index-5gyre0hA.js";import{P as g}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as C}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P,T as y}from"./axisPaneView-B6qY_qE1.js";import{B as A,V as T,g as F,e as V}from"./text-BhorOBkg.js";import{C as M}from"./composite-CCMtJLBO.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";class j extends c{constructor(){super(...arguments),t(this,"_priceLabelRenderer",new A(new d(h.MovePoint)))}setData(e){this._data=e;const t=e.points[0],i=e.points[1],o=Math.round(180*Math.atan2(i.y-t.y,i.x-t.x)/Math.PI);this._priceLabelRenderer.setData({...V(o),points:[i],text:e.text,color:e.textColor,fontFamily:l,fontSize:e.fontSize,bold:e.bold,italic:e.italic,offsetX:0,offsetY:0,borderColor:e.borderColor,borderWidth:1,backgroundColor:e.backgroundColor,backgroundRoundRect:4,boxPaddingVert:6,boxPaddingHorz:8})}hitTest(e){const t=this._data;if(null===t)return null;const i=_().line;return p(t.points[0],t.points[1],e).distance<=i?new d(h.MovePoint):this._priceLabelRenderer.hitTest(e)}drawImpl(e){const t=this._data;if(null===t||t.points.length<2)return;const{horizontalPixelRatio:i,verticalPixelRatio:o,context:r}=e;r.save();const s=Math.round(t.points[0].x*i),n=Math.round(t.points[0].y*o),a=Math.round(t.points[1].x*i),l=Math.round(t.points[1].y*o);r.lineCap="round",u(r,x.solid),r.strokeStyle=t.lineColor,r.fillStyle=t.lineColor,r.lineWidth=Math.round(i);const c=function(e,t){const i=Math.max(1,Math.floor(t))%2==1?.5:0;return Math.round(e*t)+i}(2,i);f(r,s,n,c),r.fill(),void 0!==t.excludeBoundaries&&(r.save(),b(e,t.excludeBoundaries)),m(r,s,n,a,l),void 0!==t.excludeBoundaries&&r.restore(),this._priceLabelRenderer.drawImpl(e);const d=i;r.strokeStyle=t.circleBorderColor,r.lineWidth=d;f(r,s,n,c+d/2),r.stroke(),r.restore()}}class v extends i{constructor(){super(...arguments),t(this,"_renderer",new M(this._hitTestCollector)),t(this,"_priceNoteRenderer",new j),t(this,"_customLabelRenderer",new A)}renderer(){return this._renderer}_updateImpl(){if(this._renderer.clear(),!this._data)return;const e=this.points();if(e.length<2)return;const t=this._source.properties(),i={text:this._data.labelText,points:e,lineColor:t.lineColor,circleBorderColor:"#ffffff",backgroundColor:t.labelBackgroundColor,borderColor:t.labelBorderColor,textColor:t.labelTextColor,fontSize:t.labelFontSize,bold:t.labelBold,italic:t.labelItalic,excludeBoundaries:void 0};if(t.showLineText){const o=e[0],r=e[1],s=o.x<r.x?o:r,c=s===o?r:o,d=t.vertTextAlign,h=t.horzTextAlign;let p;p="left"===h?s.clone():"right"===h?c.clone():new n((o.x+r.x)/2,(o.y+r.y)/2);const u=Math.atan((c.y-s.y)/(c.x-s.x)),x={points:[p],text:t.text,color:t.textColor,vertAlign:d,horzAlign:h,fontFamily:l,offsetX:0,offsetY:0,bold:t.bold,italic:t.italic,fontSize:t.fontSize,forceTextAlign:!0,angle:u,cursorType:a.unset};if(this._customLabelRenderer.setData(x),this._renderer.append(this._customLabelRenderer),d===T.Middle){const{mediaSize:{width:e,height:t}}=this._source.getScope();i.excludeBoundaries=F(this._customLabelRenderer,e,t)??void 0}}this._priceNoteRenderer.setData(i),this._renderer.append(this._priceNoteRenderer),this._renderer.append(this.createLineAnchor({points:this.points()},0))}}class L extends o{constructor(){super(...arguments),t(this,"_lines",new v(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_timeAxisViews",[new C(Object.create(null)),new C(Object.create(null))]),t(this,"_priceAxisViews",[new g(Object.create(null)),new g(Object.create(null))]),t(this,"_priceAxisPaneViews",[new P]),t(this,"_timeAxisPaneViews",[new y])}pointsCount(){return 2}updateAllViews(){if(!this.controlPoints.length)return;const e=[],t=[],i=[],o=this._ctx.priceLabelFormatter(this.controlPoints[0].price);for(let r=0;r<this.controlPoints.length;r++){const o=this.controlPoints[r],s=this.pointToScreenPoint(o);if(!s)return;t.push(s.x),i.push(s.y);const n=new w(s,{pointIndex:r,hitTarget:h.ChangePoint});e.push(n),this._timeAxisViews[r].update(this._calculateTimeAxisViewData(o.time,s.x)),this._priceAxisViews[r].update(this._calculatePriceAxisViewData(o.price,s.y))}t.length&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i))),this._lines.update({points:e,labelText:o})}}class z extends r{constructor(){super(...arguments),t(this,"type",s)}createPrimitive(){return new L({id:this.id,points:[],showLineText:!1,text:"",fontSize:14,textColor:"#2962FFFF",vertTextAlign:"top",horzTextAlign:"center",labelTextColor:"#ffffff",labelFontSize:12,labelBold:!1,labelItalic:!1,labelBackgroundColor:"#2962FFFF",labelBorderColor:"#2962FFFF",lineColor:"#2962FFFF"},...this.resetArgs)}}export{z as PriceNoteTool};
