var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{B as i,r,e as o,u as s,v as n,w as a,x as l,H as d,y as p,z as h,G as c,J as u,M as _,L as m,N as v,A as g,O as y,Q as P,S as x,U as f,V as C,W as b,X as w,Y as O,Z as T,$ as S,a0 as D,a1 as I,a2 as L,a3 as B,a4 as k,a5 as R,a6 as M,a7 as A,a8 as z,a9 as j,aa as K,ab as W,ac as H,ad as V,ae as $,af as F,d as q,s as Y,ag as U,ah as E,ai as N,aj as X,ak as G}from"./index-5gyre0hA.js";import{T as Z,a as J,D as Q,b as ee}from"./toolPaneView-BkZhzbTB.js";import{P as te}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{r as ie}from"./adjustValue-DAhiMl70.js";import{C as re}from"./composite-CCMtJLBO.js";import{B as oe}from"./text-BhorOBkg.js";import"./baseTool-BM5mqL4_.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";var se=(e=>(e[e.Buy=1]="Buy",e[e.Sell=-1]="Sell",e))(se||{}),ne=(e=>(e[e.Limit=1]="Limit",e[e.Market=2]="Market",e[e.Stop=3]="Stop",e[e.StopLimit=4]="StopLimit",e))(ne||{}),ae=(e=>(e[e.Canceled=1]="Canceled",e[e.Filled=2]="Filled",e[e.Inactive=3]="Inactive",e[e.Placing=4]="Placing",e[e.Rejected=5]="Rejected",e[e.Working=6]="Working",e))(ae||{}),le=(e=>(e[e.Order=1]="Order",e[e.Position=2]="Position",e))(le||{});function de(e){return!!e.parentId}function pe(e){return e.parentId&&1===e.type}var he=(e=>(e[e.tp=1]="tp",e[e.sl=2]="sl",e[e.order=3]="order",e))(he||{});const ce=13,ue=18,_e=3,me=4,ve=66,ge=20;class ye extends i{constructor(){super(...arguments),t(this,"_pnlTextRenderer",new oe),t(this,"_text1Renderer",new oe),t(this,"_text2Renderer",new oe),t(this,"_text3Renderer",new oe),t(this,"_sizeData",null),t(this,"_positionData",null),t(this,"_pnlPositionData",null)}setData(e){if(super.setData(e),this._sizeData=null,this._positionData=null,this._pnlPositionData=null,!this._data||!this._data.points.length)return;this._data.pnl&&this._pnlTextRenderer.setData({points:this._data.points,text:this._data.pnl.pnlText,fontSize:ce,color:o(this._data.pnl.pnlColor),fontFamily:r,horzAlign:"center",vertAlign:"middle",offsetX:0,offsetY:0}),this._text1Renderer.setData({points:this._data.points,text:this._data.text1,fontSize:ce,color:this._data.color,fontFamily:r,horzAlign:"center",vertAlign:"middle",offsetX:0,offsetY:0}),this._text2Renderer.setData({points:this._data.points,text:this._data.text2,fontSize:ce,color:this._data.color,fontFamily:r,horzAlign:"center",vertAlign:"middle",offsetX:0,offsetY:0}),this._data.text3&&this._text3Renderer.setData({points:this._data.points,text:this._data.text3,fontSize:ce,color:this._data.color,fontFamily:r,horzAlign:"center",vertAlign:"middle",offsetX:0,offsetY:0});const t=this._data.pnl?this._pnlTextRenderer.measure().width:0,i=this._text1Renderer.measure().width+2*_e,s=this._text2Renderer.measure().width+2*_e,n=this._data.text3?this._text3Renderer.measure().width+2*_e:0,a=t?t+2*_e:0,l=[i,s,n].reduce(((e,t)=>e+t));this._sizeData={text1Width:i,text2Width:s,text3Width:n,pnlBtnWidth:a,mainBtnWidth:l};const d=this._data.rightEdge-ve,p=d-this._sizeData.mainBtnWidth,h=this._data.points[0].y-ue/2,c=h+ue;if(this._positionData={top:h,right:d,bottom:c,left:p},this._data.pnl){const e=p-ge;this._pnlPositionData={top:h,right:e,bottom:c,left:e-a}}}hitTest(e){if(!this._data)return null;if(!this._positionData)return null;if(!this._sizeData)return null;const t=new s(this._positionData.left,this._positionData.top),i=new s(this._positionData.right,this._positionData.bottom);if(n(e,a(t,i)))return this._hitTest;if(this._pnlPositionData){const t=new s(this._pnlPositionData.left,this._pnlPositionData.top),i=new s(this._pnlPositionData.right,this._pnlPositionData.bottom);if(n(e,a(t,i)))return this._hitTest}return null}drawImpl(e){this.drawMain(e),this.drawPnl(e)}drawMain(e){if(!this._data)return;if(!this._sizeData)return;if(!this._positionData)return;const{context:t,horizontalPixelRatio:i,verticalPixelRatio:r}=e,{top:o,right:n,left:a}=this._positionData,d=me*i,p=this._data.points[0].y;l(t,a*i,o*r,this._sizeData.mainBtnWidth*i,ue*r,this._data.backgroundColor),this._text1Renderer.setPoint(new s(a+this._sizeData.text1Width/2,p)),this._text1Renderer.drawImpl(e),this._text2Renderer.setPoint(new s(a+ +this._sizeData.text1Width+this._sizeData.text2Width/2,p)),this._text2Renderer.drawImpl(e),this._data.text3&&(this._text3Renderer.setPoint(new s(n-this._sizeData.text3Width/2,p)),this._text3Renderer.drawImpl(e)),l(t,a*i,o*r,this._sizeData.mainBtnWidth*i,ue*r,"transparent",1*i,[d,d,d,d],this._data.color)}drawPnl(e){if(!this._data)return;if(!this._sizeData)return;if(!this._pnlPositionData)return;if(!this._data.pnl)return;const{context:t,horizontalPixelRatio:i,verticalPixelRatio:r}=e,{top:o,left:n}=this._pnlPositionData,a=me*i,d=this._data.points[0].y;l(t,n*i,o*r,this._sizeData.pnlBtnWidth*i,ue*r,this._data.backgroundColor),this._pnlTextRenderer.setPoint(new s(n+this._sizeData.pnlBtnWidth/2,d)),this._pnlTextRenderer.drawImpl(e),l(t,n*i,o*r,this._sizeData.pnlBtnWidth*i,ue*r,"transparent",1*i,[a,a,a,a],this._data.pnl.pnlColor)}}class Pe extends Z{constructor(){super(...arguments),t(this,"_renderer",new re(this._hitTestCollector)),t(this,"_mainRenderer",new ye),t(this,"_tpRenderer",new ye),t(this,"_slRenderer",new ye),t(this,"_lineRenderer",new d)}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if(!e||!e.length)return;const[t,i,r]=e,s=this._source.properties();this._mainRenderer.setData({points:[t],color:s.color,backgroundColor:this._model.backgroundColorAtYPercentFromTop(this.points()[0].y/this._source.series.getPane().getHeight()),text1:s.typeText,text2:s.amountText,text3:s.leverageText,pnl:s.pnl?s.pnl:void 0,rightEdge:this._source.timeScale().width(),onDrop:s.onDrop,onContextMenu:s.onContextMenu});const n=new p("order"===s.type?h.ChangePoint:h.Regular,{areaName:"order"===s.type?_.AnchorPoint:void 0,componentIndex:"order"===s.type?he.order:void 0,resizeDirections:u,cursorType:c.pointer,onDrop:s.onDrop,onContextMenu:s.onContextMenu});this._mainRenderer.setHitTest(n),this._lineRenderer.setData({y:t.y,lineWidth:1,lineStyle:m.solid,lineColor:s.color}),this._lineRenderer.setHitTest(n),this._renderer.append(this._lineRenderer),this._renderer.append(this._mainRenderer),s.tp&&(this._tpRenderer.setData({points:[o(i)],color:s.tp.tpColor,backgroundColor:this._model.backgroundColorAtYPercentFromTop(s.tp.tpPrice/this._source.series.getPane().getHeight()),text1:"TP",text2:s.tp.tpText,rightEdge:this._source.timeScale().width(),onDrop:s.onDrop,onContextMenu:s.onContextMenu}),this._tpRenderer.setHitTest(new p(h.ChangePoint,{areaName:_.AnchorPoint,componentIndex:he.tp,resizeDirections:u,cursorType:c.pointer,onDrop:s.onDrop,onContextMenu:s.onContextMenu})),this._renderer.append(this._tpRenderer)),s.sl&&(this._slRenderer.setData({points:[o(r)],color:s.sl.slColor,backgroundColor:this._model.backgroundColorAtYPercentFromTop(s.sl.slPrice/this._source.series.getPane().getHeight()),text1:"SL",text2:s.sl.slText,rightEdge:this._source.timeScale().width(),onDrop:s.onDrop,onContextMenu:s.onContextMenu}),this._slRenderer.setHitTest(new p(h.ChangePoint,{areaName:_.AnchorPoint,componentIndex:he.sl,resizeDirections:u,cursorType:c.pointer,onDrop:s.onDrop,onContextMenu:s.onContextMenu})),this._renderer.append(this._slRenderer))}zOrder(){return this._model.currentActive===this._source||this._model.currentHovered===this._source?"top":"normal"}}class xe extends J{constructor(){super(...arguments),t(this,"_line",new Pe(this,this.model)),t(this,"_paneView",[this._line]),t(this,"_priceAxisViews",[new te(Object.create(null)),new te(Object.create(null)),new te(Object.create(null))]),t(this,"disableToolbar",!0),t(this,"disableDelete",!0),t(this,"_lastHoveredBtn",null)}pointsCount(){return 1}updateHover(e){e&&e.componentIndex?this._lastHoveredBtn=e.componentIndex:this._lastHoveredBtn=null,super.updateHover(e)}hoveredBtn(){return this._lastHoveredBtn}setPoint(e,t,i){const{hitTestDetails:r}=i,s=this._ctx.chartService.symbolInfo(),n=this._ctx.chartService.mainSeriesApi.getLastPrice(),{series:a}=this,l={get lower(){return Math.max(o(a.coordinateToPrice(a.getPane().getHeight())),n-n*(s.ask_spread_ratio??1/0))},get upper(){return Math.min(n+n*(s.bid_spread_ratio??1/0),o(a.coordinateToPrice(0)))}};if(r.componentIndex===he.tp&&this._props.tp){const e=this._props.points[0].price;this._props.side===se.Buy?this._props.tp.tpPrice=ie(v(t.price,e+s.minmov,l.upper),s.minmov):this._props.tp.tpPrice=ie(v(t.price,e-s.minmov,l.lower),s.minmov),this.updateAllViews(),this.requestUpdate()}r.componentIndex===he.sl&&this._props.sl&&(this._props.side===se.Buy?this._props.sl.slPrice=ie(v(t.price,this._props.points[0].price-3*s.minmov,l.lower),s.minmov):this._props.sl.slPrice=ie(v(t.price,this._props.points[0].price+3*s.minmov,l.upper),s.minmov),this.updateAllViews(),this.requestUpdate()),r.componentIndex===he.order&&(this._props.points[0].price=ie(v(t.price,l.lower,l.upper),s.minmov))}updateAllViews(){if(!this.controlPoints.length)return;const[e]=this.controlPoints,t=this.pointToScreenPoint(e);if(!t)return;const i=[new g(t)];this._priceAxisViews[0].update({foreground:this._props.color,background:this.model.backgroundColorAtYPercentFromTop(t.y/this.series.getPane().getHeight()),coordinate:t.y,text:this._ctx.priceLabelFormatter(e.price),visible:!0,border:this._props.color});const{tp:r,sl:s}=this._props;if(r){const e=o(this.series.priceToCoordinate(r.tpPrice));this._priceAxisViews[1].update({foreground:r.tpColor,background:this.model.backgroundColorAtYPercentFromTop(e/this.series.getPane().getHeight()),coordinate:e,text:this._ctx.priceLabelFormatter(r.tpPrice),visible:!0,border:r.tpColor}),i.push(new g({x:0,y:e}))}else this._priceAxisViews[1].update(Object.create(null));if(s){const e=o(this.series.priceToCoordinate(s.slPrice));this._priceAxisViews[2].update({foreground:s.slColor,background:this.model.backgroundColorAtYPercentFromTop(e/this.series.getPane().getHeight()),coordinate:e,text:this._ctx.priceLabelFormatter(s.slPrice),visible:!0,border:s.slColor}),i.push(new g({x:0,y:e}))}else this._priceAxisViews[2].update(Object.create(null));this._line.update({points:i})}}class fe extends Q{constructor(){super(...arguments),t(this,"type","tool.trade.line")}createPrimitive(){return y()}createPrimitiveWithPreset(e,t,i){this._drawingSession=new ee(e,t,!1);const r=new xe({id:this.id,...i},...this.resetArgs);return r.attach(this._drawingSession.getTargetSeries()),r}}function Ce(e,t,i=!1){return e<<2|(t===se.Buy?1:0)<<1|(i?1:0)}var be=(e=>(e[e.buy=0]="buy",e[e.sell=1]="sell",e[e.tp=2]="tp",e[e.sl=3]="sl",e))(be||{});var we=b('<div class="itemLabel svelte-1dhrsg6"> </div>'),Oe=b('<div class="itemLabel svelte-1dhrsg6"> </div>'),Te=b("<!> <!>",1),Se=b('<div class="itemLabel svelte-1dhrsg6"> </div>'),De=b('<div class="itemLabel svelte-1dhrsg6"> </div>'),Ie=b("<!> <!>",1),Le=b("<!> <!>",1),Be=b('<div class="menu svelte-1dhrsg6"><!></div>'),ke=b('<div class="anchor svelte-1dhrsg6"><!></div>');const Re={hash:"svelte-1dhrsg6",code:".anchor.svelte-1dhrsg6 {position:absolute;pointer-events:none;}.menu.svelte-1dhrsg6 {pointer-events:auto;padding:6px 0;cursor:default;height:100%;overflow-x:hidden;overflow-y:auto;overscroll-behavior:contain;background:var(--cl-listItem-background);}.menu.svelte-1dhrsg6::-webkit-scrollbar {-webkit-appearance:none;width:3px;height:3px;}.menu.svelte-1dhrsg6::-webkit-scrollbar-corner {display:none;}.menu.svelte-1dhrsg6::-webkit-scrollbar-thumb {background-clip:content-box;background-color:var(--cl-scrollbarThumb-background);border-radius:3px;}.menu.svelte-1dhrsg6::-webkit-scrollbar-track {background-color:initial;border-radius:3px;}.menu.svelte-1dhrsg6 .mdc-deprecated-list {margin:0;padding:0;list-style:none;}.menu.svelte-1dhrsg6 .item {height:32px;padding:0 20px 0 6px;display:flex;flex-flow:row nowrap;align-items:center;}\n@media (hover: hover) and (pointer: fine) {.menu.svelte-1dhrsg6 .item:hover {background-color:var(--cl-listItem-hoverBackground);}\n}.itemLabel.svelte-1dhrsg6 {font-size:14px;color:var(--cl-listItem-foreground);white-space:nowrap;flex:0 1 100%;padding-left:6px;cursor:default;user-select:none;}"};function Me(e,t){I(t,!0),P(e,Re);const{t:i}=x(),r=f(M);let o,s=C({top:"",left:"",width:"",height:""}),n=C({type:"",id:""});const a=()=>{const e=r.getOrderById(n.id);e&&r.showOrderDialog(e)},l=()=>{r.showCancelOrderDialog(n.id)},d=()=>{r.showModifyPositionDialog(n.id)},p=()=>{r.showClosePositionDialog(n.id)};async function h(e){const{anchor:t}=e;Object.assign(s,{left:L(t.x),top:L(t.y),width:L(t.width),height:L(t.height)}),Object.assign(n,{type:e.type,id:e.id}),await B(),o.setOpen(!0)}t.__registerComponent({show:h});var c=ke(),u=k(c);return w(O(u,{anchorCorner:"BOTTOM_RIGHT",quickOpen:!0,children:(e,t)=>{var r=Be(),o=k(r);A(o,{children:(e,t)=>{var r=Le(),o=z(r),s=e=>{var t=Te(),r=z(t);{let e=$((()=>F(a)));W(r,{tag:"div",class:"item",get onpointerup(){return V(e)},children:(e,t)=>{var r=we(),o=k(r);T((e=>H(o,e)),[()=>i("tradeLineMenu.modifyOrder")]),S(e,r)},$$slots:{default:!0}})}var o=K(r,2);{let e=$((()=>F(l)));W(o,{tag:"div",class:"item",get onpointerup(){return V(e)},children:(e,t)=>{var r=Oe(),o=k(r);T((e=>H(o,e)),[()=>i("tradeLineMenu.cancelOrder")]),S(e,r)},$$slots:{default:!0}})}S(e,t)};j(o,(e=>{n.type===le.Order&&e(s)}));var h=K(o,2),c=e=>{var t=Ie(),r=z(t);{let e=$((()=>F(d)));W(r,{tag:"div",class:"item",get onpointerup(){return V(e)},children:(e,t)=>{var r=Se(),o=k(r);T((e=>H(o,e)),[()=>i("tradeLineMenu.modifyPosition")]),S(e,r)},$$slots:{default:!0}})}var o=K(r,2);{let e=$((()=>F(p)));W(o,{tag:"div",class:"item",get onpointerup(){return V(e)},children:(e,t)=>{var r=De(),o=k(r);T((e=>H(o,e)),[()=>i("tradeLineMenu.closePosition")]),S(e,r)},$$slots:{default:!0}})}S(e,t)};j(h,(e=>{n.type===le.Position&&e(c)})),S(e,r)},$$slots:{default:!0}}),S(e,r)},$$slots:{default:!0}}),(e=>o=e),(()=>o)),T((e=>R(c,e)),[()=>Object.entries(s).map((([e,t])=>`${e}: ${t};`)).join(" ")]),S(e,c),D({show:h})}var Ae=Object.defineProperty,ze=Object.getOwnPropertyDescriptor,je=(e,t,i,r)=>{for(var o,s=r>1?void 0:r?ze(t,i):t,n=e.length-1;n>=0;n--)(o=e[n])&&(s=(r?o(t,i,s):o(s))||s);return r&&s&&Ae(t,i,s),s},Ke=(e,t)=>(i,r)=>t(i,r,e);class We{constructor(){t(this,"_primitiveToSource",new Map),t(this,"_orderToPrimitive",new Map),t(this,"_positionToPrimitive",new Map),t(this,"_orphanOrders",[])}getSource(e){return this._primitiveToSource.get(e)}getPrimitiveId(e){return e.type===le.Order?this._orderToPrimitive.get(e.id):this._positionToPrimitive.get(e.id)}removeSource(e){const t=this.getPrimitiveId(e);if(t&&this._primitiveToSource.delete(t),e.type===le.Order){this._orderToPrimitive.delete(e.id);const t=this._orphanOrders.findIndex((t=>t.id===e.id));t>-1&&this._orphanOrders.splice(t,1)}else this._positionToPrimitive.delete(e.id)}addPrimitiveId(e,t){this._primitiveToSource.set(e,t),t.type===le.Order?this._orderToPrimitive.set(t.id,e):this._positionToPrimitive.set(t.id,e)}primitiveIds(){return this._primitiveToSource.keys()}addOrphanOrder(e){this._orphanOrders.push(e)}getOrphanChildOrders(e){return this._orphanOrders.filter((t=>t.parentId===e.id&&t.parentType===e.type))}removeOrphanOrder(e){const t=this._orphanOrders.findIndex((t=>t.id===e.id));t>-1&&this._orphanOrders.splice(t,1)}clear(){this._primitiveToSource.clear(),this._orderToPrimitive.clear(),this._positionToPrimitive.clear()}}let He=class extends q{constructor(e,i,r,s,n){super(),t(this,"_map",new We),t(this,"_menu",null),t(this,"_onDrop",(e=>{if(!e.details.componentIndex)return;const t=e.target;switch(e.details.componentIndex){case he.tp:{const i=this._map.getSource(e.target.id);if(!i)return;if(i.type===le.Position){const e=this.tradeService.getPositionById(i.id);if(!e)return;const r={symbol:e.symbol,qty:e.qty,type:ne.Limit,side:e.side===se.Buy?se.Sell:se.Buy,price:o(t.properties().tp).tpPrice,modifyId:e.id,parentId:e.id,parentType:le.Position};this.tradeService.showOrderDialog(r)}else{const e=this.tradeService.getOrderById(i.id);if(!e)return;const r={symbol:e.symbol,qty:e.qty,type:ne.Limit,side:e.side===se.Buy?se.Sell:se.Buy,price:o(t.properties().tp).tpPrice,modifyId:e.id,parentId:e.id,parentType:le.Order};this.tradeService.showOrderDialog(r)}break}case he.sl:{const i=this._map.getSource(e.target.id);if(!i)return;if(i.type===le.Position){const e=this.tradeService.getPositionById(i.id);if(!e)return;const r={symbol:e.symbol,qty:e.qty,type:ne.Stop,side:e.side===se.Buy?se.Sell:se.Buy,price:o(t.properties().sl).slPrice,modifyId:e.id,parentId:e.id,parentType:le.Position};this.tradeService.showOrderDialog(r)}else{const e=this.tradeService.getOrderById(i.id);if(!e)return;const r={symbol:e.symbol,qty:e.qty,type:ne.Stop,side:e.side===se.Buy?se.Sell:se.Buy,price:o(t.properties().tp).tpPrice,modifyId:e.id,parentId:e.id,parentType:le.Order};this.tradeService.showOrderDialog(r)}break}case he.order:{const i=this._map.getSource(e.target.id);if(!i)return;if(i.type!==le.Order)return;const r=this.tradeService.getOrderById(i.id);if(!r)return;const o={...r,price:t.controlPoints[0].price,modifyId:r.id};this.tradeService.showOrderDialog(o)}}})),t(this,"_onContextMenu",(e=>{const t=this._map.getSource(e.target.id);t&&this._showMenu({anchor:{x:e.x,y:e.y,width:1,height:1},type:t.type,id:t.id})})),this.chartService=e,this.chartGuiService=i,this.tradeService=r,this.i18nService=s,this.configurationService=n,this._register(e.onDataLoaded((()=>{r.orders().then((e=>{e.forEach((e=>this._handleOrderUpdate(e)))})),r.positions().then((e=>{e.forEach((e=>this._handlePositionUpdate(e)))}))}))),this._register(e.onSymbolChanged((()=>{this._map.primitiveIds().forEach((e=>{this.chartService.getController().detachToolPrimitiveById(e)})),this._map.clear()}))),this._register(r.onOrderUpdated((e=>this._handleOrderUpdate(e)))),this._register(r.onPositionUpdated((e=>{this._handlePositionUpdate(e.position)}))),this._register(e.onPositionsAndOrdersVisibility((e=>{this._map.primitiveIds().forEach((t=>{var i;null==(i=this.chartService.getController().getToolPrimitiveById(t))||i.updateProps({visible:e})}))})))}async _handleOrderUpdate(e){const t={type:le.Order,id:e.id};e.status!==ae.Canceled&&e.status!==ae.Filled?de(e)?this._updateChildOrderOrCreateOrphanOrder(e,t):this._updateOrCreateOrder(e,t):this._removeOrder(e,t)}_removeOrder(e,t){const i=this._map.getPrimitiveId(t);if(i&&(this.chartService.getController().detachToolPrimitiveById(i),this._map.removeSource(t)),de(e)){const t=pe(e);if(t){const i=this._map.getPrimitiveId({type:le.Order,id:e.parentId});if(i){const e=this.chartService.getController().getToolPrimitiveById(i);null==e||e.updateProps(t?{tp:void 0}:{sl:void 0})}}}}async _updateOrCreateOrder(e,t){const i=e.price??this.chartService.mainSeriesApi.getLastPrice(),r=this._map.getPrimitiveId(t);if(r){const s=o(this.chartService.getController().getToolPrimitiveById(r)),n={points:[{time:0,price:i}],amountText:this.i18nService.formatNumber(e.qty),pnl:e.pnlText?{pnlText:e.pnlText,pnlColor:o(e.pnl)>=0?this._buyColor():this._sellColor()}:void 0,tp:e.takeProfitPrice?{tpPrice:e.takeProfitPrice,tpText:o(e.takeProfitPnl),tpColor:this._tpColor()}:void 0,sl:e.stopLossPrice?{slPrice:e.stopLossPrice,slText:o(e.stopLossPnl),slColor:this._slColor()}:void 0};return this._adoptOrphanOrder(n,t),void s.updateProps(n)}this._createOrder(e,t)}_createOrder(e,t){const i=e.price??this.chartService.mainSeriesApi.getLastPrice(),{typeKey:r,colorKey:s}=function(e){const t=Ce(e.type,e.side,!!e.parentId);return{[Ce(ne.Limit,se.Buy)]:{typeKey:"tool.tradeLine.buy",colorKey:0},[Ce(ne.Market,se.Buy)]:{typeKey:"tool.tradeLine.buy",colorKey:0},[Ce(ne.Limit,se.Sell)]:{typeKey:"tool.tradeLine.sell",colorKey:1},[Ce(ne.Market,se.Sell)]:{typeKey:"tool.tradeLine.sell",colorKey:1},[Ce(ne.Stop,se.Sell)]:{typeKey:"tool.tradeLine.sell",colorKey:1},[Ce(ne.Limit,se.Sell,!0)]:{typeKey:"tool.tradeLine.tp",colorKey:2},[Ce(ne.Limit,se.Buy,!0)]:{typeKey:"tool.tradeLine.tp",colorKey:2},[Ce(ne.Stop,se.Sell,!0)]:{typeKey:"tool.tradeLine.sl",colorKey:3},[Ce(ne.Stop,se.Buy,!0)]:{typeKey:"tool.tradeLine.sl",colorKey:3}}[t]}(e),n={points:[{time:0,price:i}],color:this._getColor(s),typeText:this.i18nService.t(o(r)),amountText:this.i18nService.formatNumber(e.qty),leverageText:e.leverage?`${e.leverage}X`:"",onDrop:this._onDrop,onContextMenu:this._onContextMenu,side:e.side,type:"order",visible:!0,pnl:e.pnlText?{pnlText:e.pnlText,pnlColor:o(e.pnl)>=0?this._buyColor():this._sellColor()}:void 0,tp:e.takeProfitPrice?{tpPrice:e.takeProfitPrice,tpText:o(e.takeProfitPnl),tpColor:this._tpColor()}:void 0,sl:e.stopLossPrice?{slPrice:e.stopLossPrice,slText:o(e.stopLossPnl),slColor:this._slColor()}:void 0};this._adoptOrphanOrder(n,t);const a=this._createPrimitive(n);Y(a),this._map.addPrimitiveId(a,t)}async _updateChildOrderOrCreateOrphanOrder(e,t){const i=this._map.getPrimitiveId({type:e.parentType,id:e.parentId});if(i){const t=pe(e),r=this.chartService.getController().getToolPrimitiveById(i);o(r).updateProps(t?{tp:{tpColor:this._tpColor(),tpPrice:o(e.price),tpText:"1000"}}:{sl:{slColor:this._slColor(),slPrice:o(e.price),slText:"1000"}})}else this._createOrphanOrder(e,t)}_createOrphanOrder(e,t){Y(de(e)),this._createOrder(e,t),this._map.addOrphanOrder(e)}_adoptOrphanOrder(e,t){const i=this._map.getOrphanChildOrders(t);if(i.length){const t=i.find((e=>e.side===se.Buy));t&&(e.tp={tpPrice:o(t.price),tpColor:this._tpColor(),tpText:"xxxxxx"},this._removeOrphanOrder(t));const r=i.find((e=>e.side===se.Sell));r&&(e.sl={slPrice:o(r.price),slColor:this._slColor(),slText:"xxxxx"},this._removeOrphanOrder(r))}}_removeOrphanOrder(e){this._map.removeOrphanOrder(e);const t={type:le.Order,id:e.id},i=this._map.getPrimitiveId(t);i&&(this.chartService.getController().detachToolPrimitiveById(i),this._map.removeSource(t))}async _handlePositionUpdate(e){const t={type:le.Position,id:e.id};0!==e.qty?this._updateOrCreatePosition(e,t):this._removePosition(t)}async _removePosition(e){const t=this._map.getPrimitiveId(e);t&&(this.chartService.getController().detachToolPrimitiveById(t),this._map.removeSource(e))}async _updateOrCreatePosition(e,t){const i=this._map.getPrimitiveId(t);if(i){const r=this.chartService.getController().getToolPrimitiveById(i);if(r){const i={pnl:{pnlText:e.pnlText,pnlColor:e.pnl>0?this._buyColor():this._sellColor()},tp:e.takeProfitPrice?{tpPrice:e.takeProfitPrice,tpText:o(e.takeProfitPnl),tpColor:this._tpColor()}:void 0,sl:e.stopLossPrice?{slPrice:e.stopLossPrice,slText:o(e.stopLossPnl),slColor:this._slColor()}:void 0};return this._adoptOrphanOrder(i,t),void r.updateProps(i)}}else this._createPosition(e,t)}async _createPosition(e,t){const{colorKey:i,typeKey:r}=function(e){return e.side===se.Buy?{typeKey:"tool.tradeLine.buy",colorKey:0}:{typeKey:"tool.tradeLine.sell",colorKey:1}}(e),o=this._getColor(i),s={points:[{time:0,price:e.avgPrice}],color:o,visible:!0,typeText:this.i18nService.t(r),amountText:this.i18nService.formatNumber(e.qty),leverageText:e.leverage?`${e.leverage}X`:"",pnl:e.pnlText?{pnlText:e.pnlText,pnlColor:o}:void 0,side:e.side,type:"position",onDrop:this._onDrop,onContextMenu:this._onContextMenu};this._adoptOrphanOrder(s,t);const n=this._createPrimitive(s);Y(n),this._map.addPrimitiveId(n,t)}async _showMenu(e){this._menu||(this._register(this._menu=this.chartGuiService.showComponent({Component:Me,props:Object.create(null)})),await this._menu.mounted),this._menu.getInstance().show(e)}_createPrimitive(e){const t=(new fe).createPrimitiveWithPreset(this.chartService,0,e);return this.chartService.getController().attachToolPrimitive(t,!1),t.id}_getColor(e){switch(e){case be.sl:return this._slColor();case be.buy:return this._buyColor();case be.tp:return this._tpColor();case be.sell:return this._sellColor();default:y()}}_buyColor(){return this.configurationService.getValue("chartProperties")["tool.tradeLine.buyColor"]}_sellColor(){return this.configurationService.getValue("chartProperties")["tool.tradeLine.sellColor"]}_tpColor(){return this.configurationService.getValue("chartProperties")["tool.tradeLine.tpColor"]}_slColor(){return this.configurationService.getValue("chartProperties")["tool.tradeLine.slColor"]}};je([U],He.prototype,"_buyColor",1),je([U],He.prototype,"_sellColor",1),je([U],He.prototype,"_tpColor",1),je([U],He.prototype,"_slColor",1),He=je([Ke(0,E),Ke(1,N),Ke(2,M),Ke(3,X),Ke(4,G)],He);export{He as TradeLineContrib};
