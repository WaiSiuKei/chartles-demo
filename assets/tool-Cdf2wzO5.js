var e=Object.defineProperty,t=(t,i,r)=>((t,i,r)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r)(t,"symbol"!=typeof i?i+"":i,r);import{T as i,a as r,D as s}from"./toolPaneView-BkZhzbTB.js";import{N as o}from"./index-iNH1zFVl.js";import{bH as n,L as a,u as l,r as c,s as h,ck as d,e as p,A as f}from"./index-5gyre0hA.js";import{N as u}from"./numericFormatter-DcPXx81O.js";import{P as x}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as _}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as m,T as w}from"./axisPaneView-B6qY_qE1.js";import{B as g,H as b,V as v}from"./text-BhorOBkg.js";import{f as y}from"./text-BFLAaZ9z.js";import{C as R}from"./composite-CCMtJLBO.js";import{L as P}from"./line-BKuOqRrm.js";import{G as D}from"./gannArc-CNv-7ybb.js";import"./baseTool-BM5mqL4_.js";import"./ctx-BQtFq0AI.js";class L{constructor(e,i){t(this,"_precision"),t(this,"_numericFormatter"),this._precision=e??1,this._numericFormatter=new u({precision:this._precision,ignoreLocaleNumberFormat:i})}format(e,t){const i=e.toFixed(this._precision),r=Math.pow(10,-this._precision),s=Math.max(parseFloat(i),r);return this._numericFormatter.format(s,t)}parse(e,t){const i=this._numericFormatter.parse(e,t);return i.res?{res:!0,value:i.value,suggest:this.format(i.value)}:i}}class A extends i{constructor(){super(...arguments),t(this,"_verticalLevelsRenderers",new Map),t(this,"_horizontalLevelsRenderers",new Map),t(this,"_fanRenderers",new Map),t(this,"_arcRenderers",new Map),t(this,"_priceDiffTextRenderer",new g),t(this,"_indexDiffTextRenderer",new g),t(this,"_ratioTextRenderer",new g),t(this,"_renderer",new R(this._hitTestCollector))}getVerticalLevelRenderer(e){let t=this._verticalLevelsRenderers.get(e);return t||(t=new P,this._verticalLevelsRenderers.set(e,t)),t}getHorizontalLevelRenderer(e){let t=this._horizontalLevelsRenderers.get(e);return t||(t=new P,this._horizontalLevelsRenderers.set(e,t)),t}getFanRenderer(e){let t=this._fanRenderers.get(e);return t||(t=new P,this._fanRenderers.set(e,t)),t}getArcRenderer(e){let t=this._arcRenderers.get(e);return t||(t=new D,this._arcRenderers.set(e,t)),t}renderer(){return this._renderer}_updateImpl(){this._renderer.clear();const e=this.points();if(e.length<2)return void this.addAnchors(this._renderer);let[t,i]=e;const r=this._source.properties(),s=r.reverse;s&&([t,i]=[i,t]);const o={barsCoordsRange:i.x-t.x,priceCoordsRange:i.y-t.y,startPoint:t,endPoint:i,p1:t,p2:i,isLabelsVisible:r.showLabels,reversed:s};this._prepareLevels(o),this._prepareFanLines(o),this._prepareArcs(o),this._prepareLabels(o);const n=[t,i];this._model.currentCreating===this._source&&n.pop(),this._renderer.append(this.createLineAnchor({points:n},0))}_prepareLevels(e){const{startPoint:t,endPoint:i,barsCoordsRange:r,priceCoordsRange:s}=e;this._source.properties().levels.forEach(((e,o)=>{if(!e.visible)return;const c=o/5,h=t.x+c*r,d={points:[new l(h,t.y),new l(h,i.y)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal},p=this.getVerticalLevelRenderer(o);p.setData(d),this._renderer.append(p);const f=t.y+c*s,u={points:[new l(t.x,f),new l(i.x,f)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal},x=this.getHorizontalLevelRenderer(o);x.setData(u),this._renderer.append(x)}))}_prepareFanLines(e){const{p1:t,startPoint:i,endPoint:r,barsCoordsRange:s,priceCoordsRange:o}=e;this._source.properties().fanlines.forEach(((e,c)=>{if(!e.visible)return;const h=e.x,d=e.y;let p,f;h>d?(p=r.x,f=i.y+d/h*o):(f=r.y,p=i.x+h/d*s);const u={points:[t,new l(p,f)],lineColor:e.color,lineWidth:e.width,lineStyle:a.solid,extendLeft:!1,extendRight:!1,leftEnd:n.Normal,rightEnd:n.Normal},x=this.getFanRenderer(c);x.setData(u),this._renderer.append(x)}))}_prepareArcs(e){const{p1:t,startPoint:i,endPoint:r,barsCoordsRange:s,priceCoordsRange:o}=e;let n=t;const a=this._source.properties().arcsBackground.fillBackground,c=this._source.properties().arcsBackground.transparency;this._source.properties().arcs.forEach(((e,t)=>{if(!e.visible)return;const h=e.x/5,d=e.y/5,p=i.x+h*s,f=i.y+d*o,u={center:i,point:new l(p,f),edge:r,color:e.color,linewidth:e.width,fillBack:a,transparency:c,prevPoint:n},x=this.getArcRenderer(t);x.setData(u),this._renderer.append(x),n=u.point}))}_prepareLabels(e){const{p1:t,p2:i,isLabelsVisible:r,reversed:s}=e;if(!r)return;let o=this._data.priceDiff,n=this._data.barDiff;if(null==o||null==n)return;s&&(o=-o,n=-n);const a=new l(t.x,i.y),c=y(this._data.priceDiffStr),h=this._getLabelData(a,c);h.horzAlign=n>0?b.Right:b.Left,h.vertAlign=o>0?v.Bottom:v.Top,h.offsetX=10,h.offsetY=o>0?8:10,h.forceTextAlign=!0,this._priceDiffTextRenderer.setData(h),this._renderer.append(this._priceDiffTextRenderer);const d=new l(i.x,t.y),p=y(n.toString()),f=this._getLabelData(d,p);f.horzAlign=n>0?b.Left:b.Right,f.vertAlign=o>0?v.Top:v.Bottom,f.offsetX=10,f.offsetY=o>0?10:8,f.forceTextAlign=!0,this._indexDiffTextRenderer.setData(f),this._renderer.append(this._indexDiffTextRenderer);if(!this._data.scaleRatio)return;const u=y(this._data.scaleRatioStr),x=this._getLabelData(i,u);x.horzAlign=n>0?b.Left:b.Right,x.vertAlign=o>0?v.Bottom:v.Top,x.offsetX=10,x.offsetY=o>0?8:10,x.forceTextAlign=!0,this._ratioTextRenderer.setData(x),this._renderer.append(this._ratioTextRenderer)}_getLabelData(e,t){const i=this._source.properties().labelsStyle,r=this._source.properties().levels;return{points:[e],text:t,fontFamily:c,fontSize:i.fontSize,bold:i.bold,italic:i.italic,color:r[r.length-1].color,backgroundColor:"transparent",horzAlign:b.Center,vertAlign:v.Top,offsetX:0,offsetY:0,backgroundRoundRect:4}}}class F extends r{constructor(){super(...arguments),t(this,"_lines",new A(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new m(Object.create(null))]),t(this,"_timeAxisPaneViews",[new w(Object.create(null))]),t(this,"_timeAxisViews",[new _(Object.create(null)),new _(Object.create(null))]),t(this,"_priceAxisViews",[new x(Object.create(null)),new x(Object.create(null))]),t(this,"_scaleRatioFormatter",new L(7)),t(this,"scaleRatio",null)}pointsCount(){return 2}addPoint(e,t){this.controlPoints.length>1&&this.controlPoints.pop();const i=super.addPoint(e,t);return h(this.series.priceScale().options().mode!==d.Logarithmic),1===t&&this.adjustEndPoint(),i}setPoint(e,t,i){super.setPoint(e,t,i),i.shiftkey?this._correctPoint(e):this._correctScaleRatio()}_correctScaleRatio(){this.scaleRatio=this.getScaleRatio()}getPriceDiff(){const e=this.controlPoints;if(e.length<2)return null;const[t,i]=e;return i.price-t.price}getIndexDiff(){const e=this.controlPoints;if(e.length<2)return null;const[t,i]=e;return p(this.chart.timeScale().timeToIndexEx(i.time))-p(this.chart.timeScale().timeToIndexEx(t.time))}getScaleRatio(){const e=this.getPriceDiff(),t=this.getIndexDiff();return null!==e&&null!==t&&0!==t?Math.abs(e/t):null}adjustEndPoint(){const[e,t]=this.controlPoints,i=p(this.pointToScreenPoint(e)),r=p(this.pointToScreenPoint(t)),s=Math.abs(r.x-i.x);r.y>i.y?r.y=i.y+s:r.y<i.y?r.y=i.y-s:r.y=i.y,t.price=p(this.series.coordinateToPrice(r.y))}isReversed(){return this._props.reverse}_correctFirstPoint(){this._correctPoint(this.isReversed()?0:1)}_correctPoint(e){if(this.controlPoints.length<2)return;const t=this.getIndexDiff();if(null===t)return;const i=this.scaleRatio;if(null===i)return;const r=this.controlPoints[e],s=this.controlPoints[0===e?1:0],o=r.price-s.price>0,n=p(this.chart.timeScale().timeToIndexEx(r.time))-p(this.chart.timeScale().timeToIndexEx(s.time))>0;let a=o&&!n||!o&&n?-1:1;0===e&&(a=-a),r.price=s.price+a*t*i}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let o=0;o<this.controlPoints.length;o++){const t=this.controlPoints[o],i=this.pointToScreenPoint(t);if(!i)return;e.push(new f(i,{pointIndex:o}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));const r=this.getPriceDiff(),s=this.getScaleRatio();this._lines.update({points:e,priceDiff:r,priceDiffStr:r?this.series.priceFormatter().format(r):"",barDiff:this.getIndexDiff(),scaleRatio:s,scaleRatioStr:s?this._scaleRatioFormatter.format(s):""})}}class T extends s{constructor(){super(...arguments),t(this,"type",o)}createPrimitive(){return new F({id:this.id,points:[],fillBackground:!1,arcsBackground:{fillBackground:!0,transparency:80},reverse:!1,showLabels:!0,labelsStyle:{fontSize:12,bold:!1,italic:!1},levels:[{color:"#808080",width:2,visible:!0},{color:"#FF9800",width:2,visible:!0},{color:"#00bcd4",width:2,visible:!0},{color:"#4caf50",width:2,visible:!0},{color:"#089981",width:2,visible:!0},{color:"#808080",width:2,visible:!0}],fanlines:[{color:"#B39DDB",visible:!1,width:2,x:8,y:1},{color:"#F23645",visible:!1,width:2,x:5,y:1},{color:"#808080",visible:!1,width:2,x:4,y:1},{color:"#FF9800",visible:!1,width:2,x:3,y:1},{color:"#00bcd4",visible:!0,width:2,x:2,y:1},{color:"#4caf50",visible:!0,width:2,x:1,y:1},{color:"#089981",visible:!0,width:2,x:1,y:2},{color:"#089981",visible:!1,width:2,x:1,y:3},{color:"#2962FF",visible:!1,width:2,x:1,y:4},{color:"#9575cd",visible:!1,width:2,x:1,y:5},{color:"#B39DDB",visible:!1,width:2,x:1,y:8}],arcs:[{color:"#FF9800",visible:!0,width:2,x:1,y:0},{color:"#FF9800",visible:!0,width:2,x:1,y:1},{color:"#FF9800",visible:!0,width:2,x:1.5,y:0},{color:"#00bcd4",visible:!0,width:2,x:2,y:0},{color:"#00bcd4",visible:!0,width:2,x:2,y:1},{color:"#4caf50",visible:!0,width:2,x:3,y:0},{color:"#4caf50",visible:!0,width:2,x:3,y:1},{color:"#089981",visible:!0,width:2,x:4,y:0},{color:"#089981",visible:!0,width:2,x:4,y:1},{color:"#2962FF",visible:!0,width:2,x:5,y:0},{color:"#2962FF",visible:!0,width:2,x:5,y:1}]},...this.resetArgs)}}export{T as GannSquareTool};
