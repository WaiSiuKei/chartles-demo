var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{B as i,H as s,g as n,V as r}from"./text-BhorOBkg.js";import{y as l,z as o,u as a,r as c,bH as h,A as d,e as p,L as f}from"./index-5gyre0hA.js";import{T as m,a as u,D as x}from"./toolPaneView-BkZhzbTB.js";import{x as w}from"./index-iNH1zFVl.js";import{P as _}from"./priceLabelPriceAxisView-CKrbEFjY.js";import{T as F}from"./timeLabelTimeAxisView-DLVMuesT.js";import{P as g,T as b}from"./axisPaneView-B6qY_qE1.js";import{C as A}from"./composite-CCMtJLBO.js";import{L as v}from"./line-BKuOqRrm.js";import{R as P}from"./rectangle-E0x1RaIQ.js";import{V as y}from"./verticalLine-EvGXqPib.js";import"./text-BFLAaZ9z.js";import"./ctx-BQtFq0AI.js";import"./baseTool-BM5mqL4_.js";class j extends m{constructor(){super(...arguments),t(this,"_trendRenderer",new v),t(this,"_renderer",new A(this._hitTestCollector)),t(this,"_textRenderers",new Map)}renderer(){return this._renderer}getTextRenderer(e){let t=this._textRenderers.get(e);return t||(t=new i,t.setHitTestResult(new l(o.MovePoint)),this._textRenderers.set(e,t)),t}_updateImpl(){this._renderer.clear();const e=this.points();if((null==e?void 0:e.length)<1)return;const t=this._source.properties(),{width:i,height:r}=this._source.getScope().mediaSize;if(t.fillBackground){const e=t.transparency;for(let i=1;i<this._data.levels.length;i++){const s=this._data.levels[i-1],n=this._data.levels[i],l=t.levels[i].color,o={points:[new a(n.x,0),new a(s.x,r)],color:l,lineWidth:0,backColor:l,transparency:e,extendLeft:!1,extendRight:!1},c=new P;c.setData(o),this._renderer.append(c)}}let p=t.horzLabelsAlign;p=p===s.Left?s.Right:p===s.Right?s.Left:s.Center;const f=t.vertLabelsAlign,m=t.showLabels;for(let s=0;s<t.levels.length;s++){const e=t.levels[s];let h;const{x:d}=this._data.levels[s];if(m){let t;switch(f){case"top":t=new a(d,0);break;case"middle":t=new a(d,.5*r);break;default:t=new a(d,r)}const l={points:[t],text:String(e.coeff),color:e.color,vertAlign:f,horzAlign:p,fontFamily:c,offsetX:2,offsetY:0,fontSize:12},o=this.getTextRenderer(s);o.setData(l),this._needLabelExclusionPath()&&(h=n(o,i,r)??void 0),this._renderer.append(o)}const u={x:d,lineColor:e.color,lineWidth:t.levelsStyle.linewidth,lineStyle:t.levelsStyle.linestyle,excludeBoundaries:h},x=new y,w=new l(o.MovePoint);x.setData(u),x.setHitTest(w),this._renderer.append(x)}if(2===e.length){const i=t.trendline,s={points:e,lineColor:i.color,lineWidth:i.linewidth,lineStyle:i.linestyle,extendLeft:!1,extendRight:!1,leftEnd:h.Normal,rightEnd:h.Normal};this._trendRenderer.setData(s),this._renderer.append(this._trendRenderer)}if(2===e.length)this._renderer.append(this.createLineAnchor({points:e},0));else if(e.length>0){const t=this.createLineAnchor({points:[new d(new a(e[0].x,r/2))]},0);this._renderer.append(t)}}_needLabelExclusionPath(){return"center"===this._source.properties().horzLabelsAlign}}class L extends u{constructor(){super(...arguments),t(this,"_lines",new j(this,this.model)),t(this,"_paneView",[this._lines]),t(this,"_priceAxisPaneViews",[new g(Object.create(null))]),t(this,"_timeAxisPaneViews",[new b(Object.create(null))]),t(this,"_timeAxisViews",[new F(Object.create(null)),new F(Object.create(null))]),t(this,"_priceAxisViews",[new _(Object.create(null)),new _(Object.create(null))])}pointsCount(){return 2}updateAllViews(){if(!this.controlPoints.length)return;const e=[];for(let a=0;a<this.controlPoints.length;a++){const t=this.controlPoints[a],i=this.pointToScreenPoint(t);if(!i)return;e.push(new d(i,{pointIndex:a}))}const t=e.map((e=>e.x)),i=e.map((e=>e.y));this.controlPoints.forEach(((t,i)=>{this._timeAxisViews[i].update(this._calculateTimeAxisViewData(t.time,e[i].x)),this._priceAxisViews[i].update(this._calculatePriceAxisViewData(t.price,e[i].y))})),t.length>1&&this._timeAxisPaneViews[0].update(this._calculateTimeAxisPaneViewsData(Math.min.apply(null,t),Math.max.apply(null,t))),i.length>1&&this._priceAxisPaneViews[0].update(this._calculatePriceAxisPaneViewData(Math.min.apply(null,i),Math.max.apply(null,i)));const[s,n]=this.controlPoints,r=p(this.chart.timeScale().timeToIndexEx(s.time)),l=n?p(this.chart.timeScale().timeToIndexEx(n.time))-r:1,o=this._props.levels.reduce(((e,t)=>{const i=Math.round(r+t.coeff*l),s=p(this.chart.timeScale().logicalToCoordinate(i));return e.push({x:s}),e}),[]);this._lines.update({points:e,levels:o})}}class V extends x{constructor(){super(...arguments),t(this,"type",w)}createPrimitive(){return new L({id:this.id,points:[],horzLabelsAlign:s.Right,vertLabelsAlign:r.Bottom,showLabels:!0,fillBackground:!1,transparency:80,trendline:{visible:!0,color:"#808080",linewidth:1,linestyle:f.dashed},levelsStyle:{linewidth:2,linestyle:f.solid},levels:[{coeff:0,color:"#808080FF"},{coeff:1,color:"#2962FFFF"},{coeff:2,color:"#2962FFFF"},{coeff:3,color:"#2962FFFF"},{coeff:5,color:"#2962FFFF"},{coeff:8,color:"#2962FFFF"},{coeff:13,color:"#2962FFFF"},{coeff:21,color:"#2962FFFF"},{coeff:34,color:"#2962FFFF"},{coeff:55,color:"#2962FFFF"},{coeff:89,color:"#2962FFFF"}]},...this.resetArgs)}}export{V as FibTimeZoneTool};
